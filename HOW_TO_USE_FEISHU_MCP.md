# 🎯 飞书 MCP 导入 - 最终使用说明

## ✅ 已完成的配置

我已经帮你完成了所有代码配置：

1. ✅ **后端 MCP 代理服务器** (`server/feishu-mcp-proxy.js`)
   - 集成你的 MCP 配置
   - 支持查询工作项
   - 支持获取视图列表
   - 端口：9999

2. ✅ **前端 UI 集成** (`src/components/FeishuImportModal.tsx`)
   - 视图选择下拉框（自动加载你的视图列表）
   - 查询选项配置
   - 数据预览和导入

3. ✅ **字段映射和数据转换**
   - 飞书数据 → WSJF 需求格式
   - 默认视图："国际销服数字化全集"

## 🚀 如何使用（推荐方式）

由于端口管理复杂，推荐手动分别启动：

### 步骤 1：重启计算机（推荐）

这样可以清理所有僵尸 Node 进程，避免端口冲突。

### 步骤 2：启动后端

打开命令行窗口 1：
```bash
cd d:\code\WSJF\server
npm start
```

等待看到：
```
🚀 飞书 MCP 代理服务器已启动
📡 监听端口: 9999
```

### 步骤 3：启动前端

打开命令行窗口 2：
```bash
cd d:\code\WSJF
npm run dev
```

等待看到：
```
➜  Local:   http://localhost:3000/
```

### 步骤 4：使用飞书导入

1. 打开浏览器访问显示的地址（通常是 http://localhost:3000）
2. 点击"从飞书导入"按钮
3. **选择你的视图**："国际销服数字化全集"（已默认选中）
4. 设置查询数量（建议先用 10 测试）
5. 点击"开始查询"
6. 查看返回的工作项数据
7. 选择需要导入的需求
8. 点击"导入选中的需求"

## 🔍 重要发现

### MCP 数据结构

飞书 MCP 返回数据分两步：
1. **第一步**：视图查询返回工作项 ID 列表
2. **第二步**：根据 ID 获取完整的工作项信息

我已经在后端自动处理这两步，你无需关心。

### 可用的 MCP 工具

```
✅ get_view_list - 获取视图列表
✅ get_view_detail_by_name - 根据视图名称获取工作项
✅ get_work_item_detail - 获取工作项详情
✅ get_work_item_type_meta - 获取字段元数据
```

## 📊 当前配置

**默认视图**："国际销服数字化全集"
**后端端口**：9999
**前端端口**：自动分配（通常 3000 开始）

**视图选择器**：
- 页面打开时自动加载你的所有视图
- 下拉框中可以选择任意视图
- 默认选中"国际销服数字化全集"

## ⚠️ 如果遇到端口冲突

**症状**：后端启动失败，提示 "address already in use :::9999"

**解决方案 A：重启电脑（最简单）**
- 清理所有僵尸进程
- 然后按上面的步骤启动

**解决方案 B：手动清理端口（不推荐，太复杂）**
```bash
# 查找占用进程
netstat -ano | findstr :9999

# 杀掉进程（替换 PID）
taskkill /F /PID <PID>
```

## 🎉 测试验证

访问应用后：

1. **点击"从飞书导入"**
2. **查看视图下拉框** - 应该包含你的所有视图
3. **选择"国际销服数字化全集"**
4. **设置查询数量为 10**
5. **点击"开始查询"**

**期望结果**：
- 后端控制台显示：获取到 X 个工作项 ID
- 后端控制台显示：解析后的工作项数据 X 条
- 前端显示：X 条工作项的预览表格

## 📁 相关文件

**核心文件**：
- `server/feishu-mcp-proxy.js` - MCP 代理服务器（已配置）
- `src/components/FeishuImportModal.tsx` - UI 组件（含视图选择器）
- `src/services/feishuMCPService.ts` - 前端服务层
- `src/hooks/useFeishuImport.ts` - React Hook

**启动脚本**：
- `start-feishu-mcp.bat` - Windows 一键启动脚本（双击运行）

**文档**：
- `SIMPLE_START_GUIDE.md` - 简易启动指南
- `README_FEISHU_MCP.md` - 完整说明

---

**🎊 配置已完成！建议重启电脑后测试，避免端口冲突！**
