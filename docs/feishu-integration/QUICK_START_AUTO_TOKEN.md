# 飞书集成快速开始 - 自动Token模式

## 🎉 好消息！再也不用手动获取token了！

---

## ✅ 我已经完成的改进

### 1. 自动刷新Token功能
- ✅ 系统会自动检测token是否即将过期（提前5分钟）
- ✅ 自动调用API刷新token
- ✅ 用户完全无感知，永不过期

### 2. UI界面优化
- ✅ Token字段改为**可选**（不再强制填写）
- ✅ 明确提示"留空让系统自动获取"
- ✅ 添加自动Token管理说明

### 3. Cookie模式说明
- ✅ 标注"可能不可用"（有CORS跨域限制）
- ✅ 推荐使用自动Token模式

---

## 🚀 现在开始使用（5分钟）

### 步骤1：启动WSJF

```bash
cd D:\code\WSJF
npm run dev
```

### 步骤2：打开浏览器

访问：http://localhost:3000

### 步骤3：配置飞书导入

1. **点击**页面顶部的**"从飞书导入"**按钮（紫色）

2. **选择授权方式**：
   - 点击**"自动Token（推荐）"**（绿色框）

3. **填写基本信息**：
   ```
   Plugin ID: MII_68F1064FA240006C
   Plugin Secret: 050E0E049ACB87339CB9D11E5641564F
   ```

4. **填写平台信息**：
   ```
   Platform Domain: https://project.f.mioffice.cn
   ```

5. **Token字段**：
   - **留空！** ✨（不要填写任何内容）
   - 界面会显示绿色提示："推荐留空！系统会使用Plugin ID和Secret自动获取并刷新token"

6. **填写User Key**：
   ```
   User Key: 7541721806923694188
   ```

   如何获取User Key？
   - 打开 https://project.f.mioffice.cn
   - 按F12打开开发者工具
   - 切换到Network标签
   - 刷新页面
   - 查看任意API请求的Headers
   - 找到 `X-User-Key` 的值

7. **勾选配置**：
   - ✅ 勾选"使用飞书项目插件Header"

8. **保存配置**：
   - 点击**"保存并测试"**按钮
   - 看到提示："配置已保存，系统将自动获取Token" ✅

### 步骤4：开始使用

1. **查看项目列表**
   - 配置保存后会自动进入"选择项目"步骤
   - 点击"刷新列表"
   - 应该能看到你的飞书项目了！

2. **选择项目**
   - 点击要导入的项目

3. **选择任务**
   - 勾选要导入的任务

4. **确认导入**
   - 点击"确认导入"按钮
   - 完成！🎉

---

## 🔍 验证自动刷新功能

### 查看Console日志

打开浏览器Console（按F12），你会看到：

**首次使用（自动获取token）**：
```
[FeishuAuth] Token expired or about to expire, auto-refreshing...
[FeishuAuth] Refreshing project platform plugin token
[FeishuAuth] Project platform token refreshed successfully, expires in 7200 seconds
```

**正常使用（token有效）**：
```
[FeishuAuth] Using cached project platform token
```

**2小时后（自动刷新）**：
```
[FeishuAuth] Token expired or about to expire, auto-refreshing...
[FeishuAuth] Project platform token refreshed successfully, expires in 7200 seconds
```

---

## 🎯 界面预览

配置界面应该是这样的：

```
┌─────────────────────────────────────────────────────┐
│  飞书导入配置                                        │
├─────────────────────────────────────────────────────┤
│                                                     │
│  授权方式：                                          │
│  ┌───────────┐ ┌──────────────┐ ┌──────────┐      │
│  │Cookie     │ │ 自动Token    │ │OAuth     │      │
│  │（可能不   │ │ （推荐）⭐   │ │          │      │
│  │ 可用）    │ │ ⚡自动获取  │ │          │      │
│  └───────────┘ └──────────────┘ └──────────┘      │
│                     ↑ 选这个                         │
│                                                     │
│  Plugin ID: *                                       │
│  ┌─────────────────────────────────────────────┐  │
│  │ MII_68F1064FA240006C                        │  │
│  └─────────────────────────────────────────────┘  │
│                                                     │
│  Plugin Secret: *                                   │
│  ┌─────────────────────────────────────────────┐  │
│  │ ••••••••••••••••••••                         │  │
│  └─────────────────────────────────────────────┘  │
│                                                     │
│  Platform Domain: *                                 │
│  ┌─────────────────────────────────────────────┐  │
│  │ https://project.f.mioffice.cn               │  │
│  └─────────────────────────────────────────────┘  │
│                                                     │
│  Plugin Token（可选，留空自动获取）                 │
│  ┌─────────────────────────────────────────────┐  │
│  │ 留空                                          │  │
│  └─────────────────────────────────────────────┘  │
│  ✨ 推荐留空！系统会使用Plugin ID和Secret          │
│     自动获取并刷新token                             │
│                                                     │
│  User Key: *                                        │
│  ┌─────────────────────────────────────────────┐  │
│  │ 7541721806923694188                         │  │
│  └─────────────────────────────────────────────┘  │
│                                                     │
│  ☑ 使用飞书项目插件Header                           │
│                                                     │
│  ┌─────────────────────────────────────────────┐  │
│  │ 🎉 自动Token管理（推荐）                       │  │
│  │                                              │  │
│  │ Token字段留空，系统会自动使用Plugin ID       │  │
│  │ 和Secret获取token，并在过期前自动刷新。      │  │
│  │                                              │  │
│  │ ✅ 无需手动获取token                         │  │
│  │ ✅ 无需担心过期                              │  │
│  │ ✅ 完全自动化管理                            │  │
│  └─────────────────────────────────────────────┘  │
│                                                     │
│              [保存并测试]    [取消]                │
└─────────────────────────────────────────────────────┘
```

---

## ✅ 成功标志

### 保存配置后：
```
✅ 提示："配置已保存，系统将自动获取Token"
✅ 自动进入"选择项目"步骤
```

### 查看Console后：
```
✅ 看到："Project platform token refreshed successfully"
✅ 看到："expires in 7200 seconds"
```

### 使用功能后：
```
✅ 能看到项目列表
✅ 能选择项目
✅ 能看到任务列表
✅ 能成功导入任务
```

---

## ❌ 常见问题

### Q1: 保存配置后提示"请填写Plugin Token"？

**原因**：代码还没有更新，请确认：
- 你是否重新启动了开发服务器？
- 浏览器是否刷新了页面？

**解决**：
```bash
# 停止开发服务器（Ctrl+C）
# 重新启动
npm run dev
```

### Q2: 配置保存后没有自动获取token？

**检查Console**：
- 按F12打开开发者工具
- 切换到Console标签
- 查看是否有错误信息
- 截图发给我分析

### Q3: 提示"获取插件Token失败"？

**可能原因**：
1. Plugin ID或Secret错误
2. 网络连接问题
3. 飞书服务器问题

**解决方案**：
1. 检查Plugin ID和Secret是否正确
2. 检查平台域名是否正确（https://project.f.mioffice.cn）
3. 确认已勾选"使用飞书项目插件Header"
4. 查看Console详细错误信息

### Q4: 导入时提示"20039错误"（plugin_access_token必须配合User Key）？

**原因**：User Key填写错误或为空

**解决**：
1. 在飞书项目管理平台按F12
2. 查看Network → 任意API请求的Headers
3. 找到正确的X-User-Key值
4. 更新配置

---

## 🎯 技术细节

### 自动刷新流程

```
1. 配置保存 → 首次获取token
   POST /open_api/authen/plugin_token
   {
     plugin_id: "MII_68F1064FA240006C",
     plugin_secret: "050E0E049ACB87339CB9D11E5641564F",
     type: 0
   }
   ↓
   获取token（有效期2小时）

2. 使用过程 → 自动检查过期
   每次API调用前检查：
   - Token还有 > 5分钟 → 直接使用
   - Token还有 < 5分钟 → 自动刷新

3. 自动刷新 → 无感知更新
   自动调用同样的API获取新token
   更新缓存的token和过期时间
   继续使用，用户无感知
```

### Token存储

- **位置**：浏览器localStorage
- **持久化**：关闭浏览器后依然存在
- **加密**：明文存储（仅本地）
- **清理**：清除浏览器缓存会删除

---

## 📊 对比：之前 vs 现在

| 项目 | 之前（手动Token） | 现在（自动Token） |
|------|-----------------|-----------------|
| 初始配置 | 需要运行脚本获取token | 只需填Plugin ID/Secret |
| Token有效期 | 2小时 | 永久（自动刷新） |
| 维护成本 | 每2小时手动获取 | 零维护 |
| 用户体验 | 频繁中断，体验差 | 完全无感知 |
| 操作步骤 | 5步（获取→填写→使用） | 2步（填写→使用） |
| 推荐程度 | ❌ 不实用 | ✅✅✅✅✅ 强烈推荐 |

---

## 🎉 总结

### 关键改进：
1. ✅ **Token字段可以留空**
2. ✅ **系统自动获取token**
3. ✅ **系统自动刷新token**
4. ✅ **用户完全无感知**
5. ✅ **永久不需要手动操作**

### 使用步骤：
1. 填写Plugin ID和Secret
2. **Token字段留空**（关键！）
3. 填写User Key
4. 勾选"使用飞书项目插件Header"
5. 保存并测试
6. 完成！永久使用

---

**配置时间**：5分钟（仅一次）
**维护成本**：零
**推荐程度**：⭐⭐⭐⭐⭐

现在就开始使用吧！🚀
