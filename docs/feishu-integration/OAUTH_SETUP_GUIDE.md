# 飞书OAuth用户授权配置指南

## 🎯 目的

配置飞书应用的OAuth回调地址，实现用户授权模式，无需管理员安装应用即可使用。

---

## ⚡ 快速配置步骤（5分钟）

### 步骤1: 进入飞书开放平台

1. 打开 https://open.feishu.cn
2. 登录您的账号
3. 进入"开发者后台"
4. 点击您的应用"WSJF-Lite"

### 步骤2: 配置OAuth回调地址

1. **在左侧菜单找到"安全设置"或"开发配置"**
   - 可能的名称：
     - "安全设置"
     - "网页"
     - "开发配置"
     - "OAuth设置"

2. **找到"重定向URL"或"Redirect URLs"配置项**

3. **添加回调地址**：
   ```
   本地开发环境：
   http://localhost:3000/feishu-callback

   生产环境（部署后）：
   https://你的域名/feishu-callback
   ```

4. **点击"保存"**

### 步骤3: 确认权限配置

在"权限管理"页面，确保已添加以下权限：

- ✅ **获取用户基本信息** (`contact:user:readonly`)
- ✅ **查看项目信息** (`project:project:readonly`)
- ✅ **查看工作项信息** (`project:work_item:readonly`)

这些权限是用户授权模式必需的。

### 步骤4: 发布新版本

1. 进入"版本管理与发布"
2. 点击"创建版本"
3. 填写版本说明："添加OAuth用户授权支持"
4. 点击"保存"
5. 点击"申请发布"
6. 等待发布成功

---

## 📸 配置位置参考

根据您的截图，在飞书开放平台中：

```
WSJF-Lite (应用)
├── 基本信息
├── 开发
│   ├── 插件功能  ← 您在这里
│   ├── 权限管理  ← 需要配置权限
│   └── （可能有"网页"或"安全设置"）
├── 管理
│   ├── 插件发布
│   └── 安装统计
└── 其他菜单...
```

**关键**: 找到包含"重定向URL"、"Redirect URI"、"回调地址"等字样的配置页面。

可能的位置：
1. **开发 → 网页** （最可能）
2. **开发 → 安全设置**
3. **基本信息 → OAuth配置**
4. **插件功能 → 网页配置**

---

## 🔄 完整授权流程

配置完成后，用户授权流程如下：

```
1. 用户在WSJF点击"从飞书导入"
   ↓
2. 填写Plugin ID和Secret
   ↓
3. 点击"开始授权"按钮
   ↓
4. 跳转到飞书授权页面（用户同意授权）
   ↓
5. 飞书重定向到 http://localhost:3000/feishu-callback?code=xxx
   ↓
6. 回调页面使用code换取access_token
   ↓
7. 保存token到localStorage
   ↓
8. 自动跳转回主页
   ↓
9. 用户可以选择项目并导入任务
```

---

## 🛠️ 本地开发环境配置

### 当前配置（已完成）：

- ✅ OAuth回调URL: `http://localhost:3000/feishu-callback`
- ✅ 代码已实现OAuth流程
- ✅ 回调页面已创建
- ✅ 路由处理已添加

### 您需要做的（在飞书开放平台）：

- [ ] 在应用配置中添加回调URL: `http://localhost:3000/feishu-callback`
- [ ] 确认权限已配置
- [ ] 发布新版本

---

## 🚀 部署到生产环境

部署到Vercel或其他平台后，需要：

1. **在飞书开放平台添加生产环境回调URL**：
   ```
   https://你的域名/feishu-callback
   ```

2. **可以同时配置多个回调URL**：
   ```
   开发环境: http://localhost:3000/feishu-callback
   生产环境: https://你的域名/feishu-callback
   ```

---

## ❓ 找不到回调URL配置？

### 方法1: 查看飞书文档

1. 在飞书开放平台点击右上角"帮助"或"文档"
2. 搜索"重定向URL"或"Redirect URI"
3. 查看官方指引

### 方法2: 检查所有"网页"相关菜单

在应用管理页面，仔细查看：
- 所有包含"网页"、"Web"字样的菜单
- 所有包含"安全"、"Security"字样的菜单
- 所有包含"OAuth"字样的菜单

### 方法3: 咨询飞书技术支持

如果实在找不到，可以：
1. 在飞书开放平台点击右下角"帮助"
2. 咨询在线客服
3. 询问："如何配置OAuth 2.0的重定向URL？"

---

## 📋 配置完成检查清单

完成配置后，请确认：

- [ ] 已在飞书开放平台添加回调URL
- [ ] 回调URL格式正确（`http://localhost:3000/feishu-callback`）
- [ ] 已配置必需的API权限
- [ ] 已发布应用新版本
- [ ] 在WSJF中测试"开始授权"按钮
- [ ] 点击授权后能跳转到飞书授权页面
- [ ] 授权成功后能自动返回WSJF

---

## 🔧 测试步骤

配置完成后，按以下步骤测试：

1. 在WSJF应用中点击"从飞书导入"
2. 填写Plugin ID和Secret
3. 点击"开始授权（跳转到飞书）"
4. 应该跳转到飞书授权页面
5. 在飞书页面点击"同意授权"
6. 应该自动返回WSJF并显示"授权成功"
7. 自动进入"选择项目"步骤
8. 应该能看到您的飞书项目列表

---

## 💡 提示

- OAuth回调地址配置后可能需要1-2分钟生效
- 如果配置后仍无法使用，尝试重新发布应用版本
- 本地开发使用 `http://localhost:3000`，不要使用 `https`
- 确保端口号与实际开发服务器端口一致

---

**配置完成后，您就可以无需管理员权限，直接授权使用飞书导入功能了！** 🎉
