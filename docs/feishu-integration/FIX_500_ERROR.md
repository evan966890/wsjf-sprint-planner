# 修复工作项类型API的500错误

## 🎯 问题分析

### 当前状态
- ✅ Token自动刷新：完美工作
- ✅ 获取项目列表：成功（MIT项目）
- ❌ 获取工作项类型：500 Internal Server Error
- ❌ 获取工作项列表：20003错误（因为缺少正确的type_key）

### 错误链
```
调用 GET /open_api/:project_key/work_item/types
  ↓
❌ 500 Internal Server Error (code: 2200)
  ↓
无法获取正确的work_item_type_key
  ↓
只能硬编码 "story"
  ↓
调用 POST /open_api/:project_key/work_item/filter
  ↓
❌ 400 Bad Request (err_code: 20003, Wrong WorkItemType Param)
```

### 根本原因
**99%可能性**：插件缺少"获取工作项类型"的权限

---

## ⚡ 立即修复（5分钟）

### 步骤1：进入插件后台

1. **打开飞书插件后台**
   - 访问：https://open.f.mioffice.cn（或 https://project.f.mioffice.cn 的插件管理）

2. **进入你的插件**
   - 找到：WSJF-Lite（Plugin ID: MII_68F1064FA240006C）

3. **点击左侧菜单：权限管理**

### 步骤2：添加缺失的权限

在权限列表中，**搜索**并**勾选**以下权限：

#### 必需权限（如果有的话）：

- ✅ **获取工作项类型列表**
- ✅ **查看工作项类型信息**
- ✅ **获取工作项类型基础信息**
- ✅ **读取工作项类型** (read work_item_type)
- ✅ 所有包含 `work_item_type` 关键词的**只读权限**

#### 也可以直接勾选：

- ✅ **工作项** 相关的所有**只读权限**

### 步骤3：保存并发布

1. **点击"保存"**

2. **进入"版本管理与发布"**
   - 点击"创建版本"
   - 版本说明："添加工作项类型权限"
   - 点击"申请发布"

3. **等待审核通过**（企业内部插件通常立即通过）

---

## 🔍 验证权限配置

### 方法1：运行验证脚本（推荐）

权限配置并发布后，运行：

```powershell
.\get-work-item-types.ps1
```

**如果成功**，你会看到：
```
✅ 成功！

工作项类型列表：
---
名称: story
Type Key: 6337b4e95f9672378dda1432  ← 这就是你需要的！
---
名称: bug
Type Key: xxxxx
```

**复制story的Type Key**到WSJF。

**如果还是失败**，说明：
- 权限没配置对
- 或者这个API端点确实不可用

### 方法2：在WSJF中测试

1. 在WSJF中填写：
   ```
   工作项类型Key: 6337b4e95f9672378dda1432
   ```
   （使用你之前测试脚本中的硬编码值）

2. 保存并测试

3. 点击MIT项目

4. 查看Console：
   - 如果成功 → 说明这个key是对的
   - 如果还是20003 → 说明这个key过时了，必须获取新的

---

## 📋 关键理解

### work_item_type_key的本质

```
类型名称（人类可读）  →  类型Key（系统ID）
─────────────────────────────────────
story                →  6337b4e95f9672378dda1432
需求                  →  6337b4e95f9672378dda1432
bug                  →  另一个ID
缺陷                  →  另一个ID
```

**API必须使用右边的ID**，不能使用左边的名称。

### 为什么之前的代码硬编码了这个值？

因为最早测试时，手动查看飞书项目管理平台的Network请求，复制了这个值。

但这个值可能：
- ❌ 已过期
- ❌ 只适用于测试项目
- ❌ MIT项目的key不同

**正确做法**：通过API动态获取。

---

## 🎯 现在请按顺序执行

### 第1步：添加权限（必须）

去插件后台添加"工作项类型"相关权限并发布。

### 第2步：验证权限

运行脚本：
```powershell
.\get-work-item-types.ps1
```

### 第3步：使用获取到的key

把脚本显示的story类型的key填到WSJF。

---

## 💡 备选方案：如果真的无法获取类型列表

如果权限配置后还是500错误，说明飞书可能根本不提供这个API。那就只能：

**在飞书项目管理平台的Network中手动查找**正确的key值。

---

**现在请执行第1步（添加权限）和第2步（运行脚本），把结果告诉我！** 🚀