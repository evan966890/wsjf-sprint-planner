/**
 * WSJF Sprint Planner - WSJFåŠ æƒä¼˜å…ˆçº§æ’æœŸå¯è§†åŒ–å·¥å…·
 *
 * é¡¹ç›®æ¦‚è¿°ï¼š
 * åŸºäº WSJF (Weighted Shortest Job First) æ–¹æ³•çš„è¿­ä»£éœ€æ±‚æ’æœŸå†³ç­–å·¥å…·
 * å¸®åŠ©å›¢é˜Ÿé€šè¿‡ä¸šåŠ¡å½±å“åº¦ã€æ—¶é—´çª—å£ã€å·¥ä½œé‡ç­‰ç»´åº¦è¯„ä¼°éœ€æ±‚ä¼˜å…ˆçº§
 *
 * æŠ€æœ¯æ ˆï¼š
 * - React 18 + TypeScript
 * - Tailwind CSS (æ ·å¼)
 * - Lucide React (å›¾æ ‡)
 * - xlsx (Excelå¯¼å‡º)
 * - jsPDF + html2canvas (PDFå¯¼å‡º)
 *
 * æ ¸å¿ƒåŠŸèƒ½ï¼š
 * 1. WSJFè¯„åˆ†ç®—æ³•ï¼šè‡ªåŠ¨è®¡ç®—éœ€æ±‚æƒé‡åˆ†(1-100)å’Œæ˜Ÿçº§(2-5æ˜Ÿ)
 * 2. æ‹–æ‹½æ’æœŸï¼šæ”¯æŒéœ€æ±‚åœ¨è¿­ä»£æ± é—´æ‹–æ‹½ç§»åŠ¨
 * 3. æ•°æ®æŒä¹…åŒ–ï¼šLocalStorageå­˜å‚¨ç”¨æˆ·æ•°æ®
 * 4. å¤šç»´ç­›é€‰ï¼šæŒ‰ä¸šåŠ¡å½±å“åº¦ã€æ—¶é—´çª—å£ã€æˆªæ­¢æ—¥æœŸç­‰ç­›é€‰
 * 5. æ•°æ®å¯¼å…¥å¯¼å‡ºï¼šæ”¯æŒExcelã€JSONæ ¼å¼å¯¼å…¥å¯¼å‡ºï¼Œæ”¯æŒPDFå¯¼å‡º
 * 6. æ™ºèƒ½æ˜ å°„ï¼šAIè¾…åŠ©å­—æ®µæ˜ å°„(é›†æˆGemini API)
 *
 * @author WSJF Team
 * @version 1.0.0
 */

import React, { useEffect, useState } from 'react';
import { AlertCircle, X, Save, Plus, Sparkles, FileSpreadsheet, ArrowUpDown } from 'lucide-react';
import * as storage from './storage';

// å¯¼å…¥ç±»å‹å®šä¹‰
import type { Requirement, SprintPool, AIModelType } from './types';

// å¯¼å…¥é…ç½®
import { OPENAI_API_KEY, DEEPSEEK_API_KEY } from './config/api';
import { SCORING_STANDARDS } from './config/scoringStandards';
import { COMPLEXITY_STANDARDS } from './config/complexityStandards';
import { OKR_METRICS, PROCESS_METRICS } from './config/metrics';
import {
  BUSINESS_DOMAINS,
  REQUIREMENT_TYPES,
  REGIONS,
  STORE_TYPES,
  TIME_CRITICALITY
} from './config/businessFields';

// å¯¼å…¥å·¥å…·å‡½æ•°
import { calculateScores } from './utils/scoring';

// å¯¼å…¥ Zustand Store
import { useStore } from './store/useStore';

// å¯¼å…¥å¸¸é‡
import { FIELD_NAME_MAP } from './constants/fieldNames';
import { TECH_PROGRESS, NOT_READY_STATUSES } from './constants/techProgress';

// å¯¼å…¥æ•°æ®ç”Ÿæˆå‡½æ•°
import { generateSampleData } from './data/sampleData';

// å¯¼å…¥UIç»„ä»¶
import HandbookModal from './components/HandbookModal';
import LoginModal from './components/LoginModal';
import EditRequirementModal from './components/EditRequirementModal';
import EditSprintModal from './components/EditSprintModal';
import SprintPoolComponent from './components/SprintPoolComponent';
import UnscheduledArea from './components/UnscheduledArea';
import BatchEvaluationModal from './components/BatchEvaluationModal';
import { Header } from './components/Header';
import ToastContainer from './components/ToastContainer';
import ImportPreviewModal from './components/import/ImportPreviewModal';

// å¯¼å…¥Hooks
import { useToast } from './hooks/useToast';
import { useDataExport } from './hooks/useDataExport';
import { useDataImport } from './hooks/useDataImport';
import { useAIMapping } from './hooks/useAIMapping';

export default function WSJFPlanner() {
  // ========== Zustand Store çŠ¶æ€ ==========

  // ç”¨æˆ·ç›¸å…³çŠ¶æ€
  const currentUser = useStore((state) => state.currentUser);
  const showLogin = useStore((state) => state.showLogin);
  const setCurrentUser = useStore((state) => state.setCurrentUser);
  const setShowLogin = useStore((state) => state.setShowLogin);

  // æ ¸å¿ƒæ•°æ®çŠ¶æ€
  const requirements = useStore((state) => state.requirements);
  const sprintPools = useStore((state) => state.sprintPools);
  const unscheduled = useStore((state) => state.unscheduled);
  const setRequirements = useStore((state) => state.setRequirements);
  const setSprintPools = useStore((state) => state.setSprintPools);
  const setUnscheduled = useStore((state) => state.setUnscheduled);

  // æ‹–æ‹½ç›¸å…³çŠ¶æ€
  const dragOverPool = useStore((state) => state.dragOverPool);
  const setDragOverPool = useStore((state) => state.setDragOverPool);

  // ç¼–è¾‘ç›¸å…³çŠ¶æ€
  const editingReq = useStore((state) => state.editingReq);
  const editingSprint = useStore((state) => state.editingSprint);
  const isNewReq = useStore((state) => state.isNewReq);
  const setEditingReq = useStore((state) => state.setEditingReq);
  const setEditingSprint = useStore((state) => state.setEditingSprint);
  const setIsNewReq = useStore((state) => state.setIsNewReq);

  // UIæ§åˆ¶çŠ¶æ€
  const compact = useStore((state) => state.compact);
  const showHandbook = useStore((state) => state.showHandbook);
  const showExportMenu = useStore((state) => state.showExportMenu);
  const showImportModal = useStore((state) => state.showImportModal);
  const importData = useStore((state) => state.importData);
  const importMapping = useStore((state) => state.importMapping);
  const isAIMappingLoading = useStore((state) => state.isAIMappingLoading);
  const clearBeforeImport = useStore((state) => state.clearBeforeImport);
  const selectedAIModel = useStore((state) => state.selectedAIModel);
  const toggleCompact = useStore((state) => state.toggleCompact);
  const setShowHandbook = useStore((state) => state.setShowHandbook);
  const setShowExportMenu = useStore((state) => state.setShowExportMenu);
  const setShowImportModal = useStore((state) => state.setShowImportModal);
  const setImportData = useStore((state) => state.setImportData);
  const setImportMapping = useStore((state) => state.setImportMapping);
  const setIsAIMappingLoading = useStore((state) => state.setIsAIMappingLoading);
  const setClearBeforeImport = useStore((state) => state.setClearBeforeImport);
  const setSelectedAIModel = useStore((state) => state.setSelectedAIModel);

  // ç­›é€‰å’Œæœç´¢çŠ¶æ€
  const searchTerm = useStore((state) => state.searchTerm);
  const filterType = useStore((state) => state.filterType);
  const scoreFilter = useStore((state) => state.scoreFilter);
  const effortFilter = useStore((state) => state.effortFilter);
  const bvFilter = useStore((state) => state.bvFilter);
  const businessDomainFilter = useStore((state) => state.businessDomainFilter);
  const rmsFilter = useStore((state) => state.rmsFilter);
  const setSearchTerm = useStore((state) => state.setSearchTerm);
  const setFilterType = useStore((state) => state.setFilterType);
  const setScoreFilter = useStore((state) => state.setScoreFilter);
  const setEffortFilter = useStore((state) => state.setEffortFilter);
  const setBVFilter = useStore((state) => state.setBVFilter);
  const setBusinessDomainFilter = useStore((state) => state.setBusinessDomainFilter);
  const setRMSFilter = useStore((state) => state.setRMSFilter);

  // å¸ƒå±€ç›¸å…³çŠ¶æ€
  const leftPanelWidth = useStore((state) => state.leftPanelWidth);
  const poolWidths = useStore((state) => state.poolWidths);
  const setLeftPanelWidth = useStore((state) => state.setLeftPanelWidth);
  const setPoolWidth = useStore((state) => state.setPoolWidth);

  // Store Actions
  const addRequirement = useStore((state) => state.addRequirement);
  const updateRequirement = useStore((state) => state.updateRequirement);
  const moveRequirement = useStore((state) => state.moveRequirement);
  const addSprintPool = useStore((state) => state.addSprintPool);
  const updateSprintPool = useStore((state) => state.updateSprintPool);
  const deleteSprintPool = useStore((state) => state.deleteSprintPool);
  const clearAllRequirements = useStore((state) => state.clearAllRequirements);

  // ========== æ‰¹é‡è¯„ä¼°çŠ¶æ€ ==========
  const [showBatchEvalModal, setShowBatchEvalModal] = useState(false);

  // ========== Toast é€šçŸ¥ç³»ç»Ÿ (ä½¿ç”¨Hook) ==========
  const { toasts, showToast, dismissToast, terminationToastIdRef } = useToast();

  // ========== æ•°æ®å¯¼å‡º (ä½¿ç”¨Hook) ==========
  const { handleExportExcel, handleExportPNG, handleExportPDF } = useDataExport(sprintPools, unscheduled);

  // ========== æ•°æ®å¯¼å…¥ (ä½¿ç”¨Hook) ==========
  const dataImport = useDataImport({ showToast });

  // ========== AIæ˜ å°„ (ä½¿ç”¨Hook) ==========
  const aiMapping = useAIMapping({
    showToast,
    setIsAIMappingLoading,
    setImportMapping,
  });

  // å…¨å±€æ»šåŠ¨ç›‘å¬å·²ç§»é™¤ - ç”¨äºè¯Šæ–­é¡µé¢è·³åŠ¨é—®é¢˜

  // ========== æ•°æ®åˆå§‹åŒ–å’ŒæŒä¹…åŒ– ==========

  /**
   * åŠ è½½ç¤ºä¾‹æ•°æ®
   * åŒ…å«é¢„ç½®çš„éœ€æ±‚å’Œè¿­ä»£æ± ï¼Œå¸®åŠ©æ–°ç”¨æˆ·å¿«é€Ÿäº†è§£ç³»ç»Ÿ
   */

  const loadSampleData = () => {
    const sampleReqs = generateSampleData();
    const samplePools: SprintPool[] = [
      { id: 'SPRINT-01', name: 'è¿­ä»£1', startDate: '2025-11', endDate: '2025-11-30', totalDays: 200, bugReserve: 10, refactorReserve: 15, otherReserve: 5, requirements: [] },
      { id: 'SPRINT-02', name: 'è¿­ä»£2', startDate: '2025-12', endDate: '2025-12-31', totalDays: 200, bugReserve: 10, refactorReserve: 15, otherReserve: 5, requirements: [] },
      { id: 'SPRINT-03', name: 'è¿­ä»£3', startDate: '2026-01', endDate: '2026-01-31', totalDays: 200, bugReserve: 10, refactorReserve: 15, otherReserve: 5, requirements: [] },
    ];

    const withScores = calculateScores(sampleReqs);
    setRequirements(withScores);
    setSprintPools(samplePools);

    const sorted = [...withScores].sort((a, b) => (b.displayScore || 0) - (a.displayScore || 0));
    setUnscheduled(sorted);
  };

  // åˆå§‹åŒ–ï¼šæ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€
  useEffect(() => {
    const user = storage.getCurrentUser();

    if (user) {
      // åªè®¾ç½®å½“å‰ç”¨æˆ·ï¼Œæ•°æ®ç”± Zustand persist è‡ªåŠ¨åŠ è½½
      setCurrentUser(user);

      // å¦‚æœ Zustand persist ä¸­æ²¡æœ‰æ•°æ®ï¼ˆé¦–æ¬¡ä½¿ç”¨ï¼‰ï¼ŒåŠ è½½ç¤ºä¾‹æ•°æ®
      const storeState = useStore.getState();
      if (storeState.requirements.length === 0 && storeState.sprintPools.length === 0) {
        loadSampleData();
      }
    } else {
      setShowLogin(true);
    }
  }, []);

  // æ³¨æ„ï¼šè‡ªåŠ¨ä¿å­˜ç°åœ¨ç”± Zustand persist ä¸­é—´ä»¶è‡ªåŠ¨å¤„ç†ï¼Œæ— éœ€æ‰‹åŠ¨ useEffect
  // recalculateScores ä¹Ÿç”± store action æä¾›ï¼Œæ— éœ€æœ¬åœ°å®šä¹‰

  const handleSaveRequirement = (req: Requirement) => {
    if (isNewReq) {
      addRequirement(req);
    } else {
      updateRequirement(req);
    }
  };

  const handleSaveSprint = (sprint: SprintPool) => {
    updateSprintPool(sprint);
  };

  const handleDeleteSprint = (poolId: string) => {
    const pool = sprintPools.find(p => p.id === poolId);
    if (!pool) return;

    if (pool.requirements.length > 0) {
      if (!confirm(`è¿­ä»£æ± "${pool.name}"ä¸­è¿˜æœ‰ ${pool.requirements.length} ä¸ªéœ€æ±‚ï¼Œåˆ é™¤åè¿™äº›éœ€æ±‚å°†è¢«ç§»å›å¾…æ’æœŸåŒºã€‚ç¡®å®šåˆ é™¤å—ï¼Ÿ`)) {
        return;
      }
    } else {
      if (!confirm(`ç¡®å®šè¦åˆ é™¤è¿­ä»£æ± "${pool.name}"å—ï¼Ÿ`)) {
        return;
      }
    }

    deleteSprintPool(poolId);
  };

  const handleAddSprint = () => {
    const newId = `SPRINT-${Date.now()}`;
    const newSprint: SprintPool = {
      id: newId,
      name: `è¿­ä»£${sprintPools.length + 1}`,
      startDate: '2026-01',
      endDate: '2026-01-31',
      totalDays: 200,
      bugReserve: 10,
      refactorReserve: 15,
      otherReserve: 5,
      requirements: []
    };
    addSprintPool(newSprint);
    // æ‰“å¼€ç¼–è¾‘å¼¹çª—è®©ç”¨æˆ·é…ç½®
    setEditingSprint(newSprint);
  };

  const handleLogin = (user: storage.User) => {
    setCurrentUser(user);
    setShowLogin(false);

    // æ•°æ®ç”± Zustand persist è‡ªåŠ¨åŠ è½½ï¼Œæ— éœ€æ‰‹åŠ¨åŠ è½½
    // å¦‚æœ store ä¸­æ²¡æœ‰æ•°æ®ï¼ˆé¦–æ¬¡ç™»å½•ï¼‰ï¼ŒåŠ è½½ç¤ºä¾‹æ•°æ®
    const storeState = useStore.getState();

    if (storeState.requirements.length === 0 && storeState.sprintPools.length === 0) {
      loadSampleData();
    }
  };

  const handleLogout = () => {
    if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿæ•°æ®å·²è‡ªåŠ¨ä¿å­˜ã€‚')) {
      storage.logout();
      const logout = useStore.getState().logout;
      logout();
    }
  };

  /**
   * å¤„ç†æ‰¹é‡è¯„ä¼°åˆ†æ•°åº”ç”¨
   */
  const handleApplyBatchScores = (updates: Map<string, number>) => {
    // æ›´æ–°éœ€æ±‚çš„businessImpactScore
    const updatedRequirements: Requirement[] = requirements.map(req => {
      if (updates.has(req.id)) {
        const score = updates.get(req.id)!;
        return { ...req, businessImpactScore: Math.max(1, Math.min(10, Math.round(score))) as any };
      }
      return req;
    });

    // é‡æ–°è®¡ç®—åˆ†æ•°
    const withScores = calculateScores(updatedRequirements);
    setRequirements(withScores);

    // æ›´æ–°unscheduledåˆ—è¡¨
    const newUnscheduled = withScores.filter(r => !sprintPools.some(p => p.requirements.some(pr => pr.id === r.id)));
    const sorted = newUnscheduled.sort((a, b) => (b.displayScore || 0) - (a.displayScore || 0));
    setUnscheduled(sorted);

    showToast(`æˆåŠŸåº”ç”¨ ${updates.size} ä¸ªéœ€æ±‚çš„AIè¯„åˆ†ï¼`, 'success');
  };

  /**
   * å¤„ç†æ–‡ä»¶å¯¼å…¥
   * æ”¯æŒCSVå’ŒExcelæ ¼å¼
   */
  const handleFileImport = async (e: React.ChangeEvent<HTMLInputElement>) => {
    await dataImport.handleFileImport(e, (data, mapping) => {
      setImportData(data);
      setImportMapping(mapping);
      setShowImportModal(true);
    });
  };

  /**
   * ä½¿ç”¨AIæ˜ å°„å­—æ®µï¼ˆæ”¯æŒOpenAIå’ŒDeepSeekï¼‰
   */
  const handleAIMapping = async () => {
    await aiMapping.handleAIMapping(importData, selectedAIModel);
  };

  /**
   * æ„å»ºå¯¼å…¥AIæ™ºèƒ½å¡«å……çš„Prompt
   *
   * @param rawRow - ExcelåŸå§‹è¡Œæ•°æ®
   * @param config - æ‰€æœ‰é…ç½®æ•°æ®ï¼ˆæšä¸¾é€‰é¡¹ã€è¯„åˆ†æ ‡å‡†ç­‰ï¼‰
   * @returns å®Œæ•´çš„AI promptå­—ç¬¦ä¸²
   */
  const buildImportAIPrompt = (
    rawRow: Record<string, any>,
    config: {
      okrMetrics: typeof OKR_METRICS;
      processMetrics: typeof PROCESS_METRICS;
      scoringStandards: typeof SCORING_STANDARDS;
      complexityStandards: typeof COMPLEXITY_STANDARDS;
      businessDomains: string[];
      requirementTypes: string[];
      regions: string[];
      storeTypes: string[];
      productAreas: string[];
      timeCriticalityOptions: string[];
    }
  ): string => {
    // æ ¼å¼åŒ–åŸå§‹æ•°æ®
    const rawDataStr = JSON.stringify(rawRow, null, 2);

    return `ä½ æ˜¯WSJFéœ€æ±‚ç®¡ç†ç³»ç»Ÿçš„æ•°æ®åˆ†æåŠ©æ‰‹ã€‚è¯·åˆ†æä»¥ä¸‹Excelå¯¼å…¥çš„åŸå§‹æ•°æ®ï¼Œæ™ºèƒ½æ¨å¯¼å¹¶å¡«å……30+ä¸ªå­—æ®µã€‚

# åŸå§‹Excelæ•°æ®
\`\`\`json
${rawDataStr}
\`\`\`

# å­—æ®µå¡«å……è§„åˆ™

## ä¸€ã€åŸºæœ¬ä¿¡æ¯å­—æ®µï¼ˆ9ä¸ªï¼‰

### 1. nameï¼ˆéœ€æ±‚åç§°ï¼‰- è‡ªç”±æ–‡æœ¬
- **è§„åˆ™**ï¼šä¿ç•™Excelä¸­çš„åŸå§‹éœ€æ±‚åç§°
- **ç¤ºä¾‹**ï¼šå¦‚æœExcelæœ‰"éœ€æ±‚åç§°"åˆ—ä¸º"é—¨åº—åº“å­˜é¢„è­¦åŠŸèƒ½"ï¼Œåˆ™å¡«å……ï¼š"é—¨åº—åº“å­˜é¢„è­¦åŠŸèƒ½"

### 2. descriptionï¼ˆéœ€æ±‚æè¿°ï¼‰- è‡ªç”±æ–‡æœ¬
- **è§„åˆ™**ï¼šæå–Excelä¸­çš„æè¿°ä¿¡æ¯ï¼Œå¯èƒ½æ¥è‡ª"éœ€æ±‚æè¿°"ã€"è¯¦ç»†è¯´æ˜"ã€"å¤‡æ³¨"ç­‰åˆ—
- **å¤„ç†**ï¼šå¦‚æœæœ‰å¤šåˆ—åŒ…å«æè¿°ä¿¡æ¯ï¼Œåˆå¹¶ä¸ºä¸€ä¸ªå®Œæ•´æè¿°

### 3. submitterNameï¼ˆæäº¤äººå§“åï¼‰- è‡ªç”±æ–‡æœ¬
- **è§„åˆ™**ï¼šæå–äººåï¼Œå»é™¤@ç¬¦å·å’Œé¢å¤–ä¿¡æ¯
- **ç¤ºä¾‹**ï¼š"@å¼ ä¸‰ äº§å“ç»ç†" â†’ "å¼ ä¸‰"

### 4. submitDateï¼ˆæäº¤æ—¥æœŸï¼‰- æ—¥æœŸæ ¼å¼ YYYY-MM-DD
- **è§„åˆ™**ï¼šå°†Excelæ—¥æœŸè½¬æ¢ä¸ºæ ‡å‡†æ ¼å¼
- **é»˜è®¤**ï¼šå¦‚æœç¼ºå¤±ï¼Œä½¿ç”¨å½“å‰æ—¥æœŸ

### 5. submitterï¼ˆæäº¤æ–¹ï¼‰- æšä¸¾
- **å¯é€‰å€¼**ï¼š${['äº§å“', 'ç ”å‘', 'ä¸šåŠ¡'].join(', ')}
- **æ¨å¯¼è§„åˆ™**ï¼š
  - å¦‚æœæè¿°ä¸­æåˆ°"ä¸šåŠ¡éœ€æ±‚"ã€"é—¨åº—åé¦ˆ"ã€"åŒºåŸŸè¦æ±‚" â†’ "ä¸šåŠ¡"
  - å¦‚æœæåˆ°"æŠ€æœ¯å€º"ã€"é‡æ„"ã€"æ¶æ„" â†’ "ç ”å‘"
  - é»˜è®¤ â†’ "äº§å“"

### 6. businessTeamï¼ˆä¸šåŠ¡å›¢é˜Ÿï¼‰- è‡ªç”±æ–‡æœ¬
- **è§„åˆ™**ï¼šè¯†åˆ«å›¢é˜Ÿåç§°å…³é”®è¯
- **ç¤ºä¾‹**ï¼š"å¼€åº—å›¢é˜Ÿ"ã€"ä¾›åº”é“¾å›¢é˜Ÿ"ã€"è¿è¥å›¢é˜Ÿ"ã€"ç»é”€å•†å›¢é˜Ÿ"

### 7. businessDomainï¼ˆä¸šåŠ¡åŸŸï¼‰- æšä¸¾
- **å¯é€‰å€¼**ï¼š${config.businessDomains.join(', ')}
- **æ¨å¯¼è§„åˆ™**ï¼š
  - æåˆ°"ç›´è¥åº—"ã€"æˆæƒåº—"ã€"ä¸“å–åº—" â†’ "æ–°é›¶å”®"
  - æåˆ°"ç»é”€å•†"ã€"æ¸ é“"ã€"toB" â†’ "æ¸ é“é›¶å”®"
  - æåˆ°"é€šç”¨"ã€"å…¨å±€" â†’ "å›½é™…é›¶å”®é€šç”¨"

### 8. customBusinessDomainï¼ˆè‡ªå®šä¹‰ä¸šåŠ¡åŸŸï¼‰- è‡ªç”±æ–‡æœ¬
- **è§„åˆ™**ï¼šä»…å½“businessDomainä¸º"è‡ªå®šä¹‰"æ—¶å¡«å†™

### 9. typeï¼ˆéœ€æ±‚ç±»å‹ï¼‰- æšä¸¾
- **å¯é€‰å€¼**ï¼š${config.requirementTypes.join(', ')}

---

## äºŒã€ä¸šåŠ¡å½±å“åº¦è¯„åˆ†ï¼ˆ1ä¸ªæ ¸å¿ƒ+2ä¸ªè¾…åŠ©ï¼‰

### 10. businessImpactScoreï¼ˆä¸šåŠ¡å½±å“åº¦è¯„åˆ†ï¼‰- æšä¸¾ 1-10
- **è¯„åˆ†æ ‡å‡†**ï¼š
  - **10åˆ†ï¼ˆè‡´å‘½ç¼ºé™·ï¼‰**ï¼šç³»ç»Ÿå´©æºƒã€ä¸šåŠ¡åœæ‘†ã€åˆè§„é£é™©
  - **9åˆ†ï¼ˆä¸¥é‡é˜»å¡ï¼‰**ï¼šå…³é”®æµç¨‹ä¸¥é‡å—é˜»ï¼Œéœ€å¤§é‡äººå·¥å…œåº•
  - **8åˆ†ï¼ˆæˆ˜ç•¥å¿…éœ€ï¼‰**ï¼šå½±å“å…³é”®KPIï¼ŒCEO/CTOçº§å…³æ³¨
  - **7åˆ†ï¼ˆæ˜¾è‘—å½±å“ï¼‰**ï¼šæ˜ç¡®å½±å“OKRæŒ‡æ ‡ï¼Œè·¨éƒ¨é—¨åä½œ
  - **6åˆ†ï¼ˆé‡è¦æ”¹è¿›ï¼‰**ï¼šæ˜¾è‘—æå‡æ•ˆç‡æˆ–ä½“éªŒ
  - **5åˆ†ï¼ˆæœ‰ä»·å€¼åŠŸèƒ½ï¼‰**ï¼šè§£å†³æ˜ç¡®ç—›ç‚¹
  - **4åˆ†ï¼ˆä¼˜åŒ–æ”¹è¿›ï¼‰**ï¼šæ”¹å–„ç°æœ‰åŠŸèƒ½
  - **3åˆ†ï¼ˆå°æ”¹è¿›ï¼‰**ï¼šå°å¹…ä¼˜åŒ–
  - **2åˆ†ï¼ˆè¾¹ç¼˜æ”¹è¿›ï¼‰**ï¼šå°‘æ•°äººå—ç›Š
  - **1åˆ†ï¼ˆå¾®å°æ”¹è¿›ï¼‰**ï¼šé”¦ä¸Šæ·»èŠ±

- **æ¨å¯¼ç­–ç•¥**ï¼š
  1. çœ‹ä¸šåŠ¡åæœï¼šæåˆ°"æ— æ³•"ã€"å´©æºƒ"ã€"åœæ‘†" â†’ 9-10åˆ†
  2. çœ‹å½±å“èŒƒå›´ï¼šæåˆ°"å…¨çƒ"ã€"æ‰€æœ‰é—¨åº—" â†’ 7-10åˆ†
  3. çœ‹OKRå…³è”ï¼šæåˆ°"GMV"ã€"è¥æ”¶"ã€"NPS" â†’ 6-8åˆ†
  4. çœ‹ç´§æ€¥åº¦ï¼šæåˆ°"ç´§æ€¥"ã€"ç«‹å³" â†’ 6-8åˆ†
  5. é»˜è®¤ï¼š5åˆ†

### 11. affectedMetricsï¼ˆå½±å“çš„æŒ‡æ ‡ï¼‰- å¤æ‚æ•°ç»„
- **ç»“æ„**ï¼š
\`\`\`json
[
  {
    "metricKey": "gmv",
    "metricName": "GMV/è¥æ”¶",
    "displayName": "GMV/è¥æ”¶",
    "estimatedImpact": "+5%",
    "category": "okr",
    "isAISuggested": true
  }
]
\`\`\`

- **æ ¸å¿ƒOKRæŒ‡æ ‡**ï¼š${config.okrMetrics.map(m => `${m.key}:${m.defaultName}`).slice(0, 5).join(', ')}...
- **è¿‡ç¨‹æŒ‡æ ‡**ï¼š${config.processMetrics.map(m => `${m.key}:${m.defaultName}`).slice(0, 5).join(', ')}...

- **æ¨å¯¼è§„åˆ™**ï¼š
  1. åˆ†æéœ€æ±‚æè¿°ï¼Œè¯†åˆ«å…³é”®è¯
  2. "æ”¶å…¥"ã€"GMV"ã€"é”€å”®" â†’ gmvæŒ‡æ ‡
  3. "æ»¡æ„åº¦"ã€"NPS"ã€"ä½“éªŒ" â†’ dealer_satisfaction_nps
  4. "æ•ˆç‡"ã€"æ—¶é—´"ã€"è‡ªåŠ¨åŒ–" â†’ å¯¹åº”è¿‡ç¨‹æŒ‡æ ‡
  5. é¢„ä¼°å½±å“åº¦ï¼š"+X%"ã€"æ˜æ˜¾æå‡"ã€"ä»Xå°æ—¶â†’Xåˆ†é’Ÿ"

### 12. impactScopeï¼ˆå½±å“èŒƒå›´ï¼‰- å¤æ‚å¯¹è±¡
- **ç»“æ„**ï¼š
\`\`\`json
{
  "storeTypes": ["æ–°é›¶å”®-ç›´è¥åº—", "æ–°é›¶å”®-æˆæƒåº—"],
  "regions": ["å—äºš", "ä¸œå—äºš"],
  "storeCountRange": "50-200å®¶",
  "keyRoles": [
    {
      "category": "regional",
      "roleName": "åº—å‘˜",
      "isCustom": false
    }
  ]
}
\`\`\`

- **é—¨åº—ç±»å‹å¯é€‰å€¼**ï¼š${config.storeTypes.join(', ')}
- **åŒºåŸŸå¯é€‰å€¼**ï¼š${config.regions.join(', ')}
- **é—¨åº—æ•°é‡èŒƒå›´**ï¼š<10å®¶, 10-50å®¶, 50-200å®¶, 200-500å®¶, 500-1000å®¶, >1000å®¶, å…¨çƒæ‰€æœ‰é—¨åº—

---

## ä¸‰ã€æ—¶é—´ç»´åº¦ï¼ˆ3ä¸ªï¼‰

### 13. timeCriticalityï¼ˆæ—¶é—´ä¸´ç•Œåº¦ï¼‰- æšä¸¾
- **å¯é€‰å€¼**ï¼š${config.timeCriticalityOptions.join(', ')}
- **æ¨å¯¼è§„åˆ™**ï¼š
  - æåˆ°"ç´§æ€¥"ã€"ç«‹å³"ã€"æœ¬æœˆå¿…é¡»" â†’ "ä¸€æœˆç¡¬çª—å£"
  - æåˆ°"å°½å¿«"ã€"å­£åº¦å†…"ã€"Q1å®Œæˆ" â†’ "ä¸‰æœˆçª—å£"
  - é»˜è®¤ â†’ "éšæ—¶"

### 14. hardDeadlineï¼ˆæ˜¯å¦æœ‰å¼ºåˆ¶æˆªæ­¢æ—¥æœŸï¼‰- å¸ƒå°”å€¼
- **è§„åˆ™**ï¼šå¦‚æœæåˆ°å…·ä½“æ—¥æœŸæˆ–"å¿…é¡»åœ¨Xä¹‹å‰"ã€"deadline" â†’ true

### 15. deadlineDateï¼ˆæˆªæ­¢æ—¥æœŸï¼‰- æ—¥æœŸ YYYY-MM-DD
- **è§„åˆ™**ï¼šæå–Excelä¸­çš„æ—¥æœŸå­—æ®µ

---

## å››ã€æŠ€æœ¯ä¿¡æ¯ï¼ˆ9ä¸ªï¼‰

### 16. effortDaysï¼ˆé¢„ä¼°å·¥ä½œé‡ï¼‰- æ•°å­—
- **è§„åˆ™**ï¼š
  - æå–"Xäººå¤©"ã€"Xå¤©"ã€"Xå·¥æ—¶"
  - å¦‚æœæ˜¯"Xäººå‘¨"ï¼Œæ¢ç®—ï¼š1äººå‘¨=5äººå¤©
  - é»˜è®¤ï¼š5ï¼ˆå¦‚æœå®Œå…¨æ²¡æœ‰ä¿¡æ¯ï¼‰

### 17. complexityScoreï¼ˆæŠ€æœ¯å¤æ‚åº¦ï¼‰- æšä¸¾ 1-10
- **è¯„åˆ†æ ‡å‡†**ï¼š
  - **10åˆ†**ï¼šå…¨æ–°æŠ€æœ¯å¹³å°ï¼ŒæŠ€æœ¯æ ˆé‡å»º
  - **9åˆ†**ï¼šæ ¸å¿ƒæ¶æ„é‡æ„ï¼Œç³»ç»Ÿçº§æ”¹é€ 
  - **8åˆ†**ï¼šç³»ç»Ÿçº§æ”¹é€ ï¼Œå¤šæ¨¡å—è”åŠ¨
  - **5åˆ†**ï¼šä¸­ç­‰åŠŸèƒ½å¼€å‘ï¼Œå•æ¨¡å—æ”¹é€ 
  - **3åˆ†**ï¼šç®€å•åŠŸèƒ½ï¼Œå°‘é‡ä»£ç 
  - **1åˆ†**ï¼šé…ç½®è°ƒæ•´ï¼Œæ–‡æ¡ˆä¿®æ”¹

- **æ¨å¯¼è§„åˆ™**ï¼š
  - å·¥ä½œé‡ >100å¤© â†’ 9-10åˆ†
  - å·¥ä½œé‡ 50-100å¤© â†’ 7-8åˆ†
  - å·¥ä½œé‡ 20-50å¤© â†’ 5-6åˆ†
  - å·¥ä½œé‡ 5-20å¤© â†’ 3-4åˆ†
  - å·¥ä½œé‡ <5å¤© â†’ 1-2åˆ†

### 18. productAreaï¼ˆäº§å“é¢†åŸŸï¼‰- æšä¸¾ â­ ç‰¹æ®Šè§„åˆ™
- **å¯é€‰å€¼**ï¼š${config.productAreas.join(' | ')}

- **è¯†åˆ«è§„åˆ™**ï¼š
  - çœ‹åˆ°"@å¼ æ™®" â†’ "ç®¡åº—/å›ºèµ„/ç‰© @å¼ æ™®"
  - çœ‹åˆ°"@æœç¥" â†’ "toCå–è´§/å¯¼è´­/AI/åŸ¹è®­/è¥é”€ @æœç¥"
  - çœ‹åˆ°"@èƒ¡é¦¨ç„¶" â†’ "ç®¡äºº/SOä¸ŠæŠ¥/è€ƒå‹¤ @èƒ¡é¦¨ç„¶"
  - çœ‹åˆ°"@æå»ºå›½" â†’ "toBè¿›è´§/äº¤æ˜“/è¿”åˆ© @æå»ºå›½"
  - çœ‹å†…å®¹å…³é”®è¯ï¼š
    - "å›ºèµ„"ã€"èµ„äº§"ã€"é—¨åº—ç®¡ç†" â†’ å¼ æ™®
    - "å¯¼è´­"ã€"å–è´§"ã€"AI"ã€"åŸ¹è®­" â†’ æœç¥
    - "è€ƒå‹¤"ã€"ä¸ŠæŠ¥"ã€"SO" â†’ èƒ¡é¦¨ç„¶
    - "è¿›è´§"ã€"ç»é”€å•†"ã€"è¿”åˆ©"ã€"toB" â†’ æå»ºå›½

### 19. productManagerï¼ˆäº§å“ç»ç†ï¼‰- è‡ªç”±æ–‡æœ¬
- **è§„åˆ™**ï¼šæå–äººåï¼Œå¯èƒ½ä¸productAreaä¸­çš„@äººåä¸€è‡´

### 20. developerï¼ˆç ”å‘è´Ÿè´£äººï¼‰- è‡ªç”±æ–‡æœ¬ï¼ˆä¿ç•™å­—æ®µï¼‰
- **è§„åˆ™**ï¼šæå–"ç ”å‘"ã€"å¼€å‘"ç›¸å…³çš„äººå

### 21. backendDeveloperï¼ˆåç«¯ç ”å‘ï¼‰- è‡ªç”±æ–‡æœ¬
- **è§„åˆ™**ï¼šæå–åç«¯å¼€å‘äººå‘˜å§“å

### 22. frontendDeveloperï¼ˆå‰ç«¯ç ”å‘ï¼‰- è‡ªç”±æ–‡æœ¬
- **è§„åˆ™**ï¼šæå–å‰ç«¯å¼€å‘äººå‘˜å§“å

### 23. testerï¼ˆæµ‹è¯•ï¼‰- è‡ªç”±æ–‡æœ¬
- **è§„åˆ™**ï¼šæå–æµ‹è¯•äººå‘˜å§“å

### 24. projectï¼ˆé¡¹ç›®åç§°ï¼‰- è‡ªç”±æ–‡æœ¬
- **è§„åˆ™**ï¼šè¯†åˆ«é¡¹ç›®åç§°ï¼Œå¦‚"RMSé‡æ„"ã€"å¼€åº—ç³»ç»ŸV2"

### 25. productProgressï¼ˆäº§å“è¿›åº¦ï¼‰- è‡ªç”±æ–‡æœ¬
- **é»˜è®¤**ï¼š"å¾…è¯„ä¼°"

### 26. techProgressï¼ˆæŠ€æœ¯è¿›åº¦ï¼‰- è‡ªç”±æ–‡æœ¬
- **é»˜è®¤**ï¼š"å·²è¯„ä¼°å·¥ä½œé‡"ï¼ˆå› ä¸ºAIä¼šæ¨å¯¼effortDaysï¼Œè¡¨ç¤ºå·¥ä½œé‡å·²è¯„ä¼°ï¼‰

### 27. rdNotesï¼ˆäº§ç ”å¤‡æ³¨ï¼‰- è‡ªç”±æ–‡æœ¬
- **è§„åˆ™**ï¼šæå–å¤‡æ³¨ã€è¯´æ˜ã€è¿›å±•ä¿¡æ¯

---

## äº”ã€å…¶ä»–å­—æ®µ

### 28. dependenciesï¼ˆä¾èµ–éœ€æ±‚ï¼‰- å­—ç¬¦ä¸²æ•°ç»„
- **è§„åˆ™**ï¼šæå–"ä¾èµ–XXéœ€æ±‚"ã€"å‰ç½®éœ€æ±‚"ç­‰ä¿¡æ¯
- **æ ¼å¼**ï¼š["éœ€æ±‚ID1", "éœ€æ±‚ID2"]

### 29. isRMSï¼ˆæ˜¯å¦RMSé‡æ„é¡¹ç›®ï¼‰- å¸ƒå°”å€¼
- **è§„åˆ™**ï¼šæåˆ°"RMS"ã€"é‡æ„"ã€"refactor" â†’ true

### 30. documentsï¼ˆéœ€æ±‚æ–‡æ¡£ï¼‰- æ•°ç»„
- **è§„åˆ™**ï¼šå¦‚æœæœ‰é™„ä»¶é“¾æ¥æˆ–æ–‡æ¡£è·¯å¾„ï¼Œæå–
- **é»˜è®¤**ï¼š[]

---

# Few-Shot ç¤ºä¾‹

## ç¤ºä¾‹1ï¼šç´§æ€¥éœ€æ±‚
**è¾“å…¥Excel**ï¼š
\`\`\`json
{
  "éœ€æ±‚åç§°": "é—¨åº—æ”¶é“¶ç³»ç»Ÿå´©æºƒä¿®å¤ @æœç¥ ç´§æ€¥",
  "æè¿°": "å°åº¦åœ°åŒºæ‰€æœ‰ç›´è¥åº—æ”¶é“¶ç³»ç»Ÿæ— æ³•ä½¿ç”¨ï¼Œå½±å“GMVï¼ŒCEOè¦æ±‚ç«‹å³ä¿®å¤",
  "å·¥ä½œé‡": "3äººå¤©"
}
\`\`\`

**è¾“å‡ºJSON**ï¼š
\`\`\`json
{
  "name": "é—¨åº—æ”¶é“¶ç³»ç»Ÿå´©æºƒä¿®å¤",
  "description": "å°åº¦åœ°åŒºæ‰€æœ‰ç›´è¥åº—æ”¶é“¶ç³»ç»Ÿæ— æ³•ä½¿ç”¨ï¼Œå½±å“GMVï¼ŒCEOè¦æ±‚ç«‹å³ä¿®å¤",
  "submitterName": "æœç¥",
  "submitDate": "2025-01-19",
  "submitter": "ä¸šåŠ¡",
  "businessTeam": "",
  "businessDomain": "æ–°é›¶å”®",
  "customBusinessDomain": "",
  "type": "Bugä¿®å¤",
  "businessImpactScore": 10,
  "affectedMetrics": [
    {
      "metricKey": "gmv",
      "metricName": "GMV/è¥æ”¶",
      "displayName": "GMV/è¥æ”¶",
      "estimatedImpact": "ç›´æ¥å—æŸ",
      "category": "okr",
      "isAISuggested": true
    }
  ],
  "impactScope": {
    "storeTypes": ["æ–°é›¶å”®-ç›´è¥åº—"],
    "regions": ["å—äºš"],
    "storeCountRange": "å…¨çƒæ‰€æœ‰é—¨åº—",
    "keyRoles": [
      {"category": "regional", "roleName": "åº—å‘˜", "isCustom": false}
    ]
  },
  "timeCriticality": "ä¸€æœˆç¡¬çª—å£",
  "hardDeadline": true,
  "deadlineDate": "2025-01-20",
  "effortDays": 3,
  "complexityScore": 6,
  "productArea": "toCå–è´§/å¯¼è´­/AI/åŸ¹è®­/è¥é”€ @æœç¥",
  "productManager": "æœç¥",
  "developer": "",
  "backendDeveloper": "",
  "frontendDeveloper": "",
  "tester": "",
  "project": "",
  "productProgress": "å¾…è¯„ä¼°",
  "techProgress": "å·²è¯„ä¼°å·¥ä½œé‡",
  "rdNotes": "",
  "dependencies": [],
  "isRMS": false,
  "documents": [],
  "_aiFilledFields": ["businessImpactScore", "affectedMetrics", "impactScope", "timeCriticality", "hardDeadline", "complexityScore", "productArea", "submitter"],
  "_aiConfidenceScores": {
    "businessImpactScore": 0.95,
    "productArea": 0.99
  }
}
\`\`\`

## ç¤ºä¾‹2ï¼šæˆ˜ç•¥çº§éœ€æ±‚
**è¾“å…¥Excel**ï¼š
\`\`\`json
{
  "é¢†åŸŸ": "toBè¿›è´§ @æå»ºå›½",
  "éœ€æ±‚": "ç»é”€å•†è¿”åˆ©è‡ªåŠ¨åŒ–ç³»ç»Ÿ",
  "è¯¦æƒ…": "è¦†ç›–å…¨çƒç»é”€å•†ï¼Œæ¯æœˆè‡ªåŠ¨è®¡ç®—è¿”åˆ©ï¼Œæå‡ç»é”€å•†æ»¡æ„åº¦NPS +10åˆ†ï¼Œé¢„è®¡50äººå¤©",
  "ä¸šåŠ¡å›¢é˜Ÿ": "ç»é”€å•†å›¢é˜Ÿ"
}
\`\`\`

**è¾“å‡ºJSON**ï¼š
\`\`\`json
{
  "name": "ç»é”€å•†è¿”åˆ©è‡ªåŠ¨åŒ–ç³»ç»Ÿ",
  "description": "è¦†ç›–å…¨çƒç»é”€å•†ï¼Œæ¯æœˆè‡ªåŠ¨è®¡ç®—è¿”åˆ©ï¼Œæå‡ç»é”€å•†æ»¡æ„åº¦NPS +10åˆ†ï¼Œé¢„è®¡50äººå¤©",
  "submitterName": "æå»ºå›½",
  "submitDate": "2025-01-19",
  "submitter": "ä¸šåŠ¡",
  "businessTeam": "ç»é”€å•†å›¢é˜Ÿ",
  "businessDomain": "æ¸ é“é›¶å”®",
  "customBusinessDomain": "",
  "type": "æ–°åŠŸèƒ½",
  "businessImpactScore": 7,
  "affectedMetrics": [
    {
      "metricKey": "dealer_satisfaction_nps",
      "metricName": "ç»é”€å•†æ»¡æ„åº¦/NPS",
      "displayName": "ç»é”€å•†æ»¡æ„åº¦/NPS",
      "estimatedImpact": "+10åˆ†",
      "category": "okr",
      "isAISuggested": true
    }
  ],
  "impactScope": {
    "storeTypes": ["ä¸é—¨åº—æ— å…³"],
    "regions": ["å…¨çƒæ‰€æœ‰å¸‚åœº"],
    "storeCountRange": "å…¨çƒæ‰€æœ‰é—¨åº—",
    "keyRoles": [
      {"category": "hq-channel-retail", "roleName": "ç»é”€å•†/ä»£ç†å•†", "isCustom": false}
    ]
  },
  "timeCriticality": "ä¸‰æœˆçª—å£",
  "hardDeadline": false,
  "deadlineDate": "",
  "effortDays": 50,
  "complexityScore": 7,
  "productArea": "toBè¿›è´§/äº¤æ˜“/è¿”åˆ© @æå»ºå›½",
  "productManager": "æå»ºå›½",
  "developer": "",
  "backendDeveloper": "",
  "frontendDeveloper": "",
  "tester": "",
  "project": "",
  "productProgress": "å¾…è¯„ä¼°",
  "techProgress": "å·²è¯„ä¼°å·¥ä½œé‡",
  "rdNotes": "",
  "dependencies": [],
  "isRMS": false,
  "documents": [],
  "_aiFilledFields": ["businessImpactScore", "affectedMetrics", "impactScope", "timeCriticality", "complexityScore", "productArea", "businessDomain", "submitter"],
  "_aiConfidenceScores": {
    "businessImpactScore": 0.90,
    "productArea": 0.95
  }
}
\`\`\`

---

# è¾“å‡ºè¦æ±‚

1. **å¿…é¡»è¿”å›å®Œæ•´çš„JSONå¯¹è±¡**ï¼ŒåŒ…å«æ‰€æœ‰30ä¸ªå­—æ®µ
2. **æšä¸¾å­—æ®µ**ï¼šå¿…é¡»ä»å¯é€‰å€¼ä¸­ç²¾ç¡®é€‰æ‹©ï¼Œä¸èƒ½è‡ªåˆ›
3. **è‡ªç”±æ–‡æœ¬å­—æ®µ**ï¼šå°½é‡ä¿ç•™ExcelåŸå§‹å€¼
4. **å…ƒæ•°æ®å­—æ®µ**ï¼š
   - \`_aiFilledFields\`: åˆ—å‡ºæ‰€æœ‰ç”±AIæ¨å¯¼çš„å­—æ®µå
   - \`_aiConfidenceScores\`: å…³é”®å­—æ®µçš„ç½®ä¿¡åº¦ï¼ˆ0-1ï¼‰
5. **ç¼ºå¤±å­—æ®µå¤„ç†**ï¼š
   - å­—ç¬¦ä¸²ï¼šå¡« ""
   - æ•°å­—ï¼šå¡«åˆç†é»˜è®¤å€¼
   - æ•°ç»„ï¼šå¡« []
   - å¯¹è±¡ï¼šå¡«ç©ºå¯¹è±¡æˆ–åˆç†é»˜è®¤ç»“æ„
6. **åªè¿”å›JSON**ï¼Œä¸è¦æœ‰å…¶ä»–è§£é‡Šæ–‡å­—

è¯·å¼€å§‹åˆ†æå¹¶è¾“å‡ºJSONï¼š`;
  };

  /**
   * è°ƒç”¨AIåˆ†æå•æ¡éœ€æ±‚
   *
   * @param rawRow - ExcelåŸå§‹è¡Œæ•°æ®
   * @param config - é…ç½®æ•°æ®
   * @param selectedModel - é€‰æ‹©çš„AIæ¨¡å‹
   * @returns AIå¡«å……åçš„éœ€æ±‚å¯¹è±¡
   */
  const analyzeRequirementWithAI = async (
    rawRow: Record<string, any>,
    config: Parameters<typeof buildImportAIPrompt>[1],
    selectedModel: AIModelType
  ): Promise<any> => {
    const { addAIAnalysisLog } = useStore.getState();

    const apiKey = selectedModel === 'openai' ? OPENAI_API_KEY : DEEPSEEK_API_KEY;
    const modelName = selectedModel === 'openai' ? 'OpenAI' : 'DeepSeek';

    if (!apiKey) {
      throw new Error(`${modelName} API Keyæœªé…ç½®`);
    }

    addAIAnalysisLog(`ğŸ“¡ æ­£åœ¨è°ƒç”¨ ${modelName} API...`);

    // æ„å»ºprompt
    const prompt = buildImportAIPrompt(rawRow, config);
    addAIAnalysisLog(`ğŸ“ Promptå·²ç”Ÿæˆï¼Œé•¿åº¦: ${prompt.length} å­—ç¬¦`);

    // æ ¹æ®é€‰æ‹©çš„æ¨¡å‹æ„å»ºAPIè¯·æ±‚
    let apiUrl: string;
    let requestBody: any;

    if (selectedModel === 'openai') {
      apiUrl = 'https://api.openai.com/v1/chat/completions';
      requestBody = {
        model: 'gpt-3.5-turbo',
        messages: [
          {
            role: 'system',
            content: 'ä½ æ˜¯WSJFéœ€æ±‚ç®¡ç†ç³»ç»Ÿçš„æ•°æ®åˆ†æåŠ©æ‰‹ï¼Œæ“…é•¿ä»Excelæ•°æ®ä¸­æ™ºèƒ½æ¨å¯¼éœ€æ±‚å­—æ®µã€‚'
          },
          {
            role: 'user',
            content: prompt
          }
        ],
        temperature: 0.2, // é™ä½temperatureæé«˜å‡†ç¡®æ€§
        max_tokens: 3000  // å¢åŠ tokené™åˆ¶ä»¥æ”¯æŒ30+å­—æ®µ
      };
    } else {
      // DeepSeek
      apiUrl = 'https://api.deepseek.com/v1/chat/completions';
      requestBody = {
        model: 'deepseek-chat',
        messages: [
          {
            role: 'system',
            content: 'ä½ æ˜¯WSJFéœ€æ±‚ç®¡ç†ç³»ç»Ÿçš„æ•°æ®åˆ†æåŠ©æ‰‹ï¼Œæ“…é•¿ä»Excelæ•°æ®ä¸­æ™ºèƒ½æ¨å¯¼éœ€æ±‚å­—æ®µã€‚'
          },
          {
            role: 'user',
            content: prompt
          }
        ],
        temperature: 0.2,
        max_tokens: 3000
      };
    }

    // è°ƒç”¨AI API
    addAIAnalysisLog(`â³ ç­‰å¾… ${modelName} å“åº”...`);
    const startTime = Date.now();

    const response = await fetch(apiUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${apiKey}`
      },
      body: JSON.stringify(requestBody)
    });

    const responseTime = ((Date.now() - startTime) / 1000).toFixed(2);
    addAIAnalysisLog(`âœ… ${modelName} å“åº”æˆåŠŸ (è€—æ—¶ ${responseTime}ç§’)`);

    if (!response.ok) {
      const errorData = await response.json().catch(() => ({}));
      const errorMsg = errorData.error?.message || response.statusText;
      addAIAnalysisLog(`âŒ APIè¯·æ±‚å¤±è´¥: ${errorMsg}`);
      throw new Error(`${modelName} APIè¯·æ±‚å¤±è´¥ (${response.status}): ${errorMsg}`);
    }

    const result = await response.json();

    if (!result.choices || result.choices.length === 0) {
      addAIAnalysisLog(`âŒ APIè¿”å›æ•°æ®æ ¼å¼å¼‚å¸¸`);
      throw new Error('APIè¿”å›æ•°æ®æ ¼å¼å¼‚å¸¸');
    }

    const aiText = result.choices[0]?.message?.content || '';

    if (!aiText) {
      addAIAnalysisLog(`âŒ APIè¿”å›æ•°æ®ä¸ºç©º`);
      throw new Error('APIè¿”å›æ•°æ®ä¸ºç©º');
    }

    addAIAnalysisLog(`ğŸ“¥ æ”¶åˆ°AIå“åº”ï¼Œé•¿åº¦: ${aiText.length} å­—ç¬¦`);

    // ä»AIè¿”å›çš„æ–‡æœ¬ä¸­æå–JSON
    const jsonMatch = aiText.match(/\{[\s\S]*\}/);
    if (!jsonMatch) {
      addAIAnalysisLog(`âŒ æ— æ³•è§£æJSONï¼ŒåŸå§‹å†…å®¹: ${aiText.substring(0, 100)}...`);
      throw new Error(`æ— æ³•è§£æAIè¿”å›çš„JSONã€‚è¿”å›å†…å®¹ï¼š${aiText.substring(0, 200)}...`);
    }

    const aiFilledData = JSON.parse(jsonMatch[0]);

    // è®°å½•æ¨å¯¼çš„å­—æ®µ
    const filledFields = aiFilledData._aiFilledFields || [];
    addAIAnalysisLog(`ğŸ¯ æˆåŠŸæ¨å¯¼ ${filledFields.length} ä¸ªå­—æ®µ`);

    // è®°å½•å…³é”®å­—æ®µçš„æ¨å¯¼ç»“æœ
    if (aiFilledData.businessImpactScore) {
      addAIAnalysisLog(`  â””â”€ ä¸šåŠ¡å½±å“åº¦: ${aiFilledData.businessImpactScore}åˆ†`);
    }
    if (aiFilledData.complexityScore) {
      addAIAnalysisLog(`  â””â”€ æŠ€æœ¯å¤æ‚åº¦: ${aiFilledData.complexityScore}åˆ†`);
    }
    if (aiFilledData.productArea) {
      addAIAnalysisLog(`  â””â”€ äº§å“é¢†åŸŸ: ${aiFilledData.productArea}`);
    }
    if (aiFilledData.affectedMetrics && aiFilledData.affectedMetrics.length > 0) {
      addAIAnalysisLog(`  â””â”€ å½±å“æŒ‡æ ‡: ${aiFilledData.affectedMetrics.map((m: any) => m.displayName).join(', ')}`);
    }

    // ç”Ÿæˆå”¯ä¸€ID
    const uniqueId = `REQ-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
    aiFilledData.id = uniqueId;

    // è®¾ç½®é»˜è®¤é€‰ä¸­çŠ¶æ€
    aiFilledData._isSelected = true;
    aiFilledData._aiAnalysisStatus = 'success';

    return aiFilledData;
  };

  /**
   * æ‰¹é‡AIæ™ºèƒ½å¡«å……
   * éå†æ‰€æœ‰å¯¼å…¥æ•°æ®ï¼Œé€æ¡è°ƒç”¨AIåˆ†æ
   */
  const handleAISmartFill = async () => {
    const {
      setIsAIFillingLoading,
      setAIFillingProgress,
      setAIFillingCurrentIndex,
      setAIFillingCurrentName,
      setAIFilledData,
      setAIFillingCancelled,
      clearAIAnalysisLogs,
      addAIAnalysisLog
    } = useStore.getState();

    // æ£€æŸ¥æ˜¯å¦æœ‰å¯¼å…¥æ•°æ®
    if (!importData || importData.length === 0) {
      setTimeout(() => showToast('è¯·å…ˆå¯¼å…¥Excelæ–‡ä»¶', 'error'), 0);
      return;
    }

    // æ£€æŸ¥API Key
    const apiKey = selectedAIModel === 'openai' ? OPENAI_API_KEY : DEEPSEEK_API_KEY;
    const modelName = selectedAIModel === 'openai' ? 'OpenAI' : 'DeepSeek';

    if (!apiKey) {
      setTimeout(() => showToast(`AIæ™ºèƒ½å¡«å……åŠŸèƒ½æœªé…ç½®ã€‚è¯·è”ç³»ç®¡ç†å‘˜åœ¨ä»£ç ä¸­é…ç½® ${modelName} API Keyã€‚`, 'error'), 0);
      return;
    }

    // å»¶è¿Ÿæ‰€æœ‰ state æ›´æ–°ï¼Œé¿å…ç«‹å³è§¦å‘é‡æ¸²æŸ“å¯¼è‡´è·³è½¬
    await new Promise(resolve => setTimeout(resolve, 0));

    // é‡ç½®å–æ¶ˆæ ‡å¿—å’Œæ—¥å¿—
    setAIFillingCancelled(false);
    clearAIAnalysisLogs();
    addAIAnalysisLog(`ğŸš€ å¼€å§‹AIæ™ºèƒ½å¡«å……ï¼Œå…± ${importData.length} æ¡éœ€æ±‚`);
    addAIAnalysisLog(`âœ¨ ä½¿ç”¨æ¨¡å‹: ${selectedAIModel === 'deepseek' ? 'DeepSeek' : 'OpenAI GPT'}`);
    addAIAnalysisLog(`â±ï¸ é¢„è®¡è€—æ—¶: ${Math.ceil(importData.length * 3 / 60)}åˆ†${importData.length * 3 % 60}ç§’`);
    showToast(`å¼€å§‹AIæ™ºèƒ½å¡«å……ï¼Œä½¿ç”¨ ${modelName} åˆ†æ ${importData.length} æ¡éœ€æ±‚...`, 'info');

    // å‡†å¤‡é…ç½®æ•°æ®
    const productAreas = [
      'ç®¡åº—/å›ºèµ„/ç‰© @å¼ æ™®',
      'toCå–è´§/å¯¼è´­/AI/åŸ¹è®­/è¥é”€ @æœç¥',
      'ç®¡äºº/SOä¸ŠæŠ¥/è€ƒå‹¤ @èƒ¡é¦¨ç„¶',
      'toBè¿›è´§/äº¤æ˜“/è¿”åˆ© @æå»ºå›½'
    ];

    // æ‰å¹³åŒ–regionsæ•°ç»„
    const flatRegions: string[] = [];
    REGIONS.forEach(region => {
      flatRegions.push(region.name);
      if (region.subRegions) {
        flatRegions.push(...region.subRegions);
      }
      if (region.countries) {
        flatRegions.push(...region.countries);
      }
    });

    const config = {
      okrMetrics: OKR_METRICS,
      processMetrics: PROCESS_METRICS,
      scoringStandards: SCORING_STANDARDS,
      complexityStandards: COMPLEXITY_STANDARDS,
      businessDomains: Array.from(BUSINESS_DOMAINS),
      requirementTypes: Array.from(REQUIREMENT_TYPES),
      regions: flatRegions,
      storeTypes: Array.from(STORE_TYPES),
      productAreas,
      timeCriticalityOptions: Array.from(TIME_CRITICALITY)
    };

    // å¼€å§‹åˆ†æ
    setIsAIFillingLoading(true);
    setAIFillingProgress(0);
    const totalCount = importData.length;
    const filledResults: any[] = [];

    try {
      for (let i = 0; i < totalCount; i++) {
        // æ£€æŸ¥æ˜¯å¦è¢«å–æ¶ˆ
        const { aiFillingCancelled, addAIAnalysisLog: log } = useStore.getState();
        if (aiFillingCancelled) {
          log(`â¹ï¸ ç”¨æˆ·æ‰‹åŠ¨ç»ˆæ­¢åˆ†æ`);

          // ç§»é™¤æŒä¹…çš„"æ­£åœ¨ç»ˆæ­¢"æç¤º
          if (terminationToastIdRef.current !== null) {
            dismissToast(terminationToastIdRef.current);
            terminationToastIdRef.current = null;
          }

          // æ˜¾ç¤ºç»ˆæ­¢è¯¦æƒ…ï¼Œä½¿ç”¨æ›´é•¿çš„æ˜¾ç¤ºæ—¶é—´ï¼ˆ6ç§’ï¼‰
          showToast(`âš ï¸ AIåˆ†æå·²ç»ˆæ­¢ï¼å·²å®Œæˆï¼š${i}æ¡ï¼Œæœªå®Œæˆï¼š${totalCount - i}æ¡ã€‚å·²åˆ†æçš„æ•°æ®å·²ä¿å­˜ï¼Œæ‚¨å¯ä»¥æŸ¥çœ‹ç»“æœã€‚`, 'info', { duration: 6000 });
          break;
        }

        const rawRow = importData[i];

        // æå–éœ€æ±‚åç§°ç”¨äºæ˜¾ç¤ºè¿›åº¦
        let requirementName = rawRow['éœ€æ±‚åç§°'] || rawRow['name'] || rawRow['éœ€æ±‚'] || `éœ€æ±‚${i + 1}`;
        if (typeof requirementName !== 'string') {
          requirementName = String(requirementName);
        }

        // æ›´æ–°è¿›åº¦
        setAIFillingCurrentIndex(i);
        setAIFillingCurrentName(requirementName);
        setAIFillingProgress(Math.round(((i) / totalCount) * 100));

        log(`\nâ”â”â”â”â” ç¬¬ ${i + 1}/${totalCount} æ¡ â”â”â”â”â”`);
        log(`ğŸ“‹ éœ€æ±‚åç§°: ${requirementName}`);

        try {
          // è°ƒç”¨AIåˆ†æ
          const filledData = await analyzeRequirementWithAI(rawRow, config, selectedAIModel);
          filledResults.push(filledData);
          log(`âœ… åˆ†æå®Œæˆ`);
        } catch (error) {
          console.error(`åˆ†æéœ€æ±‚ "${requirementName}" å¤±è´¥:`, error);
          log(`âŒ åˆ†æå¤±è´¥: ${error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯'}`);

          // åˆ›å»ºå¤±è´¥è®°å½•ï¼Œä¿ç•™åŸå§‹æ•°æ®
          const failedData: any = {
            id: `REQ-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
            name: requirementName,
            description: JSON.stringify(rawRow),
            submitterName: '',
            submitDate: new Date().toISOString().split('T')[0],
            submitter: 'äº§å“',
            businessTeam: '',
            businessDomain: 'æ–°é›¶å”®',
            type: 'åŠŸèƒ½å¼€å‘',
            effortDays: 5,
            productManager: '',
            developer: '',
            productProgress: 'å¾…è¯„ä¼°',
            techProgress: TECH_PROGRESS.NOT_EVALUATED,
            hardDeadline: false,
            isRMS: false,
            _aiAnalysisStatus: 'failed',
            _aiErrorMessage: error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯',
            _isSelected: false
          };

          filledResults.push(failedData);
        }

        // æ¯æ¡ä¹‹é—´å»¶è¿Ÿ100msï¼Œé¿å…APIé™æµ
        if (i < totalCount - 1) {
          await new Promise(resolve => setTimeout(resolve, 100));
        }
      }

      // åˆ†æå®Œæˆ
      setAIFilledData(filledResults);
      setAIFillingProgress(100);

      const successCount = filledResults.filter(r => r._aiAnalysisStatus === 'success').length;
      const failedCount = filledResults.filter(r => r._aiAnalysisStatus === 'failed').length;

      // ç§»é™¤æŒä¹…çš„"æ­£åœ¨ç»ˆæ­¢"æç¤ºï¼ˆå¦‚æœè¿˜å­˜åœ¨ï¼‰
      if (terminationToastIdRef.current !== null) {
        dismissToast(terminationToastIdRef.current);
        terminationToastIdRef.current = null;
      }

      // æ˜¾ç¤ºå®Œæˆæ€»ç»“ï¼Œä½¿ç”¨æ›´é•¿çš„æ˜¾ç¤ºæ—¶é—´ï¼ˆ6ç§’ï¼‰
      showToast(`AIæ™ºèƒ½å¡«å……å®Œæˆï¼âœ… æˆåŠŸ: ${successCount} æ¡ï¼ŒâŒ å¤±è´¥: ${failedCount} æ¡ã€‚è¯·åœ¨é¢„è§ˆè¡¨æ ¼ä¸­æ£€æŸ¥ç»“æœã€‚`, 'success', { duration: 6000 });
    } catch (error) {
      console.error('AIæ™ºèƒ½å¡«å……è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:', error);
      showToast(`AIæ™ºèƒ½å¡«å……å¤±è´¥ï¼š${error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯'}`, 'error');
    } finally {
      setIsAIFillingLoading(false);
    }
  };

  /**
   * ç¡®è®¤å¯¼å…¥æ•°æ®
   */
  const handleConfirmImport = () => {
    const { aiFilledData: currentAIFilledData, setAIFilledData } = useStore.getState();

    try {
      // å¦‚æœæœ‰AIå¡«å……çš„æ•°æ®ï¼Œä¼˜å…ˆä½¿ç”¨AIå¡«å……çš„ç»“æœ
      if (currentAIFilledData && currentAIFilledData.length > 0) {
        // åªå¯¼å…¥è¢«å‹¾é€‰çš„éœ€æ±‚
        const selectedRequirements = currentAIFilledData.filter(r => r._isSelected);

        if (selectedRequirements.length === 0) {
          showToast('è¯·è‡³å°‘å‹¾é€‰ä¸€æ¡éœ€æ±‚è¿›è¡Œå¯¼å…¥', 'error');
          return;
        }

        // æ¸…ç†AIå…ƒæ•°æ®å­—æ®µï¼ˆä»¥_å¼€å¤´çš„å­—æ®µï¼‰
        const cleanedRequirements: Requirement[] = selectedRequirements.map(req => {
          const cleaned: any = { ...req };
          // åˆ é™¤æ‰€æœ‰_å¼€å¤´çš„å…ƒæ•°æ®å­—æ®µ
          Object.keys(cleaned).forEach(key => {
            if (key.startsWith('_')) {
              delete cleaned[key];
            }
          });
          return cleaned as Requirement;
        });

        // è®¡ç®—WSJFåˆ†æ•°ï¼ˆä¼ å…¥æ•´ä¸ªæ•°ç»„ï¼‰
        const scoredRequirements = calculateScores(cleanedRequirements);

        // æ ¹æ®æ˜¯å¦æ¸…ç©ºæ¨¡å¼å¯¼å…¥
        if (clearBeforeImport) {
          // æ¸…ç©ºæ¨¡å¼ï¼šæ¸…é™¤æ‰€æœ‰ç°æœ‰æ•°æ®
          setRequirements(scoredRequirements);
          setUnscheduled(scoredRequirements);
          // æ¸…ç©ºæ‰€æœ‰è¿­ä»£æ± ä¸­çš„éœ€æ±‚ï¼Œä½†ä¿ç•™è¿­ä»£æ± ç»“æ„
          const clearedPools = sprintPools.map(pool => ({ ...pool, requirements: [] }));
          setSprintPools(clearedPools);

          // é‡ç½®æ‰€æœ‰ç­›é€‰å™¨ï¼Œç¡®ä¿å¯¼å…¥çš„éœ€æ±‚å¯è§
          setSearchTerm('');
          setFilterType('all');
          setScoreFilter('all');
          setEffortFilter('all');
          setBVFilter('all');
          setBusinessDomainFilter('all');
          setRMSFilter(false);

          showToast(`å·²æ¸…ç©ºå¹¶å¯¼å…¥ ${scoredRequirements.length} æ¡éœ€æ±‚ï¼æ‰€æœ‰éœ€æ±‚å·²æŒ‰WSJFè¯„åˆ†æ’åºï¼Œåˆ†æ•°å·²è‡ªåŠ¨è®¡ç®—å®Œæˆã€‚`, 'success');
        } else {
          // è¿½åŠ æ¨¡å¼ï¼šæ·»åŠ åˆ°ç°æœ‰æ•°æ®
          const updatedRequirements = [...requirements, ...scoredRequirements];
          setRequirements(updatedRequirements);

          const updatedUnscheduled = [...unscheduled, ...scoredRequirements];
          setUnscheduled(updatedUnscheduled);

          // é‡ç½®æ‰€æœ‰ç­›é€‰å™¨ï¼Œç¡®ä¿å¯¼å…¥çš„éœ€æ±‚å¯è§ï¼ˆè¿½åŠ æ¨¡å¼ä¹Ÿéœ€è¦é‡ç½®ç­›é€‰å™¨ï¼ï¼‰
          setSearchTerm('');
          setFilterType('all');
          setScoreFilter('all');
          setEffortFilter('all');
          setBVFilter('all');
          setBusinessDomainFilter('all');
          setRMSFilter(false);

          showToast(`æˆåŠŸå¯¼å…¥ ${scoredRequirements.length} æ¡éœ€æ±‚ï¼æ–°å¢éœ€æ±‚å·²æ·»åŠ åˆ°å¾…æ’æœŸåŒºï¼Œåˆ†æ•°å·²è‡ªåŠ¨è®¡ç®—å®Œæˆã€‚`, 'success');
        }

        // æ¸…ç©ºå¯¼å…¥ç›¸å…³çŠ¶æ€
        setShowImportModal(false);
        setImportData([]);
        setAIFilledData([]);
        setClearBeforeImport(false);
        return;
      }

      // åŸæœ‰çš„æ˜ å°„å¯¼å…¥é€»è¾‘
      const newRequirements: Requirement[] = importData.map((row, index) => {
        // ç”Ÿæˆå”¯ä¸€IDï¼ˆä½¿ç”¨æ—¶é—´æˆ³+éšæœºæ•°+ç´¢å¼•ç¡®ä¿å”¯ä¸€æ€§ï¼‰
        const uniqueId = `REQ-${Date.now()}-${Math.random().toString(36).substr(2, 9)}-${index}`;
        const mapped: any = {};

        // æ ¹æ®æ˜ å°„å…³ç³»è½¬æ¢æ•°æ®ï¼ˆä¸åŒ…æ‹¬idå­—æ®µï¼Œé˜²æ­¢è¢«è¦†ç›–ï¼‰
        Object.entries(importMapping).forEach(([systemField, fileField]) => {
          // è·³è¿‡idå­—æ®µï¼Œç¡®ä¿IDä¸ä¼šè¢«Excelæ•°æ®è¦†ç›–
          if (systemField === 'id') return;

          let value = row[fileField];

          // æ•°æ®ç±»å‹è½¬æ¢
          if (systemField === 'effortDays') {
            value = Number(value) || 0;
          } else if (systemField === 'hardDeadline' || systemField === 'isRMS') {
            value = value === true || value === 'true' || value === 'æ˜¯' || value === 'æœ‰' || value === 1;
          }

          mapped[systemField] = value;
        });

        // è®¾ç½®é»˜è®¤å€¼ï¼Œä½¿ç”¨ç”Ÿæˆçš„uniqueId
        // æ™ºèƒ½åˆå¹¶å·¥ä½œé‡ï¼šæ‰«ææ‰€æœ‰å¯èƒ½åŒ…å«å·¥ä½œé‡çš„åˆ—ï¼Œå–æœ€å¤§å€¼
        // è¿™æ ·å³ä½¿æ˜ å°„ä¸å®Œç¾ï¼Œä¹Ÿèƒ½å°½å¯èƒ½è·å–åˆ°å·¥ä½œé‡æ•°æ®
        let effortDays = Number(mapped.effortDays) || 0;

        // æ‰«æåŸå§‹è¡Œæ•°æ®ä¸­æ‰€æœ‰å¯èƒ½çš„å·¥ä½œé‡åˆ—
        const effortKeywords = ['å·¥ä½œé‡', 'äººå¤©', 'å·¥æ—¶', 'workday', 'effort', 'days', 'java', 'é¢„ä¼°'];
        const allColumns = Object.keys(row);

        allColumns.forEach(colName => {
          // æ£€æŸ¥åˆ—åæ˜¯å¦åŒ…å«å·¥ä½œé‡ç›¸å…³å…³é”®è¯
          const lowerColName = colName.toLowerCase();
          const hasKeyword = effortKeywords.some(keyword =>
            lowerColName.includes(keyword.toLowerCase()) || colName.includes(keyword)
          );

          if (hasKeyword) {
            const val = row[colName];
            // ä¸¥æ ¼éªŒè¯ï¼šå€¼å¿…é¡»å­˜åœ¨ã€ä¸æ˜¯ç©ºå­—ç¬¦ä¸²ã€æ˜¯æœ‰æ•ˆæ•°å­—ã€ä¸”å¤§äº0
            if (val !== null && val !== undefined && val !== '') {
              const num = Number(val);
              if (!isNaN(num) && num > 0 && num > effortDays) {
                effortDays = num;
              }
            }
          }
        });

        // æšä¸¾å€¼éªŒè¯ï¼šç¡®ä¿æ‰€æœ‰æšä¸¾å­—æ®µéƒ½æ˜¯æœ‰æ•ˆå€¼
        // å¦‚æœæ˜ å°„çš„å€¼ä¸åœ¨æœ‰æ•ˆæšä¸¾ä¸­ï¼Œä½¿ç”¨æ™ºèƒ½é»˜è®¤å€¼æˆ–æ ‡å‡†é»˜è®¤å€¼

        // éªŒè¯å¹¶æ™ºèƒ½è®¾ç½®æŠ€æœ¯è¿›å±•
        // AIæ˜ å°„æ—¶åªå¤„ç†å¸¸è§çš„3ç§çŠ¶æ€
        const validTechProgress = [
          TECH_PROGRESS.NOT_EVALUATED,
          TECH_PROGRESS.EFFORT_EVALUATED,
          TECH_PROGRESS.DESIGN_COMPLETED
        ];
        let finalTechProgress = validTechProgress.includes(mapped.techProgress)
          ? mapped.techProgress
          : (effortDays > 0 ? TECH_PROGRESS.EFFORT_EVALUATED : TECH_PROGRESS.NOT_EVALUATED);

        // å¦‚æœæ˜ å°„çš„æ˜¯æœ‰æ•ˆçš„"æœªè¯„ä¼°"ä½†æœ‰å·¥ä½œé‡æ•°æ®ï¼Œè‡ªåŠ¨å‡çº§
        if (effortDays > 0 && finalTechProgress === TECH_PROGRESS.NOT_EVALUATED) {
          finalTechProgress = TECH_PROGRESS.EFFORT_EVALUATED;
        }

        // éªŒè¯ä¸šåŠ¡å½±å“åº¦
        const validBV = ['å±€éƒ¨', 'æ˜æ˜¾', 'æ’¬åŠ¨æ ¸å¿ƒ', 'æˆ˜ç•¥å¹³å°'];
        let finalBV = validBV.includes(mapped.bv) ? mapped.bv : 'æ˜æ˜¾';

        // æ™ºèƒ½è½¬æ¢ï¼šå¦‚æœæ˜¯æ•°å­—ï¼Œå°è¯•æ˜ å°„åˆ°ä¸šåŠ¡ä»·å€¼ç­‰çº§
        if (typeof mapped.bv === 'number' || !isNaN(Number(mapped.bv))) {
          const bvNum = Number(mapped.bv);
          if (bvNum >= 9) finalBV = 'æˆ˜ç•¥å¹³å°';
          else if (bvNum >= 7) finalBV = 'æ’¬åŠ¨æ ¸å¿ƒ';
          else if (bvNum >= 5) finalBV = 'æ˜æ˜¾';
          else finalBV = 'å±€éƒ¨';
        }

        // éªŒè¯æ—¶é—´ä¸´ç•Œ
        const validTC = ['éšæ—¶', 'ä¸‰æœˆçª—å£', 'ä¸€æœˆç¡¬çª—å£'];
        const finalTC = validTC.includes(mapped.tc) ? mapped.tc : 'éšæ—¶';

        // éªŒè¯äº§å“è¿›å±•
        const validProductProgress = ['æœªè¯„ä¼°', 'è®¾è®¡ä¸­', 'å¼€å‘ä¸­', 'å·²å®Œæˆ'];
        const finalProductProgress = validProductProgress.includes(mapped.productProgress)
          ? mapped.productProgress
          : 'æœªè¯„ä¼°';

        // éªŒè¯éœ€æ±‚ç±»å‹
        const validType = ['åŠŸèƒ½å¼€å‘', 'æŠ€æœ¯å€º', 'Bugä¿®å¤'];
        const finalType = validType.includes(mapped.type) ? mapped.type : 'åŠŸèƒ½å¼€å‘';

        // éªŒè¯æäº¤æ–¹
        const validSubmitter = ['äº§å“', 'æŠ€æœ¯', 'è¿è¥', 'ä¸šåŠ¡'];
        const finalSubmitter = validSubmitter.includes(mapped.submitter) ? mapped.submitter : 'äº§å“';

        return {
          id: uniqueId,
          name: mapped.name || `å¯¼å…¥éœ€æ±‚-${index + 1}`,
          submitterName: mapped.submitterName || '',
          productManager: mapped.productManager || '',
          developer: mapped.developer || '',
          productProgress: finalProductProgress,
          effortDays: effortDays,
          bv: finalBV,
          tc: finalTC,
          hardDeadline: mapped.hardDeadline || false,
          techProgress: finalTechProgress,
          type: finalType,
          submitDate: mapped.submitDate || new Date().toISOString().split('T')[0],
          submitter: finalSubmitter,
          isRMS: mapped.isRMS || false,
          businessDomain: 'å›½é™…é›¶å”®é€šç”¨', // å¯¼å…¥çš„éœ€æ±‚é»˜è®¤ä¸º"å›½é™…é›¶å”®é€šç”¨"ä¸šåŠ¡åŸŸ
        };
      });

      // æ·»åŠ åˆ°ç³»ç»Ÿï¼ˆæ ¹æ®clearBeforeImportå†³å®šæ˜¯å¦æ¸…ç©ºå·²æœ‰éœ€æ±‚ï¼‰
      // é‡è¦ï¼šå…ˆåˆå¹¶æ‰€æœ‰éœ€æ±‚ï¼Œç„¶åç»Ÿä¸€è®¡ç®—åˆ†æ•°ï¼Œç¡®ä¿åˆ†æ•°å½’ä¸€åŒ–åŸºäºå…¨å±€èŒƒå›´
      const allReqs = clearBeforeImport ? newRequirements : [...requirements, ...newRequirements];
      const updated = calculateScores(allReqs);
      setRequirements(updated);

      // å¦‚æœæ¸…ç©ºæ¨¡å¼ï¼ŒåŒæ—¶æ¸…ç©ºæ‰€æœ‰è¿­ä»£æ± å’Œå¾…æ’æœŸåŒº
      if (clearBeforeImport) {
        const clearedPools = sprintPools.map(pool => ({ ...pool, requirements: [] }));
        setSprintPools(clearedPools);

        // é‡ç½®æ‰€æœ‰ç­›é€‰å™¨ï¼Œç¡®ä¿å¯¼å…¥çš„éœ€æ±‚å¯è§
        setSearchTerm('');
        setFilterType('all');
        setScoreFilter('all');
        setEffortFilter('all');
        setBVFilter('all');
        setBusinessDomainFilter('all');
        setRMSFilter(false);
      }

      // ä»updatedä¸­æå–æ–°å¯¼å…¥çš„éœ€æ±‚ï¼ˆé€šè¿‡IDåŒ¹é…ï¼‰
      // è¿™æ ·ç¡®ä¿ä½¿ç”¨çš„æ˜¯ç»è¿‡ç»Ÿä¸€åˆ†æ•°è®¡ç®—çš„å¯¹è±¡ï¼Œè€Œä¸æ˜¯æ—§çš„å¯¹è±¡å¼•ç”¨
      const newReqIds = new Set(newRequirements.map(r => r.id));
      const newUnscheduledFromUpdated = updated.filter(r => newReqIds.has(r.id));

      const combined = clearBeforeImport
        ? newUnscheduledFromUpdated
        : [...unscheduled, ...newUnscheduledFromUpdated];
      const sorted = combined.sort((a, b) => (b.displayScore || 0) - (a.displayScore || 0));
      setUnscheduled(sorted);

      // è¿½åŠ æ¨¡å¼ï¼šä¹Ÿéœ€è¦é‡ç½®ç­›é€‰å™¨ï¼Œç¡®ä¿å¯¼å…¥çš„éœ€æ±‚å¯è§
      if (!clearBeforeImport) {
        setSearchTerm('');
        setFilterType('all');
        setScoreFilter('all');
        setEffortFilter('all');
        setBVFilter('all');
        setBusinessDomainFilter('all');
        setRMSFilter(false);
      }

      setShowImportModal(false);
      setImportData([]);
      setImportMapping({});
      setClearBeforeImport(false); // é‡ç½®æ¸…ç©ºé€‰é¡¹

      const message = clearBeforeImport
        ? `å·²æ¸…ç©ºåŸæœ‰éœ€æ±‚ï¼ŒæˆåŠŸå¯¼å…¥ ${newRequirements.length} æ¡æ–°éœ€æ±‚ï¼`
        : `æˆåŠŸå¯¼å…¥ ${newRequirements.length} æ¡éœ€æ±‚ï¼`;
      showToast(message, 'success');
    } catch (error) {
      console.error('å¯¼å…¥å¤±è´¥:', error);
      showToast('å¯¼å…¥å¤±è´¥ï¼š' + (error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯'), 'error');
    }
  };

  // Wrap export functions to close menu after export
  const handleExportExcelWithMenu = () => {
    handleExportExcel();
    setShowExportMenu(false);
  };

  const handleExportPNGWithMenu = async () => {
    await handleExportPNG();
    setShowExportMenu(false);
  };

  const handleExportPDFWithMenu = async () => {
    await handleExportPDF();
    setShowExportMenu(false);
  };

  const handleDragEnter = (poolId: string) => {
    setDragOverPool(poolId);
  };

  const handleDragLeave = () => {
    setDragOverPool(null);
  };

  const handleDrop = (targetPoolId: string) => {
    const event = window.event as DragEvent;
    if (!event || !event.dataTransfer) return;

    const reqId = event.dataTransfer.getData('requirementId');
    const sourcePoolId = event.dataTransfer.getData('sourcePoolId');

    if (!reqId) return;

    // ä½¿ç”¨ store action å¤„ç†ç§»åŠ¨é€»è¾‘
    moveRequirement(reqId, sourcePoolId, targetPoolId);
  };

  const totalScheduled = sprintPools.reduce((sum, pool) => sum + pool.requirements.length, 0);
  const hardDeadlineReqs = unscheduled.filter(r => r.hardDeadline);
  const totalResourceUsed = sprintPools.reduce((sum, p) => sum + p.requirements.reduce((s, r) => s + r.effortDays, 0), 0);
  const totalResourceAvailable = sprintPools.reduce((sum, p) => sum + p.totalDays * (1 - (p.bugReserve + p.refactorReserve + p.otherReserve) / 100), 0);
  const notEvaluatedCount = unscheduled.filter(r => !r.techProgress || (NOT_READY_STATUSES as readonly string[]).includes(r.techProgress)).length;

  /**
   * å¤„ç†AIåˆ†æç»ˆæ­¢
   */
  const handleTerminateAI = () => {
    const { setAIFillingCancelled } = useStore.getState();
    setAIFillingCancelled(true);

    // æ˜¾ç¤ºæŒä¹…åŒ–çš„"æ­£åœ¨ç»ˆæ­¢"æç¤ºï¼Œå­˜å‚¨toast IDä»¥ä¾¿åç»­æ‰‹åŠ¨ç§»é™¤
    const toastId = showToast('â¹ï¸ æ­£åœ¨ç»ˆæ­¢AIåˆ†æï¼Œè¯·ç¨å€™...', 'info', { persistent: true });
    terminationToastIdRef.current = toastId;
  };

  return (
    const fileFields = Object.keys(sampleRow);

    // æ»šåŠ¨ä½ç½®ç®¡ç†
    const modalContentRef = React.useRef<HTMLDivElement>(null);
    const aiProgressBoxRef = React.useRef<HTMLDivElement>(null); // AIè¿›åº¦æ¡†ref
    const logContainerRef = React.useRef<HTMLDivElement>(null); // æ—¥å¿—å®¹å™¨ref
    const fieldMappingRef = React.useRef<HTMLDivElement>(null); // å­—æ®µæ˜ å°„é…ç½®ref
    const hasAutoScrolled = React.useRef<boolean>(false); // æ˜¯å¦å·²ç»è‡ªåŠ¨æ»šåŠ¨è¿‡ï¼ˆé˜²æ­¢é‡å¤æ»šåŠ¨ï¼‰
    // isRestoringScroll å·²ç§»åˆ°å…¨å±€stateï¼Œé˜²æ­¢ç»„ä»¶remountæ—¶ä¸¢å¤±

    // ç»ˆæ­¢åˆ†æç¡®è®¤å¯¹è¯æ¡†çŠ¶æ€
    const [showTerminateConfirm, setShowTerminateConfirm] = React.useState(false);

    // æ»šåŠ¨åˆ°AIè¿›åº¦æ¡†
    const scrollToAIProgress = () => {
      if (aiProgressBoxRef.current && modalContentRef.current) {
        const boxTop = aiProgressBoxRef.current.offsetTop;
        const scrollTop = boxTop - 100; // è€ƒè™‘æ ‡é¢˜æ é«˜åº¦
        setImportModalScrollTop(scrollTop); // æ›´æ–°ä¿å­˜çš„ä½ç½®åˆ°å…¨å±€çŠ¶æ€
        modalContentRef.current.scrollTo({
          top: scrollTop,
          behavior: 'smooth'
        });
      }
    };

    // ç›‘å¬æ»šåŠ¨äº‹ä»¶ï¼Œå®æ—¶ä¿å­˜æ»šåŠ¨ä½ç½®åˆ°å…¨å±€çŠ¶æ€
    React.useEffect(() => {
      const elem = modalContentRef.current;
      if (!elem) return;

      const saveScroll = () => {
        const { isRestoringImportModalScroll: restoring, importModalScrollTop: currentPos, setImportModalScrollTop } = useStore.getState();

        // ğŸš« é˜²æ­¢åœ¨æ¢å¤æ»šåŠ¨è¿‡ç¨‹ä¸­ä¿å­˜æ»šåŠ¨ä½ç½®
        if (restoring) {
          // console.log('[Scroll Event] â¸ï¸ è·³è¿‡ä¿å­˜ï¼ˆæ­£åœ¨æ¢å¤æ»šåŠ¨ï¼‰');
          return;
        }

        const newScroll = elem.scrollTop;
        // åªåœ¨å˜åŒ–è¶…è¿‡5pxæ—¶ä¿å­˜ï¼Œå‡å°‘ä¸å¿…è¦çš„stateæ›´æ–°
        if (Math.abs(newScroll - currentPos) > 5) {
          // console.log('[Scroll Event] ä¿å­˜æ–°ä½ç½®:', newScroll);
          setImportModalScrollTop(newScroll);
        }
      };

      elem.addEventListener('scroll', saveScroll, { passive: true });

      return () => {
        elem.removeEventListener('scroll', saveScroll);
      };
    }, []); // âœ… ç©ºä¾èµ–æ•°ç»„ï¼Œé¿å…é‡å¤æ·»åŠ ç›‘å¬å™¨

    // å…³é”®ä¿®å¤ï¼šä½¿ç”¨ useLayoutEffect åœ¨æµè§ˆå™¨ç»˜åˆ¶ä¹‹å‰åŒæ­¥æ¢å¤æ»šåŠ¨ä½ç½®
    // ä½¿ç”¨å…¨å±€çŠ¶æ€ç¡®ä¿æ»šåŠ¨ä½ç½®ä¸ä¼šå› ä¸ºç»„ä»¶é‡æ–°æ¸²æŸ“è€Œä¸¢å¤±
    React.useLayoutEffect(() => {
      const elem = modalContentRef.current;
      if (!elem) return;

      const currentScroll = elem.scrollTop;
      const targetScroll = importModalScrollTop;

      // åªåœ¨çœŸæ­£éœ€è¦æ¢å¤ä¸”ä¸åœ¨æ¢å¤è¿‡ç¨‹ä¸­æ—¶æ‰æ‰§è¡Œ
      if (targetScroll > 0 && currentScroll !== targetScroll && !isRestoringImportModalScroll) {
        // console.log('[useLayoutEffect] ğŸ”„ æ¢å¤æ»šåŠ¨ä½ç½®ä»', currentScroll, 'åˆ°', targetScroll);

        // ğŸ”’ è®¾ç½®å…¨å±€æ ‡å¿—ï¼Œé˜²æ­¢æ»šåŠ¨äº‹ä»¶ç›‘å¬å™¨ä¿å­˜ä¸­é—´çŠ¶æ€
        setIsRestoringImportModalScroll(true);

        // å¼ºåˆ¶æ¢å¤æ»šåŠ¨ä½ç½®
        elem.scrollTop = targetScroll;

        // åŒé‡ä¿æŠ¤ï¼šåœ¨ä¸‹ä¸€å¸§å†æ¬¡æ£€æŸ¥å¹¶æ¢å¤ï¼Œç„¶åè§£é”
        requestAnimationFrame(() => {
          if (elem && elem.scrollTop !== targetScroll) {
            // console.log('[useLayoutEffect RAF] å†æ¬¡æ¢å¤ä»', elem.scrollTop, 'åˆ°', targetScroll);
            elem.scrollTop = targetScroll;
          }

          // ğŸ”“ æ¢å¤å®Œæˆï¼Œå…è®¸æ»šåŠ¨äº‹ä»¶ç›‘å¬å™¨ä¿å­˜æ–°çš„æ»šåŠ¨ä½ç½®
          setTimeout(() => {
            setIsRestoringImportModalScroll(false);
            // console.log('[useLayoutEffect] âœ… æ»šåŠ¨æ¢å¤å®Œæˆï¼Œè§£é™¤é”å®š');
          }, 100);
        });
      }
    }, [importModalScrollTop]); // âœ… åªä¾èµ–importModalScrollTopï¼Œé¿å…å¾ªç¯è§¦å‘

    // æ—¥å¿—æ›´æ–°æ—¶ï¼Œä»…åœ¨æ—¥å¿—å®¹å™¨å†…éƒ¨æ»šåŠ¨åˆ°åº•éƒ¨ï¼Œä¸å½±å“é¡µé¢
    React.useEffect(() => {
      if (logContainerRef.current && aiAnalysisLogs.length > 0) {
        logContainerRef.current.scrollTop = logContainerRef.current.scrollHeight;
      }
    }, [aiAnalysisLogs]);

    // æ–¹å¼äºŒï¼šAIæ™ºèƒ½å¡«å……å¼€å§‹æ—¶ï¼Œè‡ªåŠ¨æ»šåŠ¨åˆ°è¿›åº¦æ¡†ï¼ˆåªæ»šåŠ¨ä¸€æ¬¡ï¼‰
    React.useEffect(() => {
      if (isAIFillingLoading && aiProgressBoxRef.current && !hasAutoScrolled.current) {
        hasAutoScrolled.current = true;
        // å»¶è¿Ÿæ»šåŠ¨ï¼Œç¡®ä¿è¿›åº¦æ¡†å·²æ¸²æŸ“
        setTimeout(() => scrollToAIProgress(), 100);
      }
      // å½“åŠ è½½ç»“æŸæ—¶é‡ç½®æ ‡å¿—
      if (!isAIFillingLoading) {
        hasAutoScrolled.current = false;
      }
    }, [isAIFillingLoading]);

    // ç³»ç»Ÿå­—æ®µé€‰é¡¹
    const systemFieldOptions = [
      { value: '', label: '-- ä¸æ˜ å°„ --' },
      { value: 'name', label: 'éœ€æ±‚åç§° *' },
      { value: 'submitterName', label: 'æäº¤äººå§“å' },
      { value: 'productManager', label: 'äº§å“ç»ç†' },
      { value: 'developer', label: 'å¼€å‘äººå‘˜' },
      { value: 'effortDays', label: 'å·¥ä½œé‡(å¤©æ•°)' },
      { value: 'bv', label: 'ä¸šåŠ¡å½±å“åº¦' },
      { value: 'tc', label: 'æ—¶é—´ä¸´ç•Œ' },
      { value: 'hardDeadline', label: 'å¼ºåˆ¶æˆªæ­¢' },
      { value: 'techProgress', label: 'æŠ€æœ¯è¿›å±•' },
      { value: 'productProgress', label: 'äº§å“è¿›å±•' },
      { value: 'type', label: 'éœ€æ±‚ç±»å‹' },
      { value: 'submitDate', label: 'æäº¤æ—¥æœŸ' },
      { value: 'submitter', label: 'æäº¤æ–¹' },
      { value: 'isRMS', label: 'æ˜¯å¦RMS' },
    ];

    // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰å¿…å¡«å­—æ®µéƒ½å·²æ˜ å°„
    const hasRequiredFields = Object.values(importMapping).length > 0 && importMapping.name;

    return (
      <div
        className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"
        onScroll={(e) => {
          console.log('[Modalå¤–å±‚] æ»šåŠ¨äº‹ä»¶è§¦å‘ï¼scrollTop:', e.currentTarget.scrollTop);
        }}
      >
        <div
          className="bg-white rounded-xl shadow-2xl max-w-5xl w-full max-h-[90vh] overflow-hidden flex flex-col"
          onClick={(e) => {
            console.log('[Modalçª—å£] ç‚¹å‡»äº‹ä»¶, target:', e.target);
          }}
        >
          {/* æ ‡é¢˜æ  */}
          <div className="bg-gradient-to-r from-teal-600 to-teal-700 px-6 py-4 flex items-center justify-between">
            <div className="flex items-center gap-3">
              <FileSpreadsheet className="text-white" size={24} />
              <h2 className="text-xl font-bold text-white">å¯¼å…¥é¢„è§ˆä¸å­—æ®µæ˜ å°„</h2>
            </div>
            <button
              onClick={() => setShowImportModal(false)}
              className="text-white/80 hover:text-white transition"
            >
              <X size={24} />
            </button>
          </div>

          {/* å†…å®¹åŒºåŸŸ */}
          <div
            key="import-modal-content-stable"
            ref={modalContentRef}
            className="flex-1 overflow-y-auto p-6"
            style={{ overscrollBehavior: 'contain' }}
            onScroll={(e) => {
              e.stopPropagation();
            }}
          >
            {/* ç»Ÿè®¡ä¿¡æ¯ + AIæ¨¡å‹é€‰æ‹©ï¼ˆç´§å‡‘å¸ƒå±€ï¼‰ */}
            <div className="bg-gradient-to-r from-blue-50 to-purple-50 border border-blue-200 rounded-lg p-4 mb-4">
              <div className="flex items-center justify-between gap-4">
                <div className="flex items-center gap-3">
                  <div className="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center">
                    <FileSpreadsheet className="text-white" size={20} />
                  </div>
                  <div>
                    <p className="text-sm font-bold text-gray-900">
                      æ£€æµ‹åˆ° {importData.length} æ¡è®°å½•ï¼Œå…± {fileFields.length} ä¸ªå­—æ®µ
                    </p>
                    <p className="text-xs text-gray-600">è¯·é€‰æ‹©AIæ¨¡å‹å’Œå¯¼å…¥æ–¹å¼</p>
                  </div>
                </div>
                <div className="flex items-center gap-2">
                  <Sparkles className="text-purple-600" size={16} />
                  <select
                    value={selectedAIModel}
                    onChange={(e) => setSelectedAIModel(e.target.value as AIModelType)}
                    className="px-3 py-2 border-2 border-purple-300 rounded-lg text-sm font-medium focus:outline-none focus:ring-2 focus:ring-purple-500 bg-white"
                    disabled={isAIMappingLoading || isAIFillingLoading}
                  >
                    <option value="deepseek">ğŸ‡¨ğŸ‡³ DeepSeek</option>
                    <option value="openai">ğŸŒ OpenAI</option>
                  </select>
                </div>
              </div>
            </div>

            {/* ä¸¤ç§AIåŠŸèƒ½å¯¹æ¯”å¡ç‰‡ */}
            <div className="mb-6 grid grid-cols-2 gap-4">
              {/* æ–¹å¼ä¸€ï¼šAIæ™ºèƒ½æ˜ å°„ï¼ˆå¿«é€Ÿï¼‰ */}
              <div className="border-2 border-purple-200 rounded-xl p-5 bg-gradient-to-br from-purple-50 to-white hover:shadow-lg transition-shadow relative overflow-hidden">
                {/* æ¨èæ ‡ç­¾ - å½“æœ‰å­—æ®µæ˜ å°„æ—¶æ¨èæ–¹å¼ä¸€ */}
                {Object.values(importMapping).some(v => v !== '') && (
                  <div className="absolute top-0 right-0 bg-gradient-to-r from-orange-400 to-red-500 text-white text-xs font-bold px-3 py-1 rounded-bl-lg shadow-md">
                    ğŸ”¥ æ¨è
                  </div>
                )}
                <div className="flex items-start gap-3 mb-4">
                  <div className="w-12 h-12 bg-purple-500 rounded-lg flex items-center justify-center flex-shrink-0">
                    <ArrowUpDown className="text-white" size={24} />
                  </div>
                  <div className="flex-1">
                    <h3 className="font-bold text-lg text-gray-900 mb-1">æ–¹å¼ä¸€ï¼šAIæ™ºèƒ½æ˜ å°„</h3>
                    <div className="inline-flex items-center gap-1 px-2 py-0.5 bg-green-100 text-green-700 rounded text-xs font-medium">
                      âš¡ å¿«é€Ÿ | ğŸ’° çœé’±
                    </div>
                  </div>
                </div>

                <div className="space-y-3 mb-4">
                  <div>
                    <p className="text-sm font-semibold text-gray-700 mb-1">ğŸ“Œ åŠŸèƒ½è¯´æ˜ï¼š</p>
                    <p className="text-sm text-gray-600 leading-relaxed">
                      åªåˆ†æExcel<span className="font-semibold text-purple-600">åˆ—å</span>ï¼Œè‡ªåŠ¨åŒ¹é…åˆ°ç³»ç»Ÿå­—æ®µ
                    </p>
                  </div>

                  <div>
                    <p className="text-sm font-semibold text-gray-700 mb-1">âœ… é€‚ç”¨åœºæ™¯ï¼š</p>
                    <ul className="text-sm text-gray-600 space-y-1 ml-4">
                      <li className="flex items-start gap-1">
                        <span className="text-purple-500 mt-0.5">â€¢</span>
                        <span>Excelåˆ—å<span className="font-semibold">è§„èŒƒæ¸…æ™°</span></span>
                      </li>
                      <li className="flex items-start gap-1">
                        <span className="text-purple-500 mt-0.5">â€¢</span>
                        <span>åªéœ€è¦æ˜ å°„<span className="font-semibold">åŸºç¡€å­—æ®µ</span>ï¼ˆåç§°ã€äººå‘˜ã€æ—¥æœŸç­‰ï¼‰</span>
                      </li>
                      <li className="flex items-start gap-1">
                        <span className="text-purple-500 mt-0.5">â€¢</span>
                        <span>æ•°æ®é‡å¤§ï¼Œå¸Œæœ›<span className="font-semibold">å¿«é€Ÿå¯¼å…¥</span></span>
                      </li>
                    </ul>
                  </div>

                  <div className="bg-purple-100 rounded-lg p-3">
                    <p className="text-xs font-semibold text-purple-800 mb-1">ğŸ“Š ä¸¾ä¾‹ï¼š</p>
                    <div className="text-xs text-purple-700 space-y-1">
                      <div className="flex items-center gap-2">
                        <span className="font-mono bg-white px-2 py-0.5 rounded">Excelåˆ—ï¼š"éœ€æ±‚åç§°"</span>
                        <span>â†’</span>
                        <span className="font-mono bg-purple-200 px-2 py-0.5 rounded">ç³»ç»Ÿå­—æ®µï¼šname</span>
                      </div>
                      <div className="flex items-center gap-2">
                        <span className="font-mono bg-white px-2 py-0.5 rounded">Excelåˆ—ï¼š"å·¥ä½œé‡"</span>
                        <span>â†’</span>
                        <span className="font-mono bg-purple-200 px-2 py-0.5 rounded">ç³»ç»Ÿå­—æ®µï¼šeffortDays</span>
                      </div>
                    </div>
                  </div>

                  <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-2">
                    <p className="text-xs text-yellow-800">
                      âš ï¸ <span className="font-semibold">ä¸æ”¯æŒ</span>æ™ºèƒ½æ¨å¯¼å¤æ‚å­—æ®µï¼ˆå¦‚ä¸šåŠ¡å½±å“åº¦è¯„åˆ†ã€å½±å“çš„æŒ‡æ ‡ç­‰ï¼‰
                    </p>
                  </div>
                </div>

                <button
                  type="button"
                  onClick={(e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    // ç«‹å³ä¿å­˜å½“å‰æ»šåŠ¨ä½ç½®åˆ°å…¨å±€çŠ¶æ€ï¼ˆåŒæ­¥ï¼‰
                    if (modalContentRef.current) {
                      const scroll = modalContentRef.current.scrollTop;
                      console.log('[æ–¹å¼ä¸€ç‚¹å‡»] ä¿å­˜æ»šåŠ¨ä½ç½®:', scroll);
                      setImportModalScrollTop(scroll);
                    }
                    handleAIMapping();
                  }}
                  disabled={isAIMappingLoading || isAIFillingLoading}
                  className="w-full px-4 py-3 bg-purple-600 hover:bg-purple-700 disabled:bg-gray-400 text-white rounded-lg transition flex items-center justify-center gap-2 font-medium shadow-md"
                >
                  {isAIMappingLoading ? (
                    <>
                      <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                      <span>æ˜ å°„ä¸­...</span>
                    </>
                  ) : (
                    <>
                      <ArrowUpDown size={18} />
                      <span>å¼€å§‹æ™ºèƒ½æ˜ å°„ï¼ˆ1ç§’å®Œæˆï¼‰</span>
                    </>
                  )}
                </button>
              </div>

              {/* æ–¹å¼äºŒï¼šAIæ™ºèƒ½å¡«å……ï¼ˆæ·±åº¦ï¼‰ */}
              <div className="border-2 border-blue-300 rounded-xl p-5 bg-gradient-to-br from-blue-50 to-white hover:shadow-xl transition-shadow relative overflow-hidden">
                {/* æ¨èæ ‡ç­¾ - å½“æ²¡æœ‰å­—æ®µæ˜ å°„æ—¶æ¨èæ–¹å¼äºŒ */}
                {!Object.values(importMapping).some(v => v !== '') && (
                  <div className="absolute top-0 right-0 bg-gradient-to-r from-orange-400 to-red-500 text-white text-xs font-bold px-3 py-1 rounded-bl-lg shadow-md">
                    ğŸ”¥ æ¨è
                  </div>
                )}

                <div className="flex items-start gap-3 mb-4">
                  <div className="w-12 h-12 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center flex-shrink-0 shadow-md">
                    <Sparkles className="text-white animate-pulse" size={24} />
                  </div>
                  <div className="flex-1">
                    <h3 className="font-bold text-lg text-gray-900 mb-1">æ–¹å¼äºŒï¼šAIæ™ºèƒ½å¡«å……</h3>
                    <div className="inline-flex items-center gap-1 px-2 py-0.5 bg-blue-100 text-blue-700 rounded text-xs font-medium">
                      ğŸ§  æ™ºèƒ½ | ğŸ¯ ç²¾å‡†
                    </div>
                  </div>
                </div>

                <div className="space-y-3 mb-4">
                  <div>
                    <p className="text-sm font-semibold text-gray-700 mb-1">ğŸ“Œ åŠŸèƒ½è¯´æ˜ï¼š</p>
                    <p className="text-sm text-gray-600 leading-relaxed">
                      æ·±åº¦åˆ†æ<span className="font-semibold text-blue-600">æ¯æ¡éœ€æ±‚å†…å®¹</span>ï¼Œæ™ºèƒ½æ¨å¯¼<span className="font-semibold text-blue-600">30+å¤æ‚å­—æ®µ</span>
                    </p>
                  </div>

                  <div>
                    <p className="text-sm font-semibold text-gray-700 mb-1">âœ… é€‚ç”¨åœºæ™¯ï¼š</p>
                    <ul className="text-sm text-gray-600 space-y-1 ml-4">
                      <li className="flex items-start gap-1">
                        <span className="text-blue-500 mt-0.5">â€¢</span>
                        <span>Excelæ•°æ®<span className="font-semibold">æ··ä¹±ä¸è§„èŒƒ</span>ï¼ˆå¦‚å•åˆ—åŒ…å«å¤šä¿¡æ¯ï¼‰</span>
                      </li>
                      <li className="flex items-start gap-1">
                        <span className="text-blue-500 mt-0.5">â€¢</span>
                        <span>éœ€è¦AI<span className="font-semibold">æ™ºèƒ½è¯„åˆ†</span>ï¼ˆä¸šåŠ¡å½±å“åº¦ã€æŠ€æœ¯å¤æ‚åº¦ï¼‰</span>
                      </li>
                      <li className="flex items-start gap-1">
                        <span className="text-blue-500 mt-0.5">â€¢</span>
                        <span>éœ€è¦æ¨å¯¼<span className="font-semibold">å½±å“çš„æŒ‡æ ‡ã€åŒºåŸŸã€é—¨åº—ç±»å‹</span>ç­‰</span>
                      </li>
                    </ul>
                  </div>

                  <div className="bg-blue-100 rounded-lg p-3">
                    <p className="text-xs font-semibold text-blue-800 mb-1">ğŸ“Š ä¸¾ä¾‹ï¼š</p>
                    <div className="text-xs text-blue-700 space-y-1.5">
                      <div className="bg-white rounded p-2">
                        <p className="font-mono mb-1">Excelå†…å®¹ï¼š"é—¨åº—æ”¶é“¶ç³»ç»Ÿå´©æºƒ @æœç¥ ç´§æ€¥ å°åº¦ç›´è¥åº—"</p>
                        <p className="text-blue-600">â†“ AIæ™ºèƒ½æ¨å¯¼ â†“</p>
                      </div>
                      <div className="grid grid-cols-2 gap-1 text-xs">
                        <div className="bg-blue-200 px-2 py-1 rounded">äº§å“é¢†åŸŸï¼štoCå–è´§ @æœç¥</div>
                        <div className="bg-blue-200 px-2 py-1 rounded">ä¸šåŠ¡å½±å“åº¦ï¼š10åˆ†ï¼ˆè‡´å‘½ï¼‰</div>
                        <div className="bg-blue-200 px-2 py-1 rounded">åŒºåŸŸï¼šå—äºš</div>
                        <div className="bg-blue-200 px-2 py-1 rounded">é—¨åº—ç±»å‹ï¼šæ–°é›¶å”®-ç›´è¥åº—</div>
                        <div className="bg-blue-200 px-2 py-1 rounded">æ—¶é—´çª—å£ï¼šä¸€æœˆç¡¬çª—å£</div>
                        <div className="bg-blue-200 px-2 py-1 rounded">å½±å“æŒ‡æ ‡ï¼šGMV/è¥æ”¶</div>
                      </div>
                      <p className="text-blue-600 font-semibold">...ç­‰30+å­—æ®µ</p>
                    </div>
                  </div>

                  <div className="bg-green-50 border border-green-200 rounded-lg p-2">
                    <p className="text-xs text-green-800">
                      ğŸ’¡ <span className="font-semibold">æ¨è</span>ï¼šæ•°æ®å¤æ‚æ—¶ä½¿ç”¨ï¼Œè®©AIå¸®æ‚¨å®Œæˆç¹ççš„å­—æ®µå¡«å†™
                    </p>
                  </div>
                </div>

                <button
                  type="button"
                  onClick={(e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    // ç«‹å³ä¿å­˜å½“å‰æ»šåŠ¨ä½ç½®åˆ°å…¨å±€çŠ¶æ€ï¼ˆåŒæ­¥ï¼‰
                    if (modalContentRef.current) {
                      const scroll = modalContentRef.current.scrollTop;
                      console.log('[æ–¹å¼äºŒç‚¹å‡»] ä¿å­˜æ»šåŠ¨ä½ç½®:', scroll);
                      setImportModalScrollTop(scroll);
                    }
                    // å¼€å§‹AIæ™ºèƒ½å¡«å……ï¼Œè‡ªåŠ¨æ»šåŠ¨ä¼šç”±useEffectè§¦å‘
                    handleAISmartFill();
                  }}
                  disabled={isAIMappingLoading || isAIFillingLoading}
                  title="â˜• ç”¨ä¸€æ¬¡è¿™ä¸ªåŠŸèƒ½ï¼Œè®°å¾—è¯· Evan å–ä¸€æ¯å’–å•¡å“¦~ (tianyuan8@xiaomi.com)"
                  className="w-full px-4 py-3 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 disabled:from-gray-400 disabled:to-gray-400 text-white rounded-lg transition flex items-center justify-center gap-2 font-medium shadow-lg"
                >
                  {isAIFillingLoading ? (
                    <>
                      <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                      <span>æ·±åº¦åˆ†æä¸­...{aiFillingProgress}%</span>
                    </>
                  ) : (
                    <>
                      <Sparkles size={18} className="animate-pulse" />
                      <span>å¼€å§‹æ™ºèƒ½å¡«å……ï¼ˆé¢„è®¡{Math.ceil(importData.length * 3 / 60)}åˆ†{importData.length * 3 % 60}ç§’ï¼‰</span>
                    </>
                  )}
                </button>
              </div>
            </div>

            {/* AIå¡«å……è¿›åº¦æ˜¾ç¤º */}
            {isAIFillingLoading && (
              <div ref={aiProgressBoxRef} className="mb-6 bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50 border-2 border-blue-400 rounded-xl p-6 shadow-2xl">
                {/* æ ‡é¢˜æ  + ç»Ÿè®¡ä¿¡æ¯ï¼ˆæ•´åˆï¼‰ */}
                <div className="mb-4">
                  <div className="flex items-center justify-between mb-3">
                    <div className="flex items-center gap-3">
                      <div className="w-12 h-12 bg-gradient-to-br from-blue-600 to-purple-600 rounded-full flex items-center justify-center animate-pulse shadow-lg">
                        <Sparkles className="text-white" size={24} />
                      </div>
                      <div>
                        <h3 className="text-lg font-bold text-gray-900 flex items-center gap-2">
                          <Sparkles className="text-purple-600" size={20} />
                          AIæ·±åº¦åˆ†æä¸­
                        </h3>
                        <p className="text-xs text-gray-600">æ­£åœ¨æ™ºèƒ½æ¨å¯¼30+å­—æ®µï¼Œè¯·ç¨å€™...</p>
                      </div>
                    </div>
                    <div className="flex items-center gap-3">
                      {/* ç´§å‡‘ç»Ÿè®¡ */}
                      <div className="flex items-center gap-2 bg-white rounded-lg px-3 py-2 shadow-sm border border-gray-200">
                        <span className="text-xs text-gray-600">æ€»æ•°</span>
                        <span className="text-sm font-bold text-gray-900">{importData.length}</span>
                        <span className="text-gray-300">|</span>
                        <span className="text-xs text-green-700">å·²å®Œæˆ</span>
                        <span className="text-sm font-bold text-green-600">{aiFillingCurrentIndex}</span>
                        <span className="text-gray-300">|</span>
                        <span className="text-xs text-orange-700">å‰©ä½™</span>
                        <span className="text-sm font-bold text-orange-600">{importData.length - aiFillingCurrentIndex}</span>
                        <span className="text-gray-300">|</span>
                        <span className="text-xs text-purple-700">é¢„è®¡</span>
                        <span className="text-sm font-bold text-purple-600">
                          {Math.ceil((importData.length - aiFillingCurrentIndex) * 3 / 60)}åˆ†é’Ÿ
                        </span>
                      </div>
                      <button
                        type="button"
                        onClick={(e) => {
                          e.preventDefault();
                          e.stopPropagation();
                          // ç«‹å³ä¿å­˜å½“å‰æ»šåŠ¨ä½ç½®åˆ°å…¨å±€çŠ¶æ€ï¼ˆåŒæ­¥ï¼‰
                          if (modalContentRef.current) {
                            setImportModalScrollTop(modalContentRef.current.scrollTop);
                          }
                          setShowTerminateConfirm(true);
                        }}
                        className="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition flex items-center gap-2 font-medium shadow-md"
                      >
                        <X size={16} />
                        <span>ç»ˆæ­¢åˆ†æ</span>
                      </button>
                    </div>
                  </div>

                  {/* è¿›åº¦æ¡ */}
                  <div className="w-full bg-blue-200 rounded-full h-3 overflow-hidden shadow-inner relative">
                    <div
                      className="bg-gradient-to-r from-blue-500 via-purple-600 to-pink-500 h-full transition-all duration-500 flex items-center justify-end pr-2 relative"
                      style={{ width: `${aiFillingProgress}%` }}
                    >
                      {aiFillingProgress > 10 && (
                        <span className="text-white text-xs font-bold drop-shadow">{aiFillingProgress}%</span>
                      )}
                      {/* æµåŠ¨åŠ¨ç”» */}
                      <div className="absolute inset-0 bg-gradient-to-r from-transparent via-white/30 to-transparent animate-shimmer"></div>
                    </div>
                  </div>
                </div>

                {/* å½“å‰åˆ†æçš„éœ€æ±‚åç§° */}
                <div className="bg-blue-100 rounded-lg p-3 border-l-4 border-blue-600 mb-4">
                  <div className="flex items-center gap-2">
                    <div className="w-6 h-6 bg-blue-600 rounded-full flex items-center justify-center animate-bounce">
                      <span className="text-white font-bold text-xs">#{aiFillingCurrentIndex + 1}</span>
                    </div>
                    <div className="flex-1 min-w-0">
                      <p className="text-xs text-blue-700 mb-0.5">ğŸ” æ­£åœ¨æ·±åº¦åˆ†æ</p>
                      <p className="text-sm font-bold text-blue-900 truncate">{aiFillingCurrentName}</p>
                    </div>
                  </div>
                </div>

                {/* AIåˆ†æè¯¦ç»†æ—¥å¿— */}
                <div className="bg-gray-900 rounded-lg p-4 border border-gray-700">
                  <div className="flex items-center justify-between mb-3">
                    <div className="flex items-center gap-2">
                      <div className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                      <h4 className="text-sm font-bold text-green-400">ğŸ” AIæ¨å¯¼è¿‡ç¨‹å®æ—¶æ—¥å¿—</h4>
                    </div>
                    <span className="text-xs text-gray-500">
                      æ˜¾ç¤ºæœ€è¿‘ {Math.min(aiAnalysisLogs.length, 20)} æ¡
                    </span>
                  </div>
                  <div ref={logContainerRef} className="bg-black rounded p-3 h-64 overflow-y-auto font-mono text-xs space-y-1 scrollbar-thin scrollbar-thumb-gray-700 scrollbar-track-gray-900">
                    {aiAnalysisLogs.length === 0 ? (
                      <p className="text-gray-600 text-center py-8">æš‚æ— æ—¥å¿—...</p>
                    ) : (
                      aiAnalysisLogs.slice(-20).map((log, index) => (
                        <div key={index} className={`
                          ${log.includes('âŒ') ? 'text-red-400' : ''}
                          ${log.includes('âœ…') || log.includes('æˆåŠŸ') ? 'text-green-400' : ''}
                          ${log.includes('â³') || log.includes('ç­‰å¾…') ? 'text-yellow-400' : ''}
                          ${log.includes('ğŸ“‹') || log.includes('â”â”â”') ? 'text-blue-400 font-bold' : ''}
                          ${log.includes('  â””â”€') ? 'text-purple-300 pl-4' : ''}
                          ${!log.includes('âŒ') && !log.includes('âœ…') && !log.includes('â³') && !log.includes('ğŸ“‹') && !log.includes('â”â”â”') && !log.includes('â””â”€') ? 'text-gray-300' : ''}
                        `}>
                          <span className="text-gray-600">[{new Date().toLocaleTimeString()}]</span> {log}
                        </div>
                      ))
                    )}
                  </div>
                </div>

                {/* æç¤ºä¿¡æ¯ */}
                <div className="mt-4 bg-gradient-to-r from-yellow-50 to-orange-50 border border-yellow-300 rounded-lg p-3">
                  <div className="flex items-start gap-3">
                    <span className="text-2xl flex-shrink-0">ğŸ’¡</span>
                    <div className="flex-1 text-xs text-yellow-900 space-y-1">
                      <p className="font-semibold">æ¸©é¦¨æç¤ºï¼š</p>
                      <ul className="list-disc list-inside space-y-0.5 text-yellow-800">
                        <li>AIåˆ†æéœ€è¦ä¸€å®šæ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…ï¼Œä¸è¦å…³é—­é¡µé¢</li>
                        <li>ä¸Šæ–¹æ—¥å¿—å®æ—¶å±•ç¤ºAIçš„æ¨å¯¼è¿‡ç¨‹ï¼Œè®©æ‚¨äº†è§£æ¯ä¸ªå­—æ®µæ˜¯å¦‚ä½•è¢«æ¨å¯¼å‡ºæ¥çš„</li>
                        <li>å¦‚éœ€ç»ˆæ­¢åˆ†æï¼Œç‚¹å‡»å³ä¸Šè§’çº¢è‰²"ç»ˆæ­¢åˆ†æ"æŒ‰é’®</li>
                        <li>å·²åˆ†æçš„æ•°æ®ä¼šè¢«ä¿ç•™ï¼Œå¤±è´¥çš„éœ€æ±‚ä¼šæ ‡è®°ä¸ºçº¢è‰²</li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* æ ¹æ®æ˜¯å¦æœ‰AIå¡«å……æ•°æ®åˆ‡æ¢æ˜¾ç¤ºå†…å®¹ */}
            {aiFilledData.length > 0 ? (
              /* === AIå¡«å……åçš„æ•°æ®é¢„è§ˆè¡¨æ ¼ === */
              <div className="mb-6">
                <div className="flex items-center justify-between mb-3">
                  <h3 className="font-semibold text-gray-800 flex items-center gap-2">
                    <Sparkles className="text-purple-600" size={18} />
                    AIæ™ºèƒ½å¡«å……ç»“æœé¢„è§ˆ
                  </h3>
                  <span className="text-sm text-gray-600">
                    âœ… {aiFilledData.filter(r => r._aiAnalysisStatus === 'success').length} æˆåŠŸ |
                    âŒ {aiFilledData.filter(r => r._aiAnalysisStatus === 'failed').length} å¤±è´¥
                  </span>
                </div>

                <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-4">
                  <p className="text-sm text-yellow-800">
                    ğŸ’¡ æç¤ºï¼šè¯·æ£€æŸ¥AIå¡«å……çš„æ•°æ®ï¼Œå‹¾é€‰éœ€è¦å¯¼å…¥çš„éœ€æ±‚ã€‚å¤±è´¥çš„éœ€æ±‚å·²æ ‡è®°ä¸ºçº¢è‰²ï¼Œæ‚¨å¯ä»¥å–æ¶ˆå‹¾é€‰æˆ–æ‰‹åŠ¨ä¿®æ­£åå†å¯¼å…¥ã€‚
                  </p>
                </div>

                <div className="border border-gray-200 rounded-lg overflow-auto max-h-96">
                  <table className="w-full text-sm">
                    <thead className="bg-gray-50 sticky top-0">
                      <tr>
                        <th className="px-3 py-2 text-left w-12">
                          <input
                            type="checkbox"
                            checked={aiFilledData.every(r => r._isSelected)}
                            onChange={(e) => {
                              const { setAIFilledData } = useStore.getState();
                              const updated = aiFilledData.map(r => ({
                                ...r,
                                _isSelected: e.target.checked
                              }));
                              setAIFilledData(updated);
                            }}
                            className="w-4 h-4 rounded"
                          />
                        </th>
                        <th className="px-3 py-2 text-left font-semibold text-gray-700">çŠ¶æ€</th>
                        <th className="px-3 py-2 text-left font-semibold text-gray-700">éœ€æ±‚åç§°</th>
                        <th className="px-3 py-2 text-left font-semibold text-gray-700">ä¸šåŠ¡å½±å“åº¦</th>
                        <th className="px-3 py-2 text-left font-semibold text-gray-700">æŠ€æœ¯å¤æ‚åº¦</th>
                        <th className="px-3 py-2 text-left font-semibold text-gray-700">äº§å“é¢†åŸŸ</th>
                        <th className="px-3 py-2 text-left font-semibold text-gray-700">å·¥ä½œé‡</th>
                        <th className="px-3 py-2 text-left font-semibold text-gray-700">AIå­—æ®µæ•°</th>
                      </tr>
                    </thead>
                    <tbody>
                      {aiFilledData.map((req, index) => {
                        const isSuccess = req._aiAnalysisStatus === 'success';
                        const aiFieldCount = req._aiFilledFields?.length || 0;

                        return (
                          <tr
                            key={index}
                            className={`border-t border-gray-200 cursor-pointer hover:bg-gray-50 ${
                              !isSuccess ? 'bg-red-50' : ''
                            } ${selectedRequirementIndex === index ? 'bg-blue-100' : ''}`}
                            onClick={() => setSelectedRequirementIndex(index)}
                          >
                            <td className="px-3 py-2" onClick={(e) => e.stopPropagation()}>
                              <input
                                type="checkbox"
                                checked={req._isSelected || false}
                                onChange={(e) => {
                                  const { setAIFilledData } = useStore.getState();
                                  const updated = [...aiFilledData];
                                  updated[index] = { ...updated[index], _isSelected: e.target.checked };
                                  setAIFilledData(updated);
                                }}
                                className="w-4 h-4 rounded"
                              />
                            </td>
                            <td className="px-3 py-2">
                              {isSuccess ? (
                                <span className="text-green-600 font-semibold">âœ… æˆåŠŸ</span>
                              ) : (
                                <span className="text-red-600 font-semibold" title={req._aiErrorMessage}>
                                  âŒ å¤±è´¥
                                </span>
                              )}
                            </td>
                            <td className="px-3 py-2 font-medium text-gray-800 max-w-xs truncate">
                              {req.name}
                            </td>
                            <td className="px-3 py-2">
                              {req.businessImpactScore ? (
                                <span className="inline-flex items-center gap-1">
                                  <span className="font-semibold text-blue-600">{req.businessImpactScore}åˆ†</span>
                                  {req._aiFilledFields?.includes('businessImpactScore') && (
                                    <Sparkles size={12} className="text-purple-500" />
                                  )}
                                </span>
                              ) : '-'}
                            </td>
                            <td className="px-3 py-2">
                              {req.complexityScore ? (
                                <span className="inline-flex items-center gap-1">
                                  <span className="font-semibold text-orange-600">{req.complexityScore}åˆ†</span>
                                  {req._aiFilledFields?.includes('complexityScore') && (
                                    <Sparkles size={12} className="text-purple-500" />
                                  )}
                                </span>
                              ) : '-'}
                            </td>
                            <td className="px-3 py-2 text-gray-600 max-w-xs truncate">
                              {req.productArea || '-'}
                            </td>
                            <td className="px-3 py-2 text-gray-600">
                              {req.effortDays || 0}å¤©
                            </td>
                            <td className="px-3 py-2">
                              <span
                                className="text-purple-600 font-semibold cursor-help flex items-center gap-1"
                                title={req._aiFilledFields?.map(f => FIELD_NAME_MAP[f] || f).join('ã€') || 'æ— AIå¡«å……å­—æ®µ'}
                              >
                                <Sparkles size={14} className="text-purple-600" />
                                {aiFieldCount}
                              </span>
                            </td>
                          </tr>
                        );
                      })}
                    </tbody>
                  </table>
                </div>

                {/* é€‰ä¸­éœ€æ±‚çš„è¯¦ç»†ä¿¡æ¯ - å®Œæ•´å±•ç¤ºæ‰€æœ‰å­—æ®µå’Œå€¼ */}
                {selectedRequirementIndex !== null && aiFilledData[selectedRequirementIndex] && (
                  <div className="mt-3 bg-gradient-to-r from-blue-50 to-purple-50 border border-blue-200 rounded-lg p-3">
                    <div className="flex items-center justify-between mb-1">
                      <h4 className="text-sm font-bold text-blue-900 flex items-center gap-2">
                        <span className="w-6 h-6 bg-blue-600 text-white rounded-full flex items-center justify-center text-xs">
                          {selectedRequirementIndex + 1}
                        </span>
                        éœ€æ±‚è¯¦æƒ…é¢„è§ˆ - å®Œæ•´ä¿¡æ¯
                      </h4>
                      <button
                        onClick={() => setSelectedRequirementIndex(null)}
                        className="text-blue-600 hover:text-blue-800 transition"
                      >
                        <X size={18} />
                      </button>
                    </div>
                    {(() => {
                      const req = aiFilledData[selectedRequirementIndex];
                      const aiFilledFields = req._aiFilledFields || [];
                      const basicFields = ['name', 'description', 'submitterName', 'submitDate', 'submitter', 'businessTeam'];
                      const businessFields = ['businessImpactScore', 'affectedMetrics', 'impactScope', 'businessDomain', 'customBusinessDomain'];
                      const timeFields = ['timeCriticality', 'hardDeadline', 'deadlineDate'];
                      const techFields = ['effortDays', 'complexityScore', 'type', 'productManager', 'developer', 'productProgress', 'techProgress', 'dependencies', 'isRMS'];
                      const extendedFields = ['project', 'productArea', 'backendDeveloper', 'frontendDeveloper', 'tester', 'rdNotes'];

                      // è®¡ç®—å­—æ®µç»Ÿè®¡
                      const allFieldKeys = [...basicFields, ...businessFields, ...timeFields, ...techFields, ...extendedFields];
                      const totalFieldsCount = allFieldKeys.filter(key => {
                        const value = (req as any)[key];
                        return value !== undefined && value !== null && value !== '' && (!Array.isArray(value) || value.length > 0);
                      }).length;
                      const aiFilledCount = aiFilledFields.length;
                      const directMatchedCount = totalFieldsCount - aiFilledCount;

                      // å®šä¹‰å­—æ®µåˆ†ç»„å’Œæ˜¾ç¤ºé€»è¾‘
                      const renderField = (fieldKey: string, fieldValue: any) => {
                        // è·³è¿‡å…ƒæ•°æ®å­—æ®µå’Œç©ºå€¼
                        if (fieldKey.startsWith('_') || fieldKey === 'id') return null;
                        if (fieldValue === undefined || fieldValue === null || fieldValue === '' ||
                            (Array.isArray(fieldValue) && fieldValue.length === 0)) return null;

                        const isAIFilled = aiFilledFields.includes(fieldKey);
                        const fieldLabel = FIELD_NAME_MAP[fieldKey] || fieldKey;

                        // æ ¼å¼åŒ–å­—æ®µå€¼
                        let displayValue: string;
                        if (Array.isArray(fieldValue)) {
                          if (fieldKey === 'affectedMetrics') {
                            displayValue = fieldValue.map((m: any) => m.displayName || m.metricName).join('ã€');
                          } else if (fieldKey === 'dependencies') {
                            displayValue = fieldValue.join('ã€');
                          } else {
                            displayValue = fieldValue.join('ã€');
                          }
                        } else if (typeof fieldValue === 'object') {
                          if (fieldKey === 'impactScope') {
                            const parts = [];
                            if (fieldValue.storeTypes?.length) parts.push(`é—¨åº—ç±»å‹: ${fieldValue.storeTypes.join('ã€')}`);
                            if (fieldValue.regions?.length) parts.push(`åŒºåŸŸ: ${fieldValue.regions.join('ã€')}`);
                            if (fieldValue.storeCountRange) parts.push(`é—¨åº—æ•°: ${fieldValue.storeCountRange}`);
                            displayValue = parts.join(' | ');
                          } else {
                            displayValue = JSON.stringify(fieldValue);
                          }
                        } else if (typeof fieldValue === 'boolean') {
                          displayValue = fieldValue ? 'æ˜¯' : 'å¦';
                        } else {
                          displayValue = String(fieldValue);
                        }

                        return (
                          <div key={fieldKey} className="flex items-start gap-2 py-1.5 border-b border-gray-200 last:border-0">
                            <div className="flex items-center gap-1 min-w-[100px]">
                              {isAIFilled && <Sparkles size={12} className="text-purple-600 flex-shrink-0" />}
                              <span className={`text-xs font-semibold ${isAIFilled ? 'text-purple-700' : 'text-gray-700'}`}>
                                {fieldLabel}:
                              </span>
                            </div>
                            <div className="flex-1 text-xs text-gray-900 break-words">
                              {displayValue}
                            </div>
                          </div>
                        );
                      };

                      return (
                        <>
                          {/* å­—æ®µç»Ÿè®¡ä¿¡æ¯ */}
                          <div className="mb-2 px-2 py-1.5 bg-white/60 rounded text-xs text-gray-700 flex items-center gap-3">
                            <span className="font-semibold">å…± {totalFieldsCount} ä¸ªå­—æ®µ</span>
                            <span className="text-gray-400">|</span>
                            <span className="text-green-700">{directMatchedCount} ä¸ªç›´æ¥åŒ¹é…</span>
                            <span className="text-gray-400">|</span>
                            <span className="text-purple-700 flex items-center gap-1">
                              <Sparkles size={10} className="text-purple-600" />
                              {aiFilledCount} ä¸ªAIæ¨å¯¼
                            </span>
                            <span className="text-gray-400">|</span>
                            <span className="text-orange-600 font-medium">è¯·ä»”ç»†æ ¸å¯¹</span>
                          </div>

                          <div className="space-y-3 text-xs max-h-[500px] overflow-y-auto">
                          {/* åŸºæœ¬ä¿¡æ¯ */}
                          <div className="bg-white rounded-lg p-3 shadow-sm">
                            <h5 className="font-bold text-blue-800 mb-2 flex items-center gap-1">
                              <span className="w-1 h-4 bg-blue-600 rounded"></span>
                              åŸºæœ¬ä¿¡æ¯
                            </h5>
                            {basicFields.map(field => renderField(field, (req as any)[field]))}
                          </div>

                          {/* ä¸šåŠ¡å½±å“åº¦ */}
                          <div className="bg-white rounded-lg p-3 shadow-sm">
                            <h5 className="font-bold text-blue-800 mb-2 flex items-center gap-1">
                              <span className="w-1 h-4 bg-blue-600 rounded"></span>
                              ä¸šåŠ¡å½±å“åº¦
                            </h5>
                            {businessFields.map(field => renderField(field, (req as any)[field]))}
                          </div>

                          {/* æ—¶é—´ç»´åº¦ */}
                          <div className="bg-white rounded-lg p-3 shadow-sm">
                            <h5 className="font-bold text-blue-800 mb-2 flex items-center gap-1">
                              <span className="w-1 h-4 bg-orange-600 rounded"></span>
                              æ—¶é—´ç»´åº¦
                            </h5>
                            {timeFields.map(field => renderField(field, (req as any)[field]))}
                          </div>

                          {/* æŠ€æœ¯ä¿¡æ¯ */}
                          <div className="bg-white rounded-lg p-3 shadow-sm">
                            <h5 className="font-bold text-blue-800 mb-2 flex items-center gap-1">
                              <span className="w-1 h-4 bg-green-600 rounded"></span>
                              æŠ€æœ¯ä¿¡æ¯
                            </h5>
                            {techFields.map(field => renderField(field, (req as any)[field]))}
                          </div>

                          {/* äº§ç ”æ‰©å±• */}
                          <div className="bg-white rounded-lg p-3 shadow-sm">
                            <h5 className="font-bold text-blue-800 mb-2 flex items-center gap-1">
                              <span className="w-1 h-4 bg-purple-600 rounded"></span>
                              äº§ç ”æ‰©å±•
                            </h5>
                            {extendedFields.map(field => renderField(field, (req as any)[field]))}
                          </div>
                          </div>
                        </>
                      );
                    })()}
                  </div>
                )}
              </div>
            ) : (
              /* === åŸæœ‰çš„å­—æ®µæ˜ å°„é…ç½® === */
              <>
                <div ref={fieldMappingRef} className="mb-6">
                  <h3 className="font-semibold text-gray-800 mb-3 flex items-center gap-2">
                    <ArrowUpDown size={18} />
                    å­—æ®µæ˜ å°„é…ç½®
                  </h3>
              <div className="border border-gray-200 rounded-lg overflow-hidden">
                <table className="w-full text-sm">
                  <thead className="bg-gray-50">
                    <tr>
                      <th className="px-4 py-3 text-left font-semibold text-gray-700 w-1/3">Excelåˆ—å</th>
                      <th className="px-4 py-3 text-left font-semibold text-gray-700 w-1/4">ç¤ºä¾‹æ•°æ®</th>
                      <th className="px-4 py-3 text-left font-semibold text-gray-700 w-1/3">æ˜ å°„åˆ°ç³»ç»Ÿå­—æ®µ</th>
                    </tr>
                  </thead>
                  <tbody>
                    {fileFields.map((field, index) => {
                      // æ‰¾åˆ°å½“å‰æ–‡ä»¶å­—æ®µæ˜ å°„åˆ°çš„ç³»ç»Ÿå­—æ®µ
                      const mappedSystemField = Object.keys(importMapping).find(
                        key => importMapping[key] === field
                      ) || '';

                      return (
                        <tr key={index} className="border-t border-gray-200 hover:bg-gray-50">
                          <td className="px-4 py-3 font-medium text-gray-800">{field}</td>
                          <td className="px-4 py-3 text-gray-600 truncate max-w-xs">
                            {String(sampleRow[field])}
                          </td>
                          <td className="px-4 py-3">
                            <select
                              value={mappedSystemField}
                              onChange={(e) => {
                                const newMapping = { ...importMapping };
                                // ç§»é™¤æ—§æ˜ å°„
                                Object.keys(newMapping).forEach(key => {
                                  if (newMapping[key] === field) {
                                    delete newMapping[key];
                                  }
                                });
                                // æ·»åŠ æ–°æ˜ å°„
                                if (e.target.value) {
                                  newMapping[e.target.value] = field;
                                }
                                setImportMapping(newMapping);
                              }}
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent text-sm"
                            >
                              {systemFieldOptions.map(option => (
                                <option key={option.value} value={option.value}>
                                  {option.label}
                                </option>
                              ))}
                            </select>
                          </td>
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
              </div>
            </div>

            {/* æ•°æ®é¢„è§ˆ */}
            <div>
              <h3 className="font-semibold text-gray-800 mb-3">æ•°æ®é¢„è§ˆï¼ˆå‰5æ¡ï¼‰</h3>
              <div className="border border-gray-200 rounded-lg overflow-auto max-h-60">
                <table className="w-full text-xs">
                  <thead className="bg-gray-50 sticky top-0">
                    <tr>
                      {fileFields.map(field => (
                        <th key={field} className="px-3 py-2 text-left font-semibold text-gray-700 whitespace-nowrap">
                          {field}
                        </th>
                      ))}
                    </tr>
                  </thead>
                  <tbody>
                    {importData.slice(0, 5).map((row: any, index: number) => (
                      <tr key={index} className="border-t border-gray-200">
                        {fileFields.map(field => (
                          <td key={field} className="px-3 py-2 text-gray-600 whitespace-nowrap">
                            {String(row[field])}
                          </td>
                        ))}
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>

                {/* è­¦å‘Šæç¤º */}
                {!hasRequiredFields && (
                  <div className="mt-6 bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                    <p className="text-sm text-yellow-800 flex items-center gap-2">
                      <AlertCircle size={16} />
                      <span className="font-semibold">æ³¨æ„ï¼š</span>
                      å¿…é¡»æ˜ å°„"éœ€æ±‚åç§°"å­—æ®µæ‰èƒ½å¯¼å…¥
                    </p>
                  </div>
                )}
              </>
            )}
          </div>

          {/* æ“ä½œæŒ‰é’® */}
          <div className="border-t border-gray-200 px-6 py-4 flex justify-between items-center">
            <div className="flex items-center gap-2">
              <input
                type="checkbox"
                id="clear-before-import"
                checked={clearBeforeImport}
                onChange={(e) => setClearBeforeImport(e.target.checked)}
                className="w-4 h-4 text-red-600 rounded focus:ring-2 focus:ring-red-500"
              />
              <label htmlFor="clear-before-import" className="text-sm text-gray-700 cursor-pointer">
                æ¸…ç©ºå·²æœ‰éœ€æ±‚å¹¶å¯¼å…¥å…¨æ–°æ•°æ®
                {clearBeforeImport && (
                  <span className="ml-2 text-red-600 font-semibold">ï¼ˆè­¦å‘Šï¼šå°†åˆ é™¤æ‰€æœ‰ç°æœ‰éœ€æ±‚ï¼ï¼‰</span>
                )}
              </label>
            </div>
            <div className="flex gap-3">
              <button
                onClick={() => setShowImportModal(false)}
                className="px-5 py-2.5 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition font-medium"
              >
                å–æ¶ˆ
              </button>
              <button
                onClick={handleConfirmImport}
                disabled={aiFilledData.length > 0 ? aiFilledData.filter(r => r._isSelected).length === 0 : !hasRequiredFields}
                className="px-5 py-2.5 bg-teal-600 hover:bg-teal-700 disabled:bg-gray-300 disabled:text-gray-500 text-white rounded-lg transition font-medium flex items-center gap-2"
              >
                <Save size={18} />
                {aiFilledData.length > 0
                  ? `ç¡®è®¤å¯¼å…¥ (å·²é€‰${aiFilledData.filter(r => r._isSelected).length}/${aiFilledData.length} æ¡)`
                  : `ç¡®è®¤å¯¼å…¥ (${importData.length} æ¡)`}
              </button>
            </div>
          </div>
        </div>

        {/* ç»ˆæ­¢åˆ†æç¡®è®¤å¯¹è¯æ¡† */}
        {showTerminateConfirm && (
          <div className="absolute inset-0 bg-black/50 z-10 flex items-center justify-center p-4">
            <div className="bg-white rounded-xl shadow-2xl max-w-md w-full p-6 animate-[slideIn_0.3s_ease-out]">
              <div className="flex items-start gap-3 mb-4">
                <div className="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center flex-shrink-0">
                  <AlertCircle className="text-red-600" size={24} />
                </div>
                <div className="flex-1">
                  <h3 className="text-lg font-bold text-gray-900 mb-1">ç¡®å®šè¦ç»ˆæ­¢AIåˆ†æå—ï¼Ÿ</h3>
                  <p className="text-sm text-gray-600">æ­¤æ“ä½œæ— æ³•æ’¤é”€</p>
                </div>
              </div>

              <div className="bg-gray-50 rounded-lg p-4 mb-6 space-y-2 text-sm">
                <div className="flex items-start gap-2">
                  <span className="text-green-600">âœ“</span>
                  <span className="text-gray-700">å·²åˆ†æ <strong className="text-green-700">{aiFillingCurrentIndex}</strong> æ¡éœ€æ±‚çš„æ•°æ®å°†ä¼šä¿ç•™</span>
                </div>
                <div className="flex items-start gap-2">
                  <span className="text-orange-600">âš </span>
                  <span className="text-gray-700">å‰©ä½™ <strong className="text-orange-700">{importData.length - aiFillingCurrentIndex}</strong> æ¡éœ€æ±‚å°†ä¸ä¼šåˆ†æ</span>
                </div>
                <div className="flex items-start gap-2">
                  <span className="text-red-600">âœ—</span>
                  <span className="text-gray-700">ç»ˆæ­¢å <strong className="text-red-700">æ— æ³•æ¢å¤</strong>ï¼Œéœ€è¦é‡æ–°å¼€å§‹</span>
                </div>
              </div>

              <div className="flex gap-3">
                <button
                  type="button"
                  onClick={(e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    // ç«‹å³ä¿å­˜å½“å‰æ»šåŠ¨ä½ç½®åˆ°å…¨å±€çŠ¶æ€ï¼ˆåŒæ­¥ï¼‰
                    if (modalContentRef.current) {
                      setImportModalScrollTop(modalContentRef.current.scrollTop);
                    }
                    setShowTerminateConfirm(false);
                  }}
                  className="flex-1 px-4 py-2.5 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition font-medium"
                >
                  å–æ¶ˆ
                </button>
                <button
                  type="button"
                  onClick={(e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    // ç«‹å³ä¿å­˜å½“å‰æ»šåŠ¨ä½ç½®åˆ°å…¨å±€çŠ¶æ€ï¼ˆåŒæ­¥ï¼‰
                    if (modalContentRef.current) {
                      setImportModalScrollTop(modalContentRef.current.scrollTop);
                    }
                    useStore.getState().setAIFillingCancelled(true);
                    setShowTerminateConfirm(false);

                    // æ˜¾ç¤ºæŒä¹…åŒ–çš„"æ­£åœ¨ç»ˆæ­¢"æç¤ºï¼Œå­˜å‚¨toast IDä»¥ä¾¿åç»­æ‰‹åŠ¨ç§»é™¤
                    const toastId = showToast('â¹ï¸ æ­£åœ¨ç»ˆæ­¢AIåˆ†æï¼Œè¯·ç¨å€™...', 'info', { persistent: true });
                    terminationToastIdRef.current = toastId;
                  }}
                  className="flex-1 px-4 py-2.5 bg-red-500 hover:bg-red-600 text-white rounded-lg transition font-medium shadow-md"
                >
                  ç¡®å®šç»ˆæ­¢
                </button>
              </div>
            </div>
          </div>
        )}
      </div>
    );
  };

  return (
    <div className="h-screen flex flex-col bg-gray-50">
      {/* Header Component */}
      <Header
        currentUser={currentUser}
        compact={compact}
        onToggleCompact={toggleCompact}
        onShowHandbook={() => setShowHandbook(true)}
        onImport={() => document.getElementById('file-import-input')?.click()}
        onExportExcel={handleExportExcelWithMenu}
        onExportPDF={handleExportPDFWithMenu}
        onExportPNG={handleExportPNGWithMenu}
        onLogout={handleLogout}
        showExportMenu={showExportMenu}
        onToggleExportMenu={() => setShowExportMenu(!showExportMenu)}
      />

      {/* Hidden file input for import */}
      <input
        id="file-import-input"
        type="file"
        accept=".csv,.xlsx,.xls"
        onChange={handleFileImport}
        className="hidden"
      />

      {hardDeadlineReqs.length > 0 && (
        <div className="bg-red-500 border-b border-red-600 px-6 py-3 flex-shrink-0">
          <div className="flex items-center gap-2 text-white">
            <AlertCircle size={20} />
            <span className="font-medium">
              {hardDeadlineReqs.length} ä¸ªå¼ºåˆ¶DDLéœ€æ±‚æœªæ’æœŸ
            </span>
          </div>
        </div>
      )}

      <div className="flex-1 flex overflow-hidden">
        <div onDragEnter={() => handleDragEnter('unscheduled')} onDragLeave={handleDragLeave} className="flex-shrink-0">
          <UnscheduledArea
            unscheduled={unscheduled}
            onRequirementClick={(req) => {
              setEditingReq(req);
              setIsNewReq(false);
            }}
            onDrop={() => handleDrop('unscheduled')}
            isDragOver={dragOverPool === 'unscheduled'}
            onAddNew={() => {
              setEditingReq(null);
              setIsNewReq(true);
            }}
            onBatchEvaluate={() => setShowBatchEvalModal(true)}
            compact={compact}
            searchTerm={searchTerm}
            onSearchChange={setSearchTerm}
            filterType={filterType}
            onFilterChange={setFilterType}
            scoreFilter={scoreFilter}
            onScoreFilterChange={setScoreFilter}
            effortFilter={effortFilter}
            onEffortFilterChange={setEffortFilter}
            bvFilter={bvFilter}
            onBVFilterChange={setBVFilter}
            businessDomainFilter={businessDomainFilter}
            onBusinessDomainFilterChange={setBusinessDomainFilter}
            rmsFilter={rmsFilter}
            onRMSFilterChange={setRMSFilter}
            leftPanelWidth={leftPanelWidth}
            onClearAll={clearAllRequirements}
          />
        </div>

        {/* æ‹–åŠ¨æ¡ */}
        <div
          className="w-1 bg-gray-300 hover:bg-blue-500 cursor-col-resize transition-colors flex-shrink-0 h-full"
          onMouseDown={(e) => {
            e.preventDefault();
            const startX = e.clientX;
            const startWidth = leftPanelWidth;

            const handleMouseMove = (e: MouseEvent) => {
              const diff = e.clientX - startX;
              const newWidth = Math.max(300, Math.min(1400, startWidth + diff));
              setLeftPanelWidth(newWidth);
            };

            const handleMouseUp = () => {
              document.removeEventListener('mousemove', handleMouseMove);
              document.removeEventListener('mouseup', handleMouseUp);
            };

            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', handleMouseUp);
          }}
        />

        <div className="flex-1 p-3 overflow-x-auto overflow-y-hidden bg-gray-100">
          <div className="flex items-stretch min-w-min h-full">
            {sprintPools.map((pool) => (
              <React.Fragment key={pool.id}>
                <div
                  onDragEnter={() => handleDragEnter(pool.id)}
                  onDragLeave={handleDragLeave}
                  className="h-full flex-shrink-0"
                  style={{ width: `${poolWidths[pool.id] || 384}px` }}
                >
                  <SprintPoolComponent
                    pool={pool}
                    onRequirementClick={(req) => {
                      setEditingReq(req);
                      setIsNewReq(false);
                    }}
                    onDrop={(poolId) => handleDrop(poolId)}
                    isDragOver={dragOverPool === pool.id}
                    onEdit={() => setEditingSprint(pool)}
                    onDelete={() => handleDeleteSprint(pool.id)}
                    compact={compact}
                  />
                </div>

                {/* æ‹–åŠ¨æ¡ - æ¯ä¸ªæ± å³ä¾§éƒ½æœ‰ */}
                <div
                  className="w-1 mx-3 bg-gray-300 hover:bg-blue-500 cursor-col-resize transition-colors flex-shrink-0 h-full"
                  onMouseDown={(e) => {
                    e.preventDefault();
                    const startX = e.clientX;
                    const startWidth = poolWidths[pool.id] || 384;

                    const handleMouseMove = (e: MouseEvent) => {
                      const diff = e.clientX - startX;
                      const newWidth = Math.max(300, Math.min(800, startWidth + diff));
                      setPoolWidth(pool.id, newWidth);
                    };

                    const handleMouseUp = () => {
                      document.removeEventListener('mousemove', handleMouseMove);
                      document.removeEventListener('mouseup', handleMouseUp);
                    };

                    document.addEventListener('mousemove', handleMouseMove);
                    document.addEventListener('mouseup', handleMouseUp);
                  }}
                />
              </React.Fragment>
            ))}

            {/* æ–°å¢è¿­ä»£æ± æŒ‰é’® */}
            <div className="flex-shrink-0 w-96 h-full">
              <button
                onClick={handleAddSprint}
                className="w-full h-full bg-white border-2 border-dashed border-gray-300 rounded-xl hover:border-teal-500 hover:bg-teal-50 transition-all flex flex-col items-center justify-center gap-3 text-gray-500 hover:text-teal-600"
              >
                <Plus size={48} className="opacity-50" />
                <span className="text-lg font-medium">æ–°å¢è¿­ä»£æ± </span>
              </button>
            </div>
          </div>
        </div>
      </div>

      <div className="bg-white border-t border-gray-200 px-6 py-3 shadow-sm flex-shrink-0">
        <div className="flex items-center justify-between text-sm text-gray-600">
          <div className="flex gap-6">
            <span>æ€»éœ€æ±‚ <strong className="text-gray-900">{requirements.length}</strong></span>
            <span>å·²æ’æœŸ <strong className="text-gray-900">{totalScheduled}</strong></span>
            <span>æœªæ’æœŸ <strong className="text-gray-900">{unscheduled.length}</strong></span>
            <span>æœªè¯„ä¼° <strong className="text-red-600">{notEvaluatedCount}</strong></span>
          </div>
          <div className="flex gap-6">
            <span>å¼ºDDL <strong className="text-red-600">{requirements.filter(r => r.hardDeadline).length}</strong></span>
            <span>èµ„æºä½¿ç”¨ <strong className="text-gray-900">{totalResourceUsed}/{Math.round(totalResourceAvailable)}</strong> ({Math.round(totalResourceUsed / totalResourceAvailable * 100)}%)</span>
          </div>
        </div>
      </div>

      {(editingReq || isNewReq) && (
        <EditRequirementModal 
          requirement={editingReq}
          onSave={handleSaveRequirement}
          onClose={() => {
            setEditingReq(null);
            setIsNewReq(false);
          }}
          isNew={isNewReq}
        />
      )}

      {editingSprint && (
        <EditSprintModal 
          sprint={editingSprint}
          onSave={handleSaveSprint}
          onClose={() => setEditingSprint(null)}
        />
      )}

      {showLogin && (
        <LoginModal onLogin={handleLogin} />
      )}

      {showHandbook && (
        <HandbookModal onClose={() => setShowHandbook(false)} />
      )}

      {/* å¯¼å…¥é¢„è§ˆModal */}
      <ImportPreviewModal />

      {/* æ‰¹é‡AIè¯„ä¼°Modal */}
      {showBatchEvalModal && (
        <BatchEvaluationModal
          requirements={requirements}
          onClose={() => setShowBatchEvalModal(false)}
          onApplyScores={handleApplyBatchScores}
        />
      )}

      {/* Toasté€šçŸ¥å®¹å™¨ */}
      <ToastContainer toasts={toasts} onDismiss={dismissToast} />
    </div>
  );
}