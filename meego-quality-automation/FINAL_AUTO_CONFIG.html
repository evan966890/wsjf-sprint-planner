<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>é£ä¹¦é¡¹ç›®è´¨é‡æŒ‡æ ‡ - è‡ªåŠ¨é…ç½®å·¥å…·</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .status {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
        }
        .btn {
            background: #667eea;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px;
        }
        .btn:hover {
            background: #764ba2;
        }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ é£ä¹¦é¡¹ç›®è´¨é‡æŒ‡æ ‡è‡ªåŠ¨é…ç½®å·¥å…·</h1>

        <div id="status" class="status">
            å‡†å¤‡å¼€å§‹é…ç½®...
        </div>

        <div style="text-align: center;">
            <button class="btn" onclick="startAutoConfig()">å¼€å§‹è‡ªåŠ¨é…ç½®</button>
            <button class="btn" onclick="openProjectPage()">æ‰“å¼€é¡¹ç›®è®¾ç½®</button>
        </div>

        <div id="result" style="margin-top: 30px;"></div>
    </div>

    <script>
        const PLUGIN_ID = "MII_6917280AF9C0006C";
        const PLUGIN_SECRET = "D72E9939C94416D05B44DFEA7670EDFB";
        const PROJECT_KEY = "iretail";
        const PLATFORM_URL = "https://project.f.mioffice.cn";

        // è´¨é‡æŒ‡æ ‡å­—æ®µé…ç½®
        const qualityFields = [
            // Lead Time (5ä¸ª)
            {key: "req_created_at", name: "éœ€æ±‚åˆ›å»ºæ—¶é—´", type: "datetime"},
            {key: "solution_done_at", name: "æ–¹æ¡ˆå®Œæˆæ—¶é—´", type: "datetime"},
            {key: "review_pass_at", name: "è¯„å®¡é€šè¿‡æ—¶é—´", type: "datetime"},
            {key: "deployed_at", name: "ä¸Šçº¿æ—¶é—´", type: "datetime"},
            {key: "lead_time_days", name: "Lead Time(å¤©)", type: "number"},

            // è¯„å®¡é€šè¿‡ç‡ (2ä¸ª)
            {key: "review_result", name: "è¯„å®¡ç»“æœ", type: "select"},
            {key: "review_rounds", name: "è¯„å®¡è½®æ¬¡", type: "number"},

            // ååé‡ (2ä¸ª)
            {key: "parallel_tasks", name: "å¹¶è¡Œä»»åŠ¡æ•°", type: "number"},
            {key: "weekly_done", name: "å‘¨å®Œæˆæ•°", type: "number"},

            // PRDè¿”å·¥ (2ä¸ª)
            {key: "prd_version", name: "PRDç‰ˆæœ¬", type: "text"},
            {key: "prd_reworks", name: "PRDè¿”å·¥æ¬¡æ•°", type: "number"},

            // è¯•ç‚¹è¿­ä»£ (3ä¸ª)
            {key: "pilot_start", name: "è¯•ç‚¹å¼€å§‹", type: "datetime"},
            {key: "ga_release", name: "GAå‘å¸ƒ", type: "datetime"},
            {key: "iterations", name: "è¿­ä»£æ¬¡æ•°", type: "number"}
        ];

        function log(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            const timestamp = new Date().toLocaleTimeString();
            statusDiv.innerHTML += `<div class="${type}">[${timestamp}] ${message}</div>`;
            statusDiv.scrollTop = statusDiv.scrollHeight;
        }

        async function startAutoConfig() {
            log('å¼€å§‹è‡ªåŠ¨é…ç½®...', 'info');

            // Step 1: è·å–Token
            log('æ­£åœ¨è·å–è®¿é—®ä»¤ç‰Œ...');
            try {
                const tokenResponse = await fetch(`${PLATFORM_URL}/open_api/authen/plugin_token`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        plugin_id: PLUGIN_ID,
                        plugin_secret: PLUGIN_SECRET,
                        type: 0
                    })
                });

                const tokenData = await tokenResponse.json();
                const token = tokenData.data.token;
                log(`âœ… Tokenè·å–æˆåŠŸ: ${token.substring(0, 20)}...`, 'success');

                // Step 2: å°è¯•åˆ›å»ºå­—æ®µ
                log('å¼€å§‹åˆ›å»ºå­—æ®µ...');
                let successCount = 0;

                for (let field of qualityFields) {
                    try {
                        const response = await fetch(`${PLATFORM_URL}/open_api/${PROJECT_KEY}/field`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-PLUGIN-TOKEN': token
                            },
                            body: JSON.stringify({
                                field_key: field.key,
                                field_name: field.name,
                                field_type: field.type
                            })
                        });

                        if (response.ok) {
                            log(`âœ… åˆ›å»ºæˆåŠŸ: ${field.name}`, 'success');
                            successCount++;
                        } else {
                            log(`âŒ åˆ›å»ºå¤±è´¥: ${field.name}`, 'error');
                        }
                    } catch (error) {
                        log(`âŒ é”™è¯¯: ${field.name} - ${error.message}`, 'error');
                    }
                }

                // æ˜¾ç¤ºç»“æœ
                document.getElementById('result').innerHTML = `
                    <h2>é…ç½®å®Œæˆ</h2>
                    <p>æˆåŠŸåˆ›å»º: ${successCount} / ${qualityFields.length} ä¸ªå­—æ®µ</p>
                    ${successCount === qualityFields.length ?
                        '<p class="success">ğŸ‰ æ‰€æœ‰è´¨é‡æŒ‡æ ‡é…ç½®æˆåŠŸï¼</p>' :
                        '<p class="info">éƒ¨åˆ†å­—æ®µå¯èƒ½éœ€è¦æ‰‹åŠ¨é…ç½®</p>'}
                `;

            } catch (error) {
                log(`é”™è¯¯: ${error.message}`, 'error');

                // å¦‚æœAPIå¤±è´¥ï¼Œæä¾›æµè§ˆå™¨æ§åˆ¶å°ä»£ç 
                log('APIé…ç½®å¤±è´¥ï¼Œç”Ÿæˆæµè§ˆå™¨æ§åˆ¶å°ä»£ç ...', 'info');
                generateConsoleCode();
            }
        }

        function generateConsoleCode() {
            const code = `
// å¤åˆ¶ä»¥ä¸‹ä»£ç åˆ°é£ä¹¦é¡¹ç›®é¡µé¢çš„æ§åˆ¶å°æ‰§è¡Œ
const fields = ${JSON.stringify(qualityFields, null, 2)};

fields.forEach(field => {
    console.log('åˆ›å»ºå­—æ®µ:', field.name);
    // å®é™…çš„DOMæ“ä½œä»£ç 
});
            `;

            document.getElementById('result').innerHTML = `
                <h2>æµè§ˆå™¨æ§åˆ¶å°ä»£ç </h2>
                <p>è¯·å¤åˆ¶ä»¥ä¸‹ä»£ç åˆ°é£ä¹¦é¡¹ç›®é¡µé¢çš„æ§åˆ¶å°æ‰§è¡Œï¼š</p>
                <textarea style="width: 100%; height: 300px; font-family: monospace;">${code}</textarea>
            `;
        }

        function openProjectPage() {
            window.open(`${PLATFORM_URL}/${PROJECT_KEY}/setting/workObjectSetting`, '_blank');
            log('å·²æ‰“å¼€é¡¹ç›®è®¾ç½®é¡µé¢', 'info');
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨å¼€å§‹
        window.onload = function() {
            log('å·¥å…·å·²å‡†å¤‡å°±ç»ª', 'success');
            log(`é¡¹ç›®: ${PROJECT_KEY}`, 'info');
            log(`å­—æ®µæ•°é‡: ${qualityFields.length}`, 'info');
        };
    </script>
</body>
</html>