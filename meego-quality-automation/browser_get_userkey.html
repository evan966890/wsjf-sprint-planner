<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>é£ä¹¦é¡¹ç›®è´¨é‡æŒ‡æ ‡ - è‡ªåŠ¨é…ç½®å·¥å…·</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f7fa;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #1890ff;
            border-bottom: 2px solid #1890ff;
            padding-bottom: 10px;
        }
        .step {
            margin: 20px 0;
            padding: 20px;
            background: #f0f5ff;
            border-radius: 8px;
            border-left: 4px solid #1890ff;
        }
        .step h3 {
            margin-top: 0;
            color: #0050b3;
        }
        button {
            background: #1890ff;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px 5px;
        }
        button:hover {
            background: #0050b3;
        }
        button:disabled {
            background: #d9d9d9;
            cursor: not-allowed;
        }
        .success {
            background: #f6ffed;
            border-color: #52c41a;
            color: #135200;
        }
        .error {
            background: #fff2e8;
            border-color: #fa8c16;
            color: #ad4e00;
        }
        .code-block {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            overflow-x: auto;
            border: 1px solid #d9d9d9;
        }
        #userKeyDisplay {
            background: #e6f7ff;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
            display: none;
        }
        .progress {
            display: none;
            margin: 20px 0;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #1890ff 0%, #52c41a 100%);
            transition: width 0.3s;
            width: 0%;
        }
        .field-list {
            background: #fafafa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        .field-item {
            padding: 8px 0;
            border-bottom: 1px solid #e8e8e8;
        }
        .field-item:last-child {
            border-bottom: none;
        }
        .metric-group {
            margin: 15px 0;
        }
        .metric-title {
            font-weight: bold;
            color: #0050b3;
            margin: 10px 0 5px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ é£ä¹¦é¡¹ç›®è´¨é‡æŒ‡æ ‡ - è‡ªåŠ¨é…ç½®å·¥å…·</h1>

        <div class="step">
            <h3>æ­¥éª¤ 1ï¼šç™»å½•é£ä¹¦é¡¹ç›®</h3>
            <p>é¦–å…ˆï¼Œè¯·åœ¨æ–°æ ‡ç­¾é¡µä¸­ç™»å½•é£ä¹¦é¡¹ç›®ç®¡ç†å¹³å°ã€‚</p>
            <button onclick="openFeishuProject()">æ‰“å¼€é£ä¹¦é¡¹ç›®</button>
            <p style="color: #666; font-size: 14px;">ç™»å½•åè¯·è¿”å›æ­¤é¡µé¢ç»§ç»­</p>
        </div>

        <div class="step">
            <h3>æ­¥éª¤ 2ï¼šè‡ªåŠ¨è·å–é…ç½®ä¿¡æ¯</h3>
            <p>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ï¼Œå·¥å…·å°†è‡ªåŠ¨è·å–æ‚¨çš„User Keyå’ŒTokenã€‚</p>
            <button id="getConfigBtn" onclick="getConfiguration()">è·å–é…ç½®ä¿¡æ¯</button>
            <div id="userKeyDisplay"></div>
        </div>

        <div class="step">
            <h3>æ­¥éª¤ 3ï¼šé…ç½®è´¨é‡æŒ‡æ ‡</h3>
            <p>ç¡®è®¤ä»¥ä¸‹5ä¸ªè´¨é‡æŒ‡æ ‡ï¼ˆå…±14ä¸ªå­—æ®µï¼‰ï¼š</p>

            <div class="field-list">
                <div class="metric-group">
                    <div class="metric-title">ğŸ“Š éœ€æ±‚Lead Timeï¼ˆ5ä¸ªå­—æ®µï¼‰</div>
                    <div class="field-item">â€¢ éœ€æ±‚åˆ›å»ºæ—¶é—´</div>
                    <div class="field-item">â€¢ æ–¹æ¡ˆå®Œæˆæ—¶é—´</div>
                    <div class="field-item">â€¢ è¯„å®¡é€šè¿‡æ—¶é—´</div>
                    <div class="field-item">â€¢ ä¸Šçº¿æ—¶é—´</div>
                    <div class="field-item">â€¢ Lead Time(å¤©)</div>
                </div>

                <div class="metric-group">
                    <div class="metric-title">âœ… è¯„å®¡ä¸€æ¬¡é€šè¿‡ç‡ï¼ˆ2ä¸ªå­—æ®µï¼‰</div>
                    <div class="field-item">â€¢ è¯„å®¡ç»“æœ</div>
                    <div class="field-item">â€¢ è¯„å®¡è½®æ¬¡</div>
                </div>

                <div class="metric-group">
                    <div class="metric-title">ğŸ”„ å¹¶è¡Œäº‹é¡¹ååé‡ï¼ˆ2ä¸ªå­—æ®µï¼‰</div>
                    <div class="field-item">â€¢ å¹¶è¡Œä»»åŠ¡æ•°</div>
                    <div class="field-item">â€¢ å‘¨å®Œæˆæ•°</div>
                </div>

                <div class="metric-group">
                    <div class="metric-title">ğŸ“ PRDè¿”å·¥ç‡ï¼ˆ2ä¸ªå­—æ®µï¼‰</div>
                    <div class="field-item">â€¢ PRDç‰ˆæœ¬</div>
                    <div class="field-item">â€¢ PRDè¿”å·¥æ¬¡æ•°</div>
                </div>

                <div class="metric-group">
                    <div class="metric-title">ğŸš€ è¯•ç‚¹åˆ°GAè¿­ä»£ï¼ˆ3ä¸ªå­—æ®µï¼‰</div>
                    <div class="field-item">â€¢ è¯•ç‚¹å¼€å§‹æ—¥æœŸ</div>
                    <div class="field-item">â€¢ GAå‘å¸ƒæ—¥æœŸ</div>
                    <div class="field-item">â€¢ è¿­ä»£æ¬¡æ•°</div>
                </div>
            </div>

            <button id="configBtn" onclick="startConfiguration()" disabled>å¼€å§‹è‡ªåŠ¨é…ç½®</button>
        </div>

        <div class="progress">
            <h4>é…ç½®è¿›åº¦</h4>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <p id="progressText">å‡†å¤‡ä¸­...</p>
        </div>

        <div id="result" style="display: none;"></div>
    </div>

    <script>
        // å…¨å±€é…ç½®
        const PLUGIN_ID = "MII_6917280AF9C0006C";
        const PLUGIN_SECRET = "D72E9939C94416D05B44DFEA7670EDFB";
        const PROJECT_KEY = "iretail";
        const PLATFORM_URL = "https://project.f.mioffice.cn";

        let userKey = null;
        let pluginToken = null;

        function openFeishuProject() {
            window.open(PLATFORM_URL + '/' + PROJECT_KEY, '_blank');
        }

        async function getConfiguration() {
            const btn = document.getElementById('getConfigBtn');
            btn.disabled = true;
            btn.textContent = 'è·å–ä¸­...';

            try {
                // æ­¥éª¤1ï¼šè·å–Plugin Token
                const tokenResponse = await fetch('/open_api/authen/plugin_token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        plugin_id: PLUGIN_ID,
                        plugin_secret: PLUGIN_SECRET,
                        type: 0
                    })
                });

                if (!tokenResponse.ok) {
                    throw new Error('æ— æ³•è·å–Tokenï¼Œè¯·ç¡®ä¿å·²ç™»å½•é£ä¹¦é¡¹ç›®');
                }

                const tokenData = await tokenResponse.json();
                if (tokenData.data && tokenData.data.token) {
                    pluginToken = tokenData.data.token;
                    console.log('âœ… Tokenè·å–æˆåŠŸ');
                }

                // æ­¥éª¤2ï¼šå°è¯•ä»cookieä¸­è·å–user_key
                // é€šè¿‡è°ƒç”¨ä¸€ä¸ªéœ€è¦user_keyçš„APIæ¥è§¦å‘æµè§ˆå™¨è‡ªåŠ¨æ·»åŠ 
                const testResponse = await fetch('/open_api/' + PROJECT_KEY + '/work_item/all-types', {
                    method: 'GET',
                    headers: {
                        'X-PLUGIN-TOKEN': pluginToken,
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });

                // å³ä½¿å¤±è´¥ä¹Ÿç»§ç»­ï¼Œå› ä¸ºæˆ‘ä»¬ä¸»è¦æ˜¯æƒ³è®©ç”¨æˆ·æ‰‹åŠ¨è¾“å…¥
                const userKeyDiv = document.getElementById('userKeyDisplay');
                userKeyDiv.style.display = 'block';
                userKeyDiv.innerHTML = `
                    <strong>è¯·è¾“å…¥æ‚¨çš„User Keyï¼š</strong><br>
                    <input type="text" id="userKeyInput" placeholder="ä¾‹å¦‚ï¼š7541721806923694188" style="width: 300px; padding: 8px; margin: 10px 0;">
                    <br>
                    <small>è·å–æ–¹æ³•ï¼šåœ¨é£ä¹¦é¡¹ç›®é¡µé¢æŒ‰F12ï¼Œåˆ‡æ¢åˆ°Networkæ ‡ç­¾ï¼ŒæŸ¥çœ‹ä»»æ„è¯·æ±‚çš„Headersä¸­çš„X-User-Key</small>
                    <br>
                    <button onclick="confirmUserKey()" style="margin-top: 10px;">ç¡®è®¤</button>
                `;

                btn.textContent = 'é‡æ–°è·å–';
                btn.disabled = false;

            } catch (error) {
                alert('è·å–é…ç½®å¤±è´¥ï¼š' + error.message);
                btn.textContent = 'é‡æ–°è·å–';
                btn.disabled = false;
            }
        }

        function confirmUserKey() {
            const input = document.getElementById('userKeyInput');
            userKey = input.value.trim();

            if (!userKey) {
                alert('è¯·è¾“å…¥User Key');
                return;
            }

            if (!/^\d+$/.test(userKey)) {
                alert('User Keyåº”è¯¥æ˜¯çº¯æ•°å­—ï¼Œè¯·æ£€æŸ¥');
                return;
            }

            document.getElementById('userKeyDisplay').innerHTML =
                `<div class="success">âœ… User Keyå·²ç¡®è®¤: ${userKey}</div>`;

            document.getElementById('configBtn').disabled = false;
        }

        async function startConfiguration() {
            if (!userKey || !pluginToken) {
                alert('è¯·å…ˆè·å–é…ç½®ä¿¡æ¯');
                return;
            }

            document.querySelector('.progress').style.display = 'block';
            document.getElementById('configBtn').disabled = true;

            const fields = [
                // Lead Time
                { key: "lead_time_created", name: "éœ€æ±‚åˆ›å»ºæ—¶é—´", type: "datetime" },
                { key: "lead_time_solution", name: "æ–¹æ¡ˆå®Œæˆæ—¶é—´", type: "datetime" },
                { key: "lead_time_review", name: "è¯„å®¡é€šè¿‡æ—¶é—´", type: "datetime" },
                { key: "lead_time_deployed", name: "ä¸Šçº¿æ—¶é—´", type: "datetime" },
                { key: "lead_time_days", name: "Lead Time(å¤©)", type: "number" },
                // è¯„å®¡é€šè¿‡ç‡
                { key: "review_result", name: "è¯„å®¡ç»“æœ", type: "select" },
                { key: "review_rounds", name: "è¯„å®¡è½®æ¬¡", type: "number" },
                // ååé‡
                { key: "parallel_tasks", name: "å¹¶è¡Œä»»åŠ¡æ•°", type: "number" },
                { key: "weekly_done", name: "å‘¨å®Œæˆæ•°", type: "number" },
                // PRDè¿”å·¥
                { key: "prd_version", name: "PRDç‰ˆæœ¬", type: "text" },
                { key: "prd_rework", name: "PRDè¿”å·¥æ¬¡æ•°", type: "number" },
                // è¯•ç‚¹åˆ°GA
                { key: "pilot_start", name: "è¯•ç‚¹å¼€å§‹", type: "datetime" },
                { key: "ga_release", name: "GAå‘å¸ƒ", type: "datetime" },
                { key: "iterations", name: "è¿­ä»£æ¬¡æ•°", type: "number" }
            ];

            let successCount = 0;

            for (let i = 0; i < fields.length; i++) {
                const field = fields[i];
                updateProgress(i + 1, fields.length, `æ­£åœ¨åˆ›å»º: ${field.name}`);

                const success = await createField(field);
                if (success) successCount++;

                await delay(500);
            }

            showResult(successCount, fields.length);
        }

        async function createField(field) {
            try {
                const response = await fetch('/open_api/' + PROJECT_KEY + '/field/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-PLUGIN-TOKEN': pluginToken,
                        'X-USER-KEY': userKey
                    },
                    body: JSON.stringify({
                        field_key: field.key,
                        field_name: field.name,
                        field_type: field.type,
                        work_item_type_key: 'requirement'
                    })
                });

                const data = await response.json();
                return data.err_code === 0 || data.code === 0;
            } catch (error) {
                console.error('åˆ›å»ºå­—æ®µå¤±è´¥:', field.name, error);
                return false;
            }
        }

        function updateProgress(current, total, text) {
            const percent = (current / total) * 100;
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressText').textContent = text + ` (${current}/${total})`;
        }

        function showResult(success, total) {
            const resultDiv = document.getElementById('result');
            resultDiv.style.display = 'block';

            if (success === total) {
                resultDiv.className = 'step success';
                resultDiv.innerHTML = `
                    <h3>ğŸ‰ é…ç½®æˆåŠŸï¼</h3>
                    <p>æ‰€æœ‰${total}ä¸ªå­—æ®µå·²æˆåŠŸåˆ›å»ºã€‚</p>
                    <p>æ‚¨ç°åœ¨å¯ä»¥åœ¨é£ä¹¦é¡¹ç›®ä¸­ä½¿ç”¨è¿™äº›è´¨é‡æŒ‡æ ‡äº†ã€‚</p>
                    <button onclick="window.open('${PLATFORM_URL}/${PROJECT_KEY}/setting/workObjectSetting', '_blank')">
                        æŸ¥çœ‹é…ç½®çš„å­—æ®µ
                    </button>
                `;
            } else if (success > 0) {
                resultDiv.className = 'step error';
                resultDiv.innerHTML = `
                    <h3>âš ï¸ éƒ¨åˆ†æˆåŠŸ</h3>
                    <p>æˆåŠŸåˆ›å»º ${success}/${total} ä¸ªå­—æ®µã€‚</p>
                    <p>éƒ¨åˆ†å­—æ®µå¯èƒ½å·²å­˜åœ¨æˆ–åˆ›å»ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥é£ä¹¦é¡¹ç›®è®¾ç½®ã€‚</p>
                `;
            } else {
                resultDiv.className = 'step error';
                resultDiv.innerHTML = `
                    <h3>âŒ é…ç½®å¤±è´¥</h3>
                    <p>æ— æ³•åˆ›å»ºå­—æ®µï¼Œå¯èƒ½çš„åŸå› ï¼š</p>
                    <ul>
                        <li>æƒé™ä¸è¶³</li>
                        <li>å­—æ®µå·²å­˜åœ¨</li>
                        <li>ç½‘ç»œé—®é¢˜</li>
                    </ul>
                    <p>è¯·æ£€æŸ¥æ§åˆ¶å°é”™è¯¯ä¿¡æ¯æˆ–è”ç³»ç®¡ç†å‘˜ã€‚</p>
                `;
            }
        }

        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
    </script>
</body>
</html>