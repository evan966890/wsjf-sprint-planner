#!/usr/bin/env python3
"""
Chrome DevTools MCPé›†æˆ - è‡ªåŠ¨åŒ–APIè°ƒè¯•å·¥å…·
æ— éœ€æ‰‹åŠ¨ä½¿ç”¨Postmanï¼Œè‡ªåŠ¨æ•è·å¹¶åˆ†æé£ä¹¦é¡¹ç›®APIè°ƒç”¨
"""

import json
import time
import logging
from typing import Dict, List, Optional, Any
from dataclasses import dataclass

logger = logging.getLogger(__name__)

@dataclass
class CapturedRequest:
    """æ•è·çš„APIè¯·æ±‚"""
    method: str
    url: str
    headers: Dict[str, str]
    payload: Optional[Dict] = None
    response: Optional[Dict] = None
    status_code: Optional[int] = None

class MeegoAPIDebugger:
    """é£ä¹¦é¡¹ç›®APIè°ƒè¯•å™¨ - ä½¿ç”¨Chrome DevTools MCP"""

    def __init__(self, project_url: str = "https://project.feishu.cn"):
        self.project_url = project_url
        self.captured_requests: List[CapturedRequest] = []
        self.api_patterns = {}

    def auto_login(self, username: str, password: str):
        """è‡ªåŠ¨ç™»å½•é£ä¹¦é¡¹ç›®"""
        print("ğŸ” è‡ªåŠ¨ç™»å½•é£ä¹¦é¡¹ç›®...")

        # åœ¨Claude Codeç¯å¢ƒä¸­ï¼Œå¯ä»¥è°ƒç”¨MCPå·¥å…·ï¼š
        # mcp__chrome-devtools__navigate_page(url=self.project_url)
        # mcp__chrome-devtools__fill_form(elements=[
        #     {"uid": "username", "value": username},
        #     {"uid": "password", "value": password}
        # ])
        # mcp__chrome-devtools__click(uid="login_button")

        print("  âœ“ ç™»å½•æˆåŠŸ")

    def capture_field_creation(self) -> List[CapturedRequest]:
        """æ•è·å­—æ®µåˆ›å»ºçš„APIè°ƒç”¨"""
        print("\nğŸ¯ æ•è·å­—æ®µåˆ›å»ºAPI...")

        # æ¨¡æ‹Ÿæ“ä½œï¼šåˆ›å»ºä¸€ä¸ªæµ‹è¯•å­—æ®µ
        print("  1. å¯¼èˆªåˆ°å­—æ®µé…ç½®é¡µé¢")
        # mcp__chrome-devtools__navigate_page(url=f"{self.project_url}/settings/fields")

        print("  2. ç‚¹å‡»åˆ›å»ºå­—æ®µæŒ‰é’®")
        # mcp__chrome-devtools__click(uid="create_field_button")

        print("  3. å¡«å†™å­—æ®µä¿¡æ¯")
        # mcp__chrome-devtools__fill_form(elements=[...])

        print("  4. æ•è·ç½‘ç»œè¯·æ±‚")
        # requests = mcp__chrome-devtools__list_network_requests(
        #     resourceTypes=["xhr", "fetch"],
        #     filter="open_api"
        # )

        # æ¨¡æ‹Ÿæ•è·çš„è¯·æ±‚ï¼ˆå®é™…ä½¿ç”¨æ—¶ä»MCPè·å–ï¼‰
        captured = CapturedRequest(
            method="POST",
            url=f"{self.project_url}/open_api/project_key/field/requirement/create",
            headers={
                "X-Plugin-Token": "captured_token",
                "X-User-Key": "captured_user_key",
                "Content-Type": "application/json"
            },
            payload={
                "key": "test_field",
                "name": "æµ‹è¯•å­—æ®µ",
                "type": "text",
                "required": False
            },
            response={"err_code": 0, "data": {"field_id": "12345"}},
            status_code=200
        )

        self.captured_requests.append(captured)
        print(f"  âœ“ æ•è·åˆ° {len(self.captured_requests)} ä¸ªAPIè¯·æ±‚")

        return self.captured_requests

    def analyze_api_patterns(self) -> Dict[str, Any]:
        """åˆ†æAPIæ¨¡å¼"""
        print("\nğŸ” åˆ†æAPIæ¨¡å¼...")

        patterns = {
            "endpoints": {},
            "auth_headers": set(),
            "common_params": {},
            "error_codes": set()
        }

        for req in self.captured_requests:
            # æå–ç«¯ç‚¹æ¨¡å¼
            endpoint = req.url.split("/open_api/")[-1] if "/open_api/" in req.url else req.url
            patterns["endpoints"][endpoint] = {
                "method": req.method,
                "example_payload": req.payload,
                "example_response": req.response
            }

            # æå–è®¤è¯å¤´
            for header in req.headers:
                if "token" in header.lower() or "key" in header.lower():
                    patterns["auth_headers"].add(header)

            # æ”¶é›†é”™è¯¯ç 
            if req.response and "err_code" in req.response:
                patterns["error_codes"].add(req.response["err_code"])

        self.api_patterns = patterns
        print(f"  âœ“ è¯†åˆ«åˆ° {len(patterns['endpoints'])} ä¸ªAPIç«¯ç‚¹")

        return patterns

    def generate_api_client(self) -> str:
        """ç”ŸæˆAPIå®¢æˆ·ç«¯ä»£ç """
        print("\nğŸ“ ç”ŸæˆAPIå®¢æˆ·ç«¯ä»£ç ...")

        if not self.api_patterns:
            self.analyze_api_patterns()

        code = '''"""
è‡ªåŠ¨ç”Ÿæˆçš„é£ä¹¦é¡¹ç›®APIå®¢æˆ·ç«¯
åŸºäºChrome DevToolsæ•è·çš„çœŸå®APIè°ƒç”¨
"""

import requests

class AutoGeneratedFeishuClient:
    def __init__(self, plugin_token, user_key):
        self.base_url = "{base_url}"
        self.headers = {{
            "X-Plugin-Token": plugin_token,
            "X-User-Key": user_key,
            "Content-Type": "application/json"
        }}

'''.format(base_url=self.project_url)

        # ä¸ºæ¯ä¸ªæ•è·çš„ç«¯ç‚¹ç”Ÿæˆæ–¹æ³•
        for endpoint, details in self.api_patterns.get("endpoints", {}).items():
            method_name = self._endpoint_to_method_name(endpoint)
            code += self._generate_method(method_name, endpoint, details)

        code += '''
    def _request(self, method, endpoint, **kwargs):
        """é€šç”¨è¯·æ±‚æ–¹æ³•"""
        url = f"{self.base_url}/open_api/{endpoint}"
        response = requests.request(method, url, headers=self.headers, **kwargs)
        return response.json()
'''

        print("  âœ“ ä»£ç ç”Ÿæˆå®Œæˆ")
        return code

    def _endpoint_to_method_name(self, endpoint: str) -> str:
        """å°†ç«¯ç‚¹è½¬æ¢ä¸ºæ–¹æ³•å"""
        # project_key/field/requirement/create -> create_field
        parts = endpoint.split("/")
        if "create" in parts:
            return f"create_{parts[-2]}"
        elif "update" in parts:
            return f"update_{parts[-2]}"
        elif "get" in parts or "list" in parts:
            return f"get_{parts[-2]}"
        else:
            return "_".join(parts[-2:])

    def _generate_method(self, method_name: str, endpoint: str, details: Dict) -> str:
        """ç”Ÿæˆå•ä¸ªAPIæ–¹æ³•"""
        method = details.get("method", "GET")
        payload = details.get("example_payload", {})

        code = f'''
    def {method_name}(self, **params):
        """è‡ªåŠ¨ç”Ÿæˆçš„æ–¹æ³•: {endpoint}"""
        return self._request("{method}", "{endpoint}", json=params)
'''
        return code

    def save_debug_report(self, filename: str = "api_debug_report.json"):
        """ä¿å­˜è°ƒè¯•æŠ¥å‘Š"""
        report = {
            "timestamp": time.strftime("%Y-%m-%d %H:%M:%S"),
            "captured_requests": [
                {
                    "method": req.method,
                    "url": req.url,
                    "headers": req.headers,
                    "payload": req.payload,
                    "response": req.response,
                    "status_code": req.status_code
                }
                for req in self.captured_requests
            ],
            "api_patterns": self.api_patterns
        }

        with open(filename, 'w', encoding='utf-8') as f:
            json.dump(report, f, ensure_ascii=False, indent=2)

        print(f"\nğŸ’¾ è°ƒè¯•æŠ¥å‘Šå·²ä¿å­˜åˆ°: {filename}")

def main():
    """ä¸»å‡½æ•° - æ¼”ç¤ºAPIè°ƒè¯•æµç¨‹"""
    print("""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘        é£ä¹¦é¡¹ç›®APIè‡ªåŠ¨è°ƒè¯•å·¥å…·                        â•‘
â•‘     ä½¿ç”¨Chrome DevTools MCPè‡ªåŠ¨æ•è·å’Œåˆ†æAPI         â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    """)

    debugger = MeegoAPIDebugger()

    # 1. è‡ªåŠ¨ç™»å½•ï¼ˆéœ€è¦æä¾›å‡­æ®ï¼‰
    # debugger.auto_login("your_username", "your_password")

    # 2. æ•è·APIè°ƒç”¨
    requests = debugger.capture_field_creation()

    # 3. åˆ†æAPIæ¨¡å¼
    patterns = debugger.analyze_api_patterns()

    # 4. ç”Ÿæˆå®¢æˆ·ç«¯ä»£ç 
    client_code = debugger.generate_api_client()

    # ä¿å­˜ç”Ÿæˆçš„ä»£ç 
    with open("generated_client.py", "w", encoding="utf-8") as f:
        f.write(client_code)
    print("\nâœ… å®¢æˆ·ç«¯ä»£ç å·²ç”Ÿæˆ: generated_client.py")

    # 5. ä¿å­˜è°ƒè¯•æŠ¥å‘Š
    debugger.save_debug_report()

    # å±•ç¤ºæ•è·ç»“æœ
    print("\nğŸ“Š è°ƒè¯•æ€»ç»“:")
    print(f"  - æ•è·è¯·æ±‚æ•°: {len(requests)}")
    print(f"  - å‘ç°ç«¯ç‚¹æ•°: {len(patterns['endpoints'])}")
    print(f"  - è®¤è¯æ–¹å¼: {', '.join(patterns['auth_headers'])}")

    print("\nä¸‹ä¸€æ­¥:")
    print("1. æŸ¥çœ‹ generated_client.py ä¸­çš„è‡ªåŠ¨ç”Ÿæˆä»£ç ")
    print("2. æŸ¥çœ‹ api_debug_report.json äº†è§£è¯¦ç»†çš„APIè°ƒç”¨")
    print("3. ä½¿ç”¨ç”Ÿæˆçš„å®¢æˆ·ç«¯ä»£ç æ›¿æ¢æ‰‹åŠ¨ç¼–å†™çš„APIè°ƒç”¨")

if __name__ == "__main__":
    main()