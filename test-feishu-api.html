<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>é£ä¹¦é¡¹ç›®APIæµ‹è¯•å·¥å…·</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1200px;
      margin: 20px auto;
      padding: 20px;
    }
    .section {
      background: #f5f5f5;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
    }
    input, textarea, select {
      width: 100%;
      padding: 8px;
      margin: 5px 0;
      box-sizing: border-box;
      font-family: monospace;
    }
    button {
      background: #4CAF50;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin: 5px;
    }
    button:hover {
      background: #45a049;
    }
    .result {
      background: #fff;
      border: 1px solid #ddd;
      padding: 15px;
      margin: 10px 0;
      border-radius: 4px;
      font-family: monospace;
      white-space: pre-wrap;
      max-height: 400px;
      overflow: auto;
    }
    .success { border-color: #4CAF50; background: #e8f5e9; }
    .error { border-color: #f44336; background: #ffebee; }
    .info { border-color: #2196F3; background: #e3f2fd; }
  </style>
</head>
<body>
  <h1>ğŸ” é£ä¹¦é¡¹ç›®APIæµ‹è¯•å·¥å…·</h1>

  <div class="section">
    <h2>é…ç½®</h2>
    <label>Plugin Token:</label>
    <input type="text" id="token" value="p-b0998e9d-a248-4bd2-bc90-302268b25136" placeholder="p-xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx">

    <label>Platform Domain:</label>
    <input type="text" id="domain" value="https://project.f.mioffice.cn" placeholder="https://project.f.mioffice.cn">
  </div>

  <div class="section">
    <h2>å°è¯•ä¸åŒçš„APIç«¯ç‚¹</h2>
    <label>é€‰æ‹©æˆ–è¾“å…¥APIç«¯ç‚¹:</label>
    <select id="endpoint-select" onchange="document.getElementById('endpoint').value = this.value">
      <option value="/api/projects/list">GET /api/projects/list</option>
      <option value="/api/projects">GET /api/projects</option>
      <option value="/open_api/projects/list">GET /open_api/projects/list</option>
      <option value="/open_api/projects">GET /open_api/projects</option>
      <option value="/project/v1/project">GET /project/v1/project (å½“å‰ä»£ç ä½¿ç”¨)</option>
      <option value="/open-apis/project/v1/project">GET /open-apis/project/v1/project</option>
      <option value="custom">è‡ªå®šä¹‰...</option>
    </select>

    <label>APIç«¯ç‚¹è·¯å¾„:</label>
    <input type="text" id="endpoint" value="/api/projects/list" placeholder="/api/projects/list">

    <label>User Key (å¯é€‰ï¼ŒæŸäº›ç«¯ç‚¹å¯èƒ½éœ€è¦):</label>
    <input type="text" id="userKey" value="" placeholder="æ‚¨çš„ç”¨æˆ·æ ‡è¯†">

    <button onclick="testAPI()">ğŸš€ æµ‹è¯•API</button>
    <button onclick="clearResults()">ğŸ—‘ï¸ æ¸…ç©ºç»“æœ</button>
  </div>

  <div class="section">
    <h2>æµ‹è¯•ç»“æœ</h2>
    <div id="results"></div>
  </div>

  <script>
    function addResult(message, type = 'info') {
      const div = document.createElement('div');
      div.className = `result ${type}`;
      div.textContent = message;
      document.getElementById('results').insertBefore(div, document.getElementById('results').firstChild);
    }

    function clearResults() {
      document.getElementById('results').innerHTML = '';
    }

    async function testAPI() {
      const token = document.getElementById('token').value;
      const domain = document.getElementById('domain').value;
      const endpoint = document.getElementById('endpoint').value;
      const userKey = document.getElementById('userKey').value;

      if (!token) {
        addResult('âŒ è¯·å¡«å†™Plugin Token', 'error');
        return;
      }

      const url = `${domain}${endpoint}`;

      addResult(`ğŸ”„ æ­£åœ¨æµ‹è¯•: ${url}`, 'info');

      try {
        const headers = {
          'Content-Type': 'application/json',
          'X-Plugin-Token': token,
        };

        if (userKey) {
          headers['X-User-Key'] = userKey;
        }

        addResult(`ğŸ“¤ è¯·æ±‚å¤´:\n${JSON.stringify(headers, null, 2)}`, 'info');

        const response = await fetch(url, {
          method: 'GET',
          headers: headers,
        });

        addResult(`ğŸ“¥ HTTPçŠ¶æ€: ${response.status} ${response.statusText}`,
                  response.ok ? 'success' : 'error');

        const responseHeaders = {};
        response.headers.forEach((value, key) => {
          responseHeaders[key] = value;
        });
        addResult(`ğŸ“¥ å“åº”å¤´:\n${JSON.stringify(responseHeaders, null, 2)}`, 'info');

        const text = await response.text();

        // å°è¯•è§£æJSON
        try {
          const json = JSON.parse(text);
          addResult(`âœ… JSONå“åº”:\n${JSON.stringify(json, null, 2)}`, 'success');

          // å¦‚æœæœ‰é¡¹ç›®åˆ—è¡¨ï¼Œæ˜¾ç¤º
          if (json.data && Array.isArray(json.data.items)) {
            addResult(`ğŸ‰ æ‰¾åˆ° ${json.data.items.length} ä¸ªé¡¹ç›®ï¼`, 'success');
            addResult(`âœ…âœ…âœ… æˆåŠŸï¼è¯·ä½¿ç”¨æ­¤ç«¯ç‚¹ï¼š${endpoint}`, 'success');
          } else if (json.data) {
            addResult(`ğŸ“Š è¿”å›æ•°æ®ï¼š\n${JSON.stringify(json.data, null, 2).substring(0, 500)}`, 'success');
          }
        } catch (e) {
          // ä¸æ˜¯JSONï¼Œå¯èƒ½æ˜¯HTML
          if (text.includes('<!doctype html>') || text.includes('<html>')) {
            addResult(`âŒ è¿”å›çš„æ˜¯HTMLé¡µé¢ï¼Œä¸æ˜¯API\nå‰200å­—ç¬¦:\n${text.substring(0, 200)}`, 'error');
          } else {
            addResult(`âŒ éJSONå“åº”:\n${text.substring(0, 500)}`, 'error');
          }
        }
      } catch (error) {
        addResult(`âŒ è¯·æ±‚å¤±è´¥: ${error.message}\nå®Œæ•´é”™è¯¯: ${error.stack}`, 'error');

        if (error.message.includes('Failed to fetch')) {
          addResult(`ğŸ’¡ æç¤º: "Failed to fetch" é€šå¸¸è¡¨ç¤ºCORSè·¨åŸŸé—®é¢˜æˆ–ç½‘ç»œé”™è¯¯`, 'info');
        }
      }
    }

    // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºè¯´æ˜
    window.onload = function() {
      addResult(`
ğŸ“– ä½¿ç”¨è¯´æ˜ï¼š

1. ç¡®ä¿æ‚¨å·²ç»è·å–äº†æœ‰æ•ˆçš„Plugin Tokenï¼ˆè¿è¡Œ get-project-token.ps1ï¼‰
2. é€‰æ‹©æˆ–è¾“å…¥è¦æµ‹è¯•çš„APIç«¯ç‚¹
3. ç‚¹å‡»"æµ‹è¯•API"æŒ‰é’®
4. æŸ¥çœ‹è¿”å›ç»“æœï¼š
   - âœ… ç»¿è‰² = æˆåŠŸï¼æ‰¾åˆ°æ­£ç¡®çš„ç«¯ç‚¹
   - âŒ çº¢è‰² = å¤±è´¥ï¼Œå°è¯•å…¶ä»–ç«¯ç‚¹

âš ï¸ æ³¨æ„ï¼š
- è¿™ä¸ªé¡µé¢éœ€è¦åœ¨é£ä¹¦é¡¹ç›®å¹³å°çš„åŸŸåä¸‹è¿è¡Œæ‰èƒ½é¿å…CORSé—®é¢˜
- æˆ–è€…ä½¿ç”¨æµè§ˆå™¨æ‰©å±•ï¼ˆå¦‚CORS Unblockï¼‰æš‚æ—¶ç¦ç”¨CORSæ£€æŸ¥
- æœ€å¥½çš„æ–¹æ³•æ˜¯ç›´æ¥åœ¨é£ä¹¦é¡¹ç›®å¹³å°ä¸­æŒ‰F12æŸ¥çœ‹Networkæ ‡ç­¾çš„çœŸå®APIè°ƒç”¨
      `, 'info');
    };
  </script>
</body>
</html>
