# 🧪 导入功能修复测试指南

## 📋 已修复的问题

### ✅ 问题1：导入后没有看到新需求
**修复内容**：
- 修复了 `useDataExport.ts` 中的状态更新逻辑
- 直接使用新导入的 `requirements` 筛选待排期需求
- 修改了 `wsjf-sprint-planner.tsx` 中的 Hook 调用

### ✅ 问题2：编辑过的Excel导入报错
**修复内容**：
- 增强了 `safeJSONParse` 函数，支持对象类型
- 添加了数据类型自动修复（数字、布尔值）
- 增强了错误提示信息
- 添加了编辑警告提示

---

## 🧪 测试步骤

### 测试1：基础导入（验证问题1修复）

**目标**：验证导入后能看到新需求

**步骤**：
1. 启动开发服务器：`npm run dev`
2. 打开浏览器：http://localhost:3000
3. 添加一些测试需求（至少3个）
4. 点击绿色"新导出"按钮
5. 选择"数据模式" → "Excel (.xlsx)"
6. 点击"导出"，下载文件
7. **清空所有数据**（在浏览器中删除需求或刷新）
8. 点击"导入数据"按钮
9. 选择刚才导出的文件
10. 验证：看到预览数据（总需求数、待排期需求数）
11. 选择"替换模式"
12. 点击"确认导入"

**预期结果**：
- ✅ 导入成功提示
- ✅ **待排期区域显示所有导入的需求**（之前是空的，现在应该有数据）
- ✅ 需求数量正确
- ✅ 需求详情完整

---

### 测试2：编辑简单字段后导入（验证问题2修复）

**目标**：验证编辑后的Excel能正常导入

**步骤**：
1. 导出数据（数据模式 Excel）
2. 用 Excel 打开导出的文件
3. 切换到"需求数据"Sheet
4. 编辑以下字段：
   - 修改需求名称：改为 "测试需求（已编辑）"
   - 修改工作量：从 `5` 改为 **文本格式的** `"10"`
   - 修改业务影响度：从 `8` 改为 **文本格式的** `"9"`
   - 修改强制DDL：从 `否` 改为 `"是"`
5. 保存Excel文件
6. 在应用中点击"导入数据"
7. 选择编辑后的文件
8. 验证预览数据
9. 点击"确认导入"

**预期结果**：
- ✅ 导入成功（之前会报错）
- ✅ 需求名称已更新
- ✅ 工作量自动转换为数字 `10`
- ✅ 业务影响度自动转换为数字 `9`
- ✅ 强制DDL自动转换为布尔值 `true`

---

### 测试3：Excel自动解析对象（验证问题2修复）

**目标**：验证xlsx库自动解析的对象能正常处理

**步骤**：
1. 导出数据（数据模式 Excel）
2. 直接导入（不编辑）
3. 多次重复导入（xlsx库可能将JSON字段解析为对象）

**预期结果**：
- ✅ 每次导入都成功
- ✅ 复杂字段（affectedMetrics、impactScope）不丢失
- ✅ 控制台无警告或错误

---

### 测试4：格式错误的容错处理

**目标**：验证系统对格式错误的容错能力

**步骤**：
1. 导出数据（数据模式 Excel）
2. 用 Excel 打开
3. **故意破坏格式**：
   - 将 `affectedMetrics` 列改为普通文本：`"GMV, 订单量"`（不是JSON）
   - 将 `effortDays` 列改为文本：`"abc"`（无法转换为数字）
4. 保存并导入

**预期结果**：
- ✅ 导入成功（不会崩溃）
- ✅ `affectedMetrics` 被置空（返回默认值 `[]`）
- ✅ `effortDays` 被转换为 `0`（默认值）
- ✅ 控制台有警告信息（JSON parse failed）
- ✅ 需求仍然可以正常显示

---

### 测试5：查看警告提示

**目标**：验证新增的警告提示是否显示

**步骤**：
1. 点击"导入数据"按钮
2. 查看对话框中的警告信息

**预期结果**：
- ✅ 看到黄色警告框："⚠️ 编辑导出文件的注意事项"
- ✅ 包含5条编辑建议
- ✅ 蓝色提示框更新，新增"系统会自动修复常见的格式问题"

---

## 📊 测试结果记录

### 问题1：导入后看不到新需求

| 测试项 | 修复前 | 修复后 | 状态 |
|--------|--------|--------|------|
| 导入后待排期区域有数据 | ❌ 空的 | ✅ 显示所有需求 | ⬜ 待测试 |
| 需求数量正确 | ❌ 0个 | ✅ 正确数量 | ⬜ 待测试 |
| 需求详情完整 | ❌ - | ✅ 完整显示 | ⬜ 待测试 |

### 问题2：编辑后的Excel导入报错

| 测试项 | 修复前 | 修复后 | 状态 |
|--------|--------|--------|------|
| 编辑简单字段后导入 | ❌ 报错 | ✅ 成功 | ⬜ 待测试 |
| 数字字段文本格式 | ❌ 类型错误 | ✅ 自动转换 | ⬜ 待测试 |
| 布尔字段文本格式 | ❌ 类型错误 | ✅ 自动转换 | ⬜ 待测试 |
| JSON字段格式错误 | ❌ 数据丢失 | ✅ 容错处理 | ⬜ 待测试 |
| xlsx自动解析对象 | ❌ 数据丢失 | ✅ 正确处理 | ⬜ 待测试 |

---

## 🐛 如果测试失败

### 问题：导入后还是看不到新需求

**排查步骤**：
1. 打开浏览器开发者工具（F12）
2. 切换到 Console 标签页
3. 执行导入操作
4. 查看是否有错误信息
5. 检查 `localStorage` 中的数据（Application → Local Storage）

**可能原因**：
- 浏览器缓存未清除：强制刷新（Ctrl + Shift + R）
- LocalStorage 被禁用
- 导入的文件格式不正确

### 问题：编辑后的Excel还是报错

**排查步骤**：
1. 查看控制台的具体错误信息
2. 检查Excel文件中哪个Sheet或字段有问题
3. 截图错误提示并反馈

**可能原因**：
- 删除或重命名了Sheet名称
- 删除了必需字段（id、name）
- Excel版本兼容性问题

---

## ✅ 测试通过标准

两个问题都算修复成功的标准：

### 问题1修复标准
- [x] 导入后，待排期区域显示所有新需求
- [x] 需求数量与导出时一致
- [x] 需求详情完整，无数据丢失
- [x] 多次导入都正常工作

### 问题2修复标准
- [x] 编辑简单字段后能成功导入
- [x] 数字字段的文本格式自动转换
- [x] 布尔字段的文本格式自动转换
- [x] JSON字段格式错误时容错处理（不崩溃）
- [x] xlsx库自动解析的对象能正确处理
- [x] 警告提示正确显示

---

## 📝 测试报告模板

测试完成后，请填写：

**测试环境**：
- 浏览器：Chrome / Firefox / Safari / Edge
- 操作系统：Windows / Mac / Linux
- Node.js 版本：

**测试结果**：
- 问题1（导入后看不到新需求）：✅ 已修复 / ❌ 仍有问题
- 问题2（编辑后的Excel导入报错）：✅ 已修复 / ❌ 仍有问题

**问题描述**（如果测试失败）：


**截图/日志**：


---

**测试时间**：预计 10-15 分钟
**优先级**：🔴 高（核心功能修复）
